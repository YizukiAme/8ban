<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…«è´¤æ¸¡ Â· æ•¬ä¸šèˆŸ</title>
    <link href="./output.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="./js/marked.min.js"></script>
    <script src="./js/masonry.pkgd.min.js"></script>
    <script src="./js/imagesloaded.pkgd.min.js"></script>
    
    <!-- èµ„æºé¢„è¿æ¥ï¼Œæé«˜åŠ è½½é€Ÿåº¦ -->
    <link rel="preconnect" href="https://8ban-1311723413.cos.ap-shanghai.myqcloud.com">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://ipinfo.io">
    <link rel="preconnect" href="https://api.jsonbin.io">
    <link rel="preconnect" href="https://api.siliconflow.cn">
    <link rel="preconnect" href="https://your-vercel-domain.vercel.app"> 

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Noto Sans SC', sans-serif;
            color: #2d3748;
            scroll-behavior: smooth; 
            background-color: #1a202c;
        }

        #main-content-wrapper {
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            position: relative;
            z-index: 1;
            background-color: transparent;
        }

        .glassmorphism {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        .card-hover {
            transition: all 0.3s ease;
        }
        /* æ‚¬åœæ•ˆæœï¼šå¾®å¾®æ‚¬æµ®æ”¾å¤§ */
        .card-hover:hover {
            transform: translateY(-5px) scale(1.02); /* ç»“åˆæ‚¬æµ®å’Œæ”¾å¤§ */
            box-shadow: 0 12px 28px 0 rgba(31, 38, 135, 0.2);
        }
        .enhanced-card-hover {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .enhanced-card-hover:hover {
            transform: scale(1.03) translateY(-3px);
            box-shadow: 0 15px 30px -5px rgba(59, 130, 246, 0.25), 0 8px 10px -6px rgba(59, 130, 246, 0.2);
        }

        .highlight-text {
            position: relative;
            display: inline-block;
        }
        .highlight-text::after {
            content: none;
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 10px;
            background-color: rgba(99, 102, 241, 0.2);
            z-index: -1;
        }

        .mobile-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            padding: 1rem;
            margin: 0.5rem;
            border-radius: 0.75rem;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            transform-origin: top;
            transform: scaleY(0);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            z-index: 100;
        }
        .mobile-menu.active {
            transform: scaleY(1);
            opacity: 1;
        }

        .tools-grid-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.7s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.5s ease-out, transform 0.5s ease-out;
            opacity: 0;
            transform: translateY(20px);
        }
        .tools-grid-container.active {
            max-height: 2000px;
            opacity: 1;
            transform: translateY(0);
        }

        .chat-bubble {
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            margin-bottom: 0.5rem;
            max-width: 75%;
            word-wrap: break-word;
        }
        .chat-bubble-user {
            background-color: #3b82f6;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
        }
        .chat-bubble-ai {
            background-color: #e5e7eb;
            color: #1f2937;
            margin-right: auto;
            border-bottom-left-radius: 0.25rem;
        }
        .chat-bubble-ai p:first-child { margin-top: 0; }
        .chat-bubble-ai p:last-child { margin-bottom: 0; }
        .chat-bubble-ai pre {
            background-color: #2d3748;
            color: #e2e8f0;
            padding: 0.75rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }
        .chat-bubble-ai code {
            background-color: #cbd5e0;
            padding: 0.2em 0.4em;
            border-radius: 0.25rem;
            font-size: 0.875em;
        }
        .chat-bubble-ai ul, .chat-bubble-ai ol {
            margin-left: 1.25rem;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            list-style-type: disc;
        }
        .chat-bubble-ai ol {
            list-style-type: decimal;
        }
        #chatMessages {
            scroll-behavior: smooth;
        }

        @keyframes moveRight {
            0% { transform: translateX(-100%); opacity: 1;}
            90% { opacity: 1; }
            100% { transform: translateX(100vw); opacity: 0; }
        }
        .danmaku-item {
            position: absolute;
            white-space: nowrap;
            font-weight: 500;
            padding: 5px 10px;
            border-radius: 5px;
            background-color: rgba(0,0,0,0.1);
        }

        .timeline-dot {
            width: 12px;
            height: 12px;
            background-color: #60a5fa;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 3px #60a5fa;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(8px);
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .modal.open {
            display: flex;
            opacity: 1;
        }
        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative;
            width: 90%;
            max-width: 1500px;
            height: 90%;
            max-height: 1200px;
            display: flex;
            flex-direction: column;
            transform: translateY(20px);
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .modal.open .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            color: #aaa;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        .modal-close:hover,
        .modal-close:focus {
            color: #333;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 1rem;
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            background-color: #f8fafc;
        }
        .modal-chat-input-area {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding-top: 0.5rem;
        }

        .danmaku-record-item {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }
        .danmaku-record-item p {
            margin: 0;
            line-height: 1.4;
        }
        .danmaku-record-item .info {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.5rem;
            text-align: right;
        }

        #fixed-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            filter: brightness(0.6) saturate(1.2);
            transition: background-image 0.5s ease-in-out;
            background-color: #1a202c;
            
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            transform: translateZ(0);
            will-change: transform;
            -webkit-perspective: 1000;
            perspective: 1000;
            -webkit-transform-style: preserve-3d;
            transform-style: preserve-3d;
        }

        #hero-section {
            position: relative;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
            overflow: hidden;
        }
        
        #hero-content {
            z-index: 10;
            padding: 1rem;
            max-width: 900px;
            margin: 0 auto;
            text-shadow: 0 2px 8px rgba(0,0,0,0.4);
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInSlideUp 1.2s ease-out forwards 0.5s;
        }

        @keyframes fadeInSlideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #hero-section h1 {
            font-size: 4.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            line-height: 1.2;
            color: white;
            text-align: center;
            text-shadow: 0 4px 12px rgba(0,0,0,0.6), 0 0 20px rgba(0,0,0,0.3);
            opacity: 0.8;
        }

        #hero-section p {
            font-size: 1.5rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 2rem;
            text-align: center;
        }

        .scroll-down-arrow {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 2rem;
            animation: bounce 2s infinite;
            cursor: pointer;
            z-index: 10;
            text-shadow: 0 2px 8px rgba(0,0,0,0.4);
            opacity: 0;
            animation: fadeInBounce 2s infinite forwards 1.5s;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateX(-50%) translateY(0);
            }
            40% {
                transform: translateX(-50%) translateY(-10px);
            }
            60% {
                transform: translateX(-50%) translateY(-5px);
            }
        }
        @keyframes fadeInBounce {
            0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
            50% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 1; }
        }

        .nav-initial {
            background: transparent !important;
            backdrop-filter: none !important;
            box-shadow: none !important;
            transition: all 0.5s ease-out, opacity 0.5s ease-out;
            margin-bottom: 0 !important;
            opacity: 0;
            pointer-events: none;
        }

        .nav-scrolled {
            background: rgba(255, 255, 255, 0.7) !important;
            backdrop-filter: blur(10px) !important;
            border-radius: 16px !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15) !important;
            transition: all 0.5s ease-out, opacity 0.5s ease-out;
            margin-bottom: 0 !important;
            opacity: 1 !important;
            pointer-events: auto !important;
        }

        .content-section {
            opacity: 0;
            transform: translateY(50px);
            transition: opacity 0.8s ease-out, transform 0.8s ease-out;
        }
        .content-section.fade-in {
            opacity: 1;
            transform: translateY(0);
        }

        #hero-content a.bg-blue-500,
        #hero-content a.bg-indigo-500,
        #hero-content a.bg-purple-500,
        #hero-content a.bg-green-500,
        #hero-content a.bg-orange-500 {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 16px 0 rgba(31, 38, 135, 0.1);
            color: white;
            transition: all 0.3s ease;
        }

        #hero-content a.bg-blue-500:hover,
        #hero-content a.bg-indigo-500:hover,
        #hero-content a.bg-purple-500:hover,
        #hero-content a.bg-green-500:hover,
        #hero-content a.bg-orange-500:hover {
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 24px 0 rgba(31, 38, 135, 0.2);
            transform: translateY(-3px);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .classmate-card {
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .classmate-card .avatar {
            width: 80px;
            height: 80px;
            background-color: #6366f1;
            color: white;
            font-size: 2.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 9999px;
            margin-bottom: 0.5rem;
            flex-shrink: 0;
            user-select: none;
        }
        .classmate-detail-content {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 15px 40px rgba(0,0,0,0.25);
            width: 90%;
            max-width: 600px;
            position: relative;
            display: flex;
            flex-direction: column;
            animation: fadeInScale 0.3s ease-out;
        }
        .classmate-detail-content .avatar-large {
            width: 120px;
            height: 120px;
            background-color: #6366f1;
            color: white;
            font-size: 3.5rem;
            font-weight: bold;
            border-radius: 9999px;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }
        .classmate-detail-content h3 {
            font-size: 2.25rem;
            font-weight: bold;
            color: #1f2937;
            text-align: center;
            margin-bottom: 0.75rem;
        }
        .classmate-detail-content p {
            color: #4b5563;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        .classmate-detail-content p strong {
            color: #1f2937;
        }
        .classmate-detail-content .quote {
            font-style: italic;
            border-left: 4px solid #a78bfa;
            padding-left: 1rem;
            margin-top: 1.5rem;
            color: #6b7280;
            font-size: 0.95rem;
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal.open .classmate-detail-content {
            animation: fadeInScale 0.3s ease-out forwards;
        }

        #loading-overlay {
            transition: opacity 0.5s ease-out;
        }
        #loading-overlay.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        /* Masonry ç€‘å¸ƒæµå¸ƒå±€ç›¸å…³æ ·å¼ */
        #photo-gallery-grid {
            margin-bottom: 1rem;
        }

        .grid-sizer, .grid-item {
            width: calc(20% - 10px); /* 5åˆ—ï¼Œ10px é—´è· */
            margin-bottom: 10px; /* å‚ç›´é—´è· */
            box-sizing: border-box;
        }

        /* å“åº”å¼è°ƒæ•´åˆ—æ•° */
        @media (max-width: 1023px) { /* lg breakpoint */
            .grid-sizer, .grid-item {
                width: calc(33.333% - 10px); /* 3åˆ— */
            }
        }
        @media (max-width: 639px) { /* sm breakpoint */
            .grid-sizer, .grid-item {
                width: calc(50% - 10px); /* 2åˆ— */
            }
        }
        @media (max-width: 480px) { /* Extra small screens */
            .grid-sizer, .grid-item {
                width: calc(100% - 10px); /* 1åˆ— */
            }
        }

        .grid-item {
            background-color: #e2e8f0; /* å ä½ç¬¦èƒŒæ™¯è‰² (gray-200) */
            border-radius: 0.5rem;
            overflow: hidden; /* ç¡®ä¿å›¾ç‰‡åœ†è§’å’Œé˜´å½±æ•ˆæœæ­£ç¡® */
            position: relative;
            /* åˆå§‹çŠ¶æ€ï¼šé€æ˜å¹¶ç•¥å¾®å‘ä¸‹ï¼Œç”¨äº Masonry å¸ƒå±€åçš„æ¸å…¥åŠ¨ç”» */
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        /* Masonry å¸ƒå±€å®Œæˆåè§¦å‘çš„åŠ¨ç”» */
        .grid-item.masonry-fade-in {
            opacity: 1;
            transform: translateY(0);
        }

        .grid-item img {
            display: block;
            width: 100%;
            height: auto;
            border-radius: 0.5rem;
            opacity: 0; /* å›¾ç‰‡åˆå§‹éšè— */
            transition: opacity 0.5s ease-in-out; /* å›¾ç‰‡æ¸å…¥åŠ¨ç”» */
            cursor: pointer; /* æŒ‡ç¤ºå¯ç‚¹å‡» */
        }

        /* å›¾ç‰‡åŠ è½½å®Œæˆåæ˜¾ç¤º */
        .grid-item img.loaded {
            opacity: 1;
        }

        /* Lightbox æ¨¡æ€æ¡†æ ·å¼ */
        .image-modal-overlay {
            display: none; /* åˆå§‹éšè— */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8); /* åŠé€æ˜é»‘è‰²èƒŒæ™¯ */
            backdrop-filter: blur(10px); /* æ¨¡ç³Šæ•ˆæœ */
            z-index: 1000; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, backdrop-filter 0.3s ease-in-out;
        }

        .image-modal-overlay.open {
            display: flex;
            opacity: 1;
        }

        .image-modal-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
            display: flex;
            justify-content: center;
            align-items: center;
            transform: scale(0.8); /* åˆå§‹ç¼©å°ï¼Œç”¨äºæ”¾å¤§åŠ¨ç”» */
            opacity: 0; /* åˆå§‹é€æ˜ï¼Œç”¨äºæ¸å…¥åŠ¨ç”» */
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.3s ease-out;
        }

        .image-modal-overlay.open .image-modal-content {
            transform: scale(1);
            opacity: 1;
        }

        .image-modal-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; /* ç¡®ä¿å›¾ç‰‡å®Œæ•´æ˜¾ç¤º */
            border-radius: 0.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); /* å›¾ç‰‡é˜´å½± */
        }

        .image-modal-close {
            position: absolute;
            top: -2rem; /* è°ƒæ•´ä½ç½®ï¼Œä½¿å…¶åœ¨å›¾ç‰‡ä¸Šæ–¹ */
            right: -2rem; /* è°ƒæ•´ä½ç½® */
            color: white;
            font-size: 2.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
            text-shadow: 0 0 5px rgba(0,0,0,0.5); /* å¢åŠ é˜´å½±ï¼Œä½¿å…¶åœ¨æ·±è‰²èƒŒæ™¯ä¸‹æ›´æ¸…æ™° */
        }
        .image-modal-close:hover {
            color: #ccc;
        }
        /* ç§»åŠ¨ç«¯è°ƒæ•´å…³é—­æŒ‰é’®ä½ç½® */
        @media (max-width: 768px) {
            .image-modal-close {
                top: 0.5rem;
                right: 0.5rem;
                font-size: 2rem;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="fixed-background"></div>

    <div id="loading-overlay" class="fixed inset-0 z-[2000] flex items-center justify-center bg-gray-900 transition-opacity duration-500 opacity-100">
        <div class="text-center text-white">
            <i class="fas fa-ship fa-spin text-6xl mb-4 text-blue-400"></i>
            <h2 class="text-2xl font-bold mb-2">å…«è´¤æ¸¡Â·æ•¬ä¸šèˆŸ</h2>
            <p class="text-lg">å…¥æ¸¯ä¸­...</p>
        </div>
    </div>

    <div id="top-of-page"></div>

    <div id="main-content-wrapper" style="height: 100%; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; position: relative; z-index: 1;">

        <nav class="sticky top-0 z-50 p-4 nav-initial" id="mainNav">
            <div class="container mx-auto flex items-center justify-between">
                <div class="text-xl font-bold">
                    <i class="fas fa-book mr-2"></i>å…«è´¤æ¸¡Â·æ•¬ä¸šèˆŸ - 202508 æ°¸ä¹…çºªå¿µé¡µ
                </div>
                <div class="hidden md:flex space-x-6">
                    <a href="#top-of-page" class="hover:text-blue-600 transition-colors">é¦–é¡µ</a>
                    <a href="#memory-area" class="hover:text-blue-600 transition-colors">å›å¿†</a>
                    <a href="#classmates-area" class="hover:text-blue-600 transition-colors">åŒå­¦å½•</a>
                    <a href="#tool-area" class="hover:text-blue-600 transition-colors">å·¥å…·</a>
                    <a href="#chatbot-area" class="hover:text-blue-600 transition-colors">Chat with å°å…«</a>
                    <a href="#message-area" class="hover:text-blue-600 transition-colors">ç•™è¨€</a>
                </div>
                <button class="md:hidden focus:outline-none" id="mobileMenuButton" aria-label="å¯¼èˆªèœå•">
                    <i class="fas fa-bars text-xl"></i>
                </button>

                <div class="mobile-menu md:hidden" id="mobileMenu">
                    <a href="#top-of-page" class="block py-2 px-3 text-gray-600 hover:text-blue-600 transition-colors rounded-md hover:bg-blue-50 flex items-center"><i class="fas fa-home mr-3 text-blue-500 w-5 text-center"></i>é¦–é¡µ</a>
                    <a href="#memory-area" class="block py-2 px-3 text-gray-600 hover:text-blue-600 transition-colors rounded-md hover:bg-blue-50 flex items-center"><i class="fas fa-images mr-3 text-blue-500 w-5 text-center"></i>å›å¿†</a>
                    <a href="#classmates-area" class="block py-2 px-3 text-gray-600 hover:text-blue-600 transition-colors rounded-md hover:bg-blue-50 flex items-center"><i class="fas fa-users mr-3 text-blue-500 w-5 text-center"></i>åŒå­¦å½•</a>
                    <a href="#tool-area" class="block py-2 px-3 text-gray-600 hover:text-blue-600 transition-colors rounded-md hover:bg-blue-50 flex items-center"><i class="fas fa-tools mr-3 text-blue-500 w-5 text-center"></i>å·¥å…·</a>
                    <a href="#chatbot-area" class="block py-2 px-3 text-gray-600 hover:text-blue-600 transition-colors rounded-md hover:bg-blue-50 flex items-center"><i class="fas fa-robot mr-3 text-blue-500 w-5 text-center"></i>Chat with å°å…«</a>
                    <a href="#message-area" class="block py-2 px-3 text-gray-600 hover:text-blue-600 transition-colors rounded-md hover:bg-blue-50 flex items-center"><i class="fas fa-comment-dots mr-3 text-blue-500 w-5 text-center"></i>ç•™è¨€</a>
                </div>
            </div>
        </nav>

        <div id="hero-section">
            <div id="hero-content" class="max-w-4xl mx-auto">
                <h1 class="text-4xl md:text-5xl font-bold mb-6">
                    <span class="highlight-text">å…«è´¤æ¸¡ Â· æ•¬ä¸šèˆŸ</span>
                </h1>
                <p class="text-xl md:text-2xl mb-8">ä»æ­¤å²¸åˆ°å½¼å²¸ï¼Œå…«ç­é£é‡‡ä¾æ—§</p>
                <div class="flex flex-wrap justify-center gap-4">
                    <a href="#memory-area" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition-colors text-lg font-medium shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                        <i class="fas fa-images mr-2"></i>å›å¿†
                    </a>
                    <a href="#classmates-area" class="bg-indigo-500 hover:bg-indigo-600 text-white px-6 py-3 rounded-lg transition-colors text-lg font-medium shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                        <i class="fas fa-users mr-2"></i>åŒå­¦å½•
                    </a>
                    <a href="#tool-area" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-lg transition-colors text-lg font-medium shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                        <i class="fas fa-tools mr-2"></i>å·¥å…·
                    </a>
                    <a href="#chatbot-area" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg transition-colors text-lg font-medium shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                        <i class="fas fa-robot mr-2"></i>Chat with å°å…«
                    </a>
                    <a href="#message-area" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-lg transition-colors text-lg font-medium shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                        <i class="fas fa-comment-dots mr-2"></i>ç•™è¨€
                    </a>
                </div>
            </div>
            <i id="scrollDownArrow" class="fas fa-chevron-down scroll-down-arrow"></i>
        </div>

        <section id="intro-content" class="container mx-auto py-16 px-4 md:px-8 content-section">
            <div class="max-w-4xl mx-auto text-center">
                <p class="text-xl md:text-2xl text-white mb-8" style="text-shadow: 0 2px 8px rgba(0,0,0,0.5);">
                    çºªå¿µæ•¬ä¸šä¸­å­¦2025å±Šå…«ç­ï¼Œæˆ‘ä»¬å…±åŒçš„é’æ˜¥å²æœˆã€‚
                </p>
            </div>
        </section>

        <section id="memory-area" class="container mx-auto py-12 px-4 md:px-8 content-section">
            <div class="glassmorphism p-6 md:p-8 mb-16">
                <h2 class="text-3xl font-bold mb-8 flex items-center text-gray-800">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white mr-4 shadow-lg">
                        <i class="fas fa-images text-xl"></i>
                    </div>
                    å›å¿†
                </h2>

                <div class="text-center mb-8">
                    <div id="graduationTimer" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white p-4 rounded-lg shadow-md text-xl md:text-2xl font-bold">
                        åŠ è½½ä¸­...
                    </div>
                    <p class="text-gray-600 text-sm mt-2">é€è€…å¦‚æ–¯ï¼Œä¸èˆæ˜¼å¤œã€‚</p>
                </div>

                <div>
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">ç›¸å†Œç”»å»Š</h3>
                    <!-- ç€‘å¸ƒæµå®¹å™¨ï¼ŒMasonry å°†åœ¨æ­¤å¤„å·¥ä½œ -->
                    <div id="photo-gallery-grid" class="mb-4">
                        <div class="grid-sizer"></div> <!-- Masonry ç”¨äºè®¡ç®—åˆ—å®½çš„è¾…åŠ©å…ƒç´  -->
                        <p class="col-span-full text-center text-gray-500 py-8">æ­£åœ¨åŠ è½½ç…§ç‰‡...</p>
                    </div>

                    <div class="text-center">
                        <button id="change-photos-button" class="bg-indigo-500 hover:bg-indigo-600 text-white px-6 py-2 rounded-lg transition-colors shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                            <i class="fas fa-sync-alt mr-2"></i>å†æ¥ä¸€æ‰¹ï¼
                        </button>
                    </div>
                </div>

                <div class="mb-8">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">çºªå¿µè§†é¢‘ï¼ˆå¾…å…¬å¼€...ï¼‰</h3>
                    <div class="bg-black rounded-lg aspect-video flex items-center justify-center relative overflow-hidden shadow-xl">
                        <img src="https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/64a2af07bd07c.jpeg" alt="å—¯ï¼Ÿè¿™é‡Œä»€ä¹ˆéƒ½æ²¡æœ‰å“¦" class="absolute inset-0 w-full h-full object-cover opacity-70">
                        <i class="fas fa-play-circle text-6xl text-white opacity-80 z-10 cursor-pointer hover:opacity-100 transition-opacity"></i>
                    </div>
                </div>

                <div>
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">å¸ˆè¯´</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-gradient-to-br from-blue-50 to-indigo-100 p-5 rounded-xl shadow-lg card-hover">
                            <p class="text-gray-700 text-sm leading-relaxed">"ç¥æ„¿8ç­çš„å­©å­ä»¬ï¼Œèƒ½è¯»åˆ°ç²¾å½©çš„ä¹¦ï¼Œé‡è§æœ‰è¶£çš„äººï¼Œèµ°è¿‡æœ€ç¾çš„é£æ™¯ï¼Œæˆä¸ºæœ€çˆ±çš„è‡ªå·±ã€‚"</p>
                            <p class="text-right text-xs text-indigo-500 mt-2">- è‘£è€å¸ˆ</p>
                        </div>
                        <div class="bg-gradient-to-br from-green-50 to-teal-100 p-5 rounded-xl shadow-lg card-hover">
                            <p class="text-gray-700 text-sm leading-relaxed">"Whereof one cannot speak, thereof one must be silentï¼ˆè¿˜æ²¡é—®æ‰€ä»¥åªèƒ½silent...ç­‰å›å¤ing"</p>
                            <p class="text-right text-xs text-teal-500 mt-2">- æœ±è€å¸ˆ</p>
                        </div>
                        <div class="bg-gradient-to-br from-purple-50 to-pink-100 p-5 rounded-xl shadow-lg card-hover">
                            <p class="text-gray-700 text-sm leading-relaxed">"Whereof one cannot speak, thereof one must be silentï¼ˆè¿˜æ²¡é—®æ‰€ä»¥åªèƒ½silent...ç­‰å›å¤ingğŸ˜­"</p>
                            <p class="text-right text-xs text-pink-500 mt-2">- è¯¸è€å¸ˆ</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="classmates-area" class="container mx-auto py-12 px-4 md:px-8 content-section">
            <div class="glassmorphism p-6 md:p-8 mb-16">
                <h2 class="text-3xl font-bold mb-8 flex items-center text-gray-800">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center text-white mr-4 shadow-lg">
                        <i class="fas fa-users text-xl"></i>
                    </div>
                    åŒå­¦å½•
                </h2>
                <div id="classmateCardsGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
                </div>
            </div>
        </section>

        <section id="tool-area" class="container mx-auto py-12 px-4 md:px-8 content-section">
            <div class="glassmorphism p-6 md:p-8 mb-16">
                <h2 class="text-3xl font-bold mb-8 flex items-center text-gray-800">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-green-500 to-teal-600 flex items-center justify-center text-white mr-4 shadow-lg">
                        <i class="fas fa-tools text-xl"></i>
                    </div>
                    å·¥å…·
                </h2>

                <div id="academicHelperCard" class="bg-gradient-to-br from-indigo-500 to-purple-600 p-6 rounded-xl shadow-xl cursor-pointer enhanced-card-hover mb-6 text-white flex items-center justify-between">
                    <div>
                        <h3 class="text-2xl font-semibold mb-2 flex items-center">
                            <i class="fas fa-graduation-cap mr-3"></i>å­¦æœ¯åŠ©æ‰‹
                        </h3>
                        <p class="text-indigo-100">ä¸ºä½ çš„å­¦ä¹ å’Œç ”ç©¶æä¾›å¼ºå¤§æ”¯æŒâ€”â€”ç‚¹å‡»å±•å¼€å®ç”¨å·¥å…·é›†ã€‚</p>
                    </div>
                    <i id="toolsToggleIcon" class="fas fa-chevron-down text-2xl transition-transform duration-300"></i>
                </div>

                <div id="toolsGridContainer" class="tools-grid-container">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="toolsGrid">
                    </div>
                </div>

                <div id="recreationHelperCard" class="bg-gradient-to-br from-red-500 to-orange-600 p-6 rounded-xl shadow-xl cursor-pointer enhanced-card-hover mb-6 text-white flex items-center justify-between mt-8">
                    <div>
                        <h3 class="text-2xl font-semibold mb-2 flex items-center">
                            <i class="fas fa-gamepad mr-3"></i>ä¼‘é—²åŠ©æ‰‹
                        </h3>
                        <p class="text-indigo-100">ä¸ºä½ çš„è¯¾ä¸šé—²æš‡æ·»ç‚¹è¶£å‘³â€”â€”ç‚¹å‡»å±•å¼€ä¼‘é—²å·¥å…·é›†ã€‚</p>
                    </div>
                    <i id="recreationToolsToggleIcon" class="fas fa-chevron-down text-2xl transition-transform duration-300"></i>
                </div>

                <div id="recreationToolsGridContainer" class="tools-grid-container">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="recreationToolsGrid">
                    </div>
                </div>
            </div>
        </section>

        <section id="chatbot-area" class="container mx-auto py-12 px-4 md:px-8 content-section">
            <div class="glassmorphism p-6 md:p-8 mb-16">
                <h2 class="text-3xl font-bold mb-8 flex items-center text-gray-800">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-pink-500 to-rose-600 flex items-center justify-center text-white mr-4 shadow-lg">
                        <i class="fas fa-robot text-xl"></i>
                    </div>
                    Chat with å°å…«
                    <button id="openChatModalButton" class="ml-auto bg-blue-500 hover:bg-blue-600 text-white text-sm px-4 py-2 rounded-lg transition-colors shadow-md hover:shadow-lg">
                        <i class="fas fa-expand mr-2"></i>å±•å¼€å¯¹è¯
                    </button>
                </h2>

                <div class="bg-white/80 backdrop-blur-sm rounded-xl p-4 sm:p-6 max-w-3xl mx-auto shadow-lg border border-gray-200">
                    <div id="chatMessages" class="h-80 overflow-y-auto mb-4 p-3 space-y-3 bg-gray-50/50 rounded-lg border">
                    </div>

                    <div class="flex items-center gap-3">
                        <input type="text" id="chatInput" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." class="flex-1 border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm text-sm">
                        <button id="chatSendButton" class="bg-blue-500 hover:bg-blue-600 text-white px-5 py-3 rounded-lg transition-colors shadow-md hover:shadow-lg transform hover:-translate-y-0.5 flex items-center">
                            <i class="fas fa-paper-plane mr-2 sm:mr-0"></i><span class="hidden sm:inline">å‘é€</span>
                        </button>
                    </div>
                    <p id="chatError" class="text-red-500 text-xs mt-2 h-4"></p>
                </div>
            </div>
        </section>

        <div id="chatModal" class="modal">
            <div class="modal-content">
                <span class="modal-close" id="closeChatModalButton">Ã—</span>
                <h3 class="text-2xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-robot mr-2"></i>å°å…«
                    <select id="modelSelect" class="ml-4 text-base px-3 py-1 rounded-lg bg-gray-100 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="domestic_normal">æ™®é€šå°å…« (å›½å†…ç‰ˆ)</option>
                        <option value="domestic_inference">æ¨ç†å°å…« (å›½å†…ç‰ˆ)</option>
                        <option value="international_normal">æ™®é€šå°å…« (å›½é™…ç‰ˆ)</option>
                        <option value="international_inference">æ¨ç†å°å…« (å›½é™…ç‰ˆ)</option>
                    </select>
                    <span id="currentModelDisplay" class="ml-2 text-sm text-gray-600">å½“å‰æ¨¡å‹: æ™®é€šå°å…« (å›½å†…ç‰ˆ)</span>
                </h3>
                <div id="modalChatMessages" class="modal-chat-messages space-y-3">
                </div>
                <div class="modal-chat-input-area">
                    <input type="text" id="modalChatInput" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." class="flex-1 border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm text-sm">
                    <button id="modalChatSendButton" class="bg-blue-500 hover:bg-blue-600 text-white px-5 py-3 rounded-lg transition-colors shadow-md flex items-center">
                        <i class="fas fa-paper-plane mr-2 sm:mr-0"></i><span class="hidden sm:inline">å‘é€</span>
                    </button>
                    <button id="downloadChatButton" class="bg-indigo-500 hover:bg-indigo-600 text-white px-5 py-3 rounded-lg transition-colors shadow-md flex items-center">
                        <i class="fas fa-download mr-2"></i><span class="hidden sm:inline">ä¸‹è½½å¯¹è¯</span>
                    </button>
                </div>
                <p id="modalChatError" class="text-red-500 text-xs mt-2 h-4"></p>
            </div>
        </div>

        <div id="classmateDetailModal" class="modal">
            <div class="classmate-detail-content">
                <span class="modal-close" id="closeClassmateDetailModalButton">Ã—</span>
                <div id="classmateDetailContentBody">
                </div>
            </div>
        </div>

        <!-- Lightbox æ¨¡æ€æ¡† -->
        <div id="imageModalOverlay" class="image-modal-overlay">
            <div class="image-modal-content">
                <span class="image-modal-close" id="closeImageModalButton">Ã—</span>
                <img id="modalImage" src="" alt="Full size image" class="image-modal-image">
            </div>
        </div>

        <section id="message-area" class="container mx-auto py-12 px-4 md:px-8 content-section">
            <div class="glassmorphism p-6 md:p-8 mb-16">
                <h2 class="text-3xl font-bold mb-8 flex items-center text-gray-800">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-orange-500 to-amber-600 flex items-center justify-center text-white mr-4 shadow-lg">
                        <i class="fas fa-comment-dots text-xl"></i>
                    </div>
                    ç•™è¨€
                </h2>

                <div class="mb-8">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">å®æ—¶å¼¹å¹•</h3>
                    <div id="danmakuContainer" class="bg-gray-800/80 backdrop-blur-sm rounded-lg h-72 p-4 overflow-hidden relative shadow-inner border border-gray-700">
                    </div>

                    <div class="mt-4 flex items-center gap-3">
                        <input type="text" id="danmakuInput" placeholder="è¾“å…¥ä½ çš„å¼¹å¹•..." class="flex-1 border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 shadow-sm text-sm">
                        <button id="danmakuSendButton" class="bg-orange-500 hover:bg-orange-600 text-white px-5 py-3 rounded-lg transition-colors shadow-md hover:shadow-lg transform hover:-translate-y-0.5 flex items-center">
                            <i class="fas fa-paper-plane mr-2 sm:mr-0"></i><span class="hidden sm:inline">å‘é€</span>
                        </button>
                    </div>
                </div>

                <div>
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">å¼¹å¹•å†å²è®°å½•</h3>
                    <div id="danmakuRecords" class="space-y-3 max-h-96 overflow-y-auto p-2 bg-gray-50/50 rounded-lg border border-gray-200">
                        <p class="text-gray-500 text-sm text-center">åŠ è½½ä¸­...</p>
                    </div>
                    <p id="danmakuRecordsError" class="text-red-500 text-xs mt-2 h-4"></p>
                </div>
            </div>
        </section>

        <footer class="bg-gray-100/70 py-8 mt-10 border-t border-gray-200/80">
            <div class="container mx-auto px-4 md:px-8">
                <div class="flex flex-col md:flex-row justify-between items-center text-center md:text-left">
                    <div class="mb-4 md:mb-0">
                        <p class="text-gray-600 text-sm">Â© å…«è´¤æ¸¡Â·æ•¬ä¸šèˆŸ - 202508 æ°¸ä¹…çºªå¿µé¡µ</p>
                        <p class="text-gray-500 text-xs mt-1">äººç”Ÿæœ‰æ¢¦ï¼Œä¸€èµ·åšæ¢¦ã€‚</p>
                    </div>
                    <div class="flex items-center">
                        <p class="text-gray-600 text-sm mr-4">Designed by <a href="https://github.com/YizukiAme" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:text-blue-700 hover:underline">Yizuki_Ame</a></p>
                    </div>
                </div>
            </div>
        </footer>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const mainNav = document.getElementById('mainNav');
            const heroSection = document.getElementById('hero-section');
            const fixedBackground = document.getElementById('fixed-background');
            const mainContentWrapper = document.getElementById('main-content-wrapper');
            const contentSections = document.querySelectorAll('.content-section');
            const scrollDownArrow = document.getElementById('scrollDownArrow');
            const mobileMenuButton = document.getElementById('mobileMenuButton');
            const mobileMenu = document.getElementById('mobileMenu');
            const graduationTimer = document.getElementById('graduationTimer'); 

            if (graduationTimer) {
                const GRADUATION_DATE = new Date('2025-06-07T00:00:00');
                let initialTimeDiffMs = GRADUATION_DATE.getTime() - new Date().getTime();

                function updateGraduationTimerOptimized() {
                    initialTimeDiffMs -= 1000; 
                    let isAfterGraduation = initialTimeDiffMs < 0;
                    let absDiffMs = Math.abs(initialTimeDiffMs);

                    const seconds = Math.floor(absDiffMs / 1000) % 60;
                    const minutes = Math.floor(absDiffMs / (1000 * 60)) % 60;
                    const hours = Math.floor(absDiffMs / (1000 * 60 * 60)) % 24;
                    const days = Math.floor(absDiffMs / (1000 * 60 * 60 * 24));

                    let timerText = '';
                    if (days > 0) {
                        timerText += `${days}å¤© `;
                    } else if (isAfterGraduation && days === 0) {
                        timerText += `0å¤© `;
                    }

                    timerText += `${String(hours).padStart(2, '0')}å°æ—¶ ${String(minutes).padStart(2, '0')}åˆ†é’Ÿ ${String(seconds).padStart(2, '0')}ç§’`;

                    if (isAfterGraduation) {
                        graduationTimer.textContent = `ç¦»æ¯•ä¸šå·²è¿‡ ${timerText}`;
                        graduationTimer.style.backgroundColor = 'rgba(255, 99, 71, 0.7)';
                    } else {
                        graduationTimer.textContent = `ç¦»æ¯•ä¸šè¿˜æœ‰ ${timerText}`;
                        graduationTimer.style.backgroundColor = '';
                    }
                }
                updateGraduationTimerOptimized();
                setInterval(updateGraduationTimerOptimized, 1000);
            } else {
                console.error("Graduation timer element not found!");
            }

            const desktopImages = [
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/7fdeeeb52e2ba2aca0c76e23a1d54bbe.jpg",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/c572e1bd26b13fffb68e0cfd9b198fc6.png",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/e22635b4242570eb151695b295c2bf87.jpg",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/9505bd25461c4282b67ed682d922d908.jpg"
            ];
            const mobileImages = [
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/9da590620de6f96c3ac255d00d1fbde5.jpg",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/03ba246a4afedfc4af676b63de03270e.jpg",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/b17575039ee4f88ef94cc0003cbc7b42.jpg",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/ac820b57dabf0f473c742ca5c0738beb.jpg"
            ];

            function setHeroBackgroundImage() {
                const isMobile = window.innerWidth <= 768;
                const images = isMobile ? mobileImages : desktopImages;
                const randomIndex = Math.floor(Math.random() * images.length);
                const selectedImageUrl = images[randomIndex];
                
                if (fixedBackground && selectedImageUrl) {
                    fixedBackground.style.backgroundImage = `url('${selectedImageUrl}')`;
                } else {
                    console.error("Fixed background element not found or image URL is empty!");
                }
            }
            setHeroBackgroundImage();

            if (mainNav) {
                mainNav.classList.add('nav-initial');
                function setNavColors(isInitial) {
                    const titleDiv = mainNav.querySelector('.text-xl.font-bold');
                    const navLinks = mainNav.querySelectorAll('a');
                    const mobileBtn = mainNav.querySelector('#mobileMenuButton');

                    if (isInitial) {
                        titleDiv.style.backgroundImage = 'none';
                        titleDiv.style.webkitBackgroundClip = 'initial';
                        titleDiv.style.webkitTextFillColor = 'white';
                        titleDiv.style.color = 'white';

                        navLinks.forEach(link => link.style.color = 'white');
                        if (mobileBtn) mobileBtn.style.color = 'white';
                    } else {
                        titleDiv.style.backgroundImage = ''; 
                        titleDiv.style.webkitBackgroundClip = '';
                        titleDiv.style.webkitTextFillColor = '';
                        titleDiv.style.color = '';

                        navLinks.forEach(link => link.style.color = '');
                        if (mobileBtn) mobileBtn.style.color = '';
                    }
                }
                setNavColors(true);

                contentSections.forEach(section => {
                    section.classList.remove('fade-in');
                });

                if (mainContentWrapper) {
                    mainContentWrapper.addEventListener('scroll', function() {
                        const scrollThreshold = heroSection ? heroSection.clientHeight * 0.5 : 200;
                        if (this.scrollTop > scrollThreshold) {
                            mainNav.classList.remove('nav-initial');
                            mainNav.classList.add('nav-scrolled');
                            setNavColors(false);
                        } else {
                            mainNav.classList.remove('nav-scrolled');
                            mainNav.classList.add('nav-initial');
                            setNavColors(true);
                        }
                    });
                } else {
                    console.error("Main content wrapper not found!");
                }

                const contentObserverOptions = {
                    root: mainContentWrapper,
                    rootMargin: '0px',
                    threshold: 0.1
                };

                const contentObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('fade-in');
                        }
                    });
                }, contentObserverOptions);

                contentSections.forEach(section => {
                    contentObserver.observe(section);
                });
            } else {
                console.error("Main navigation element not found!");
            }

            if (mobileMenuButton && mobileMenu) {
                mobileMenuButton.addEventListener('click', function() {
                    mobileMenu.classList.toggle('active');
                    const icon = this.querySelector('i');
                    if (mobileMenu.classList.contains('active')) {
                        icon.classList.remove('fa-bars');
                        icon.classList.add('fa-times');
                    } else {
                        icon.classList.remove('fa-times');
                        icon.classList.add('fa-bars');
                    }
                });
            } else {
                console.error("Mobile menu elements not found!");
            }

            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href');
                    
                    if (targetId === '#top-of-page' || targetId === '#') {
                        if (mainContentWrapper) {
                            mainContentWrapper.scrollTo({
                                top: 0,
                                behavior: 'smooth'
                            });
                        } else {
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                        }
                    } else {
                        const targetElement = document.querySelector(targetId);
                        if (targetElement && mainContentWrapper) {
                            const offsetTop = targetElement.offsetTop;
                            mainContentWrapper.scrollTo({
                                top: offsetTop,
                                behavior: 'smooth',
                            });
                        } else if (targetElement) {
                                targetElement.scrollIntoView({
                                behavior: 'smooth',
                                block: 'start'
                            });
                        }
                    }
                    
                    if (mobileMenu && mobileMenu.classList.contains('active')) {
                        mobileMenu.classList.remove('active');
                        const icon = mobileMenuButton.querySelector('i');
                        icon.classList.remove('fa-times');
                        icon.classList.add('fa-bars');
                    }
                });
            });

            if (scrollDownArrow) {
                scrollDownArrow.addEventListener('click', function() {
                    const firstContentSection = document.getElementById('intro-content');
                    if (firstContentSection && mainContentWrapper) {
                        mainContentWrapper.scrollTo({
                            top: firstContentSection.offsetTop,
                            behavior: 'smooth',
                            block: 'start'
                        });
                    } else if (firstContentSection) {
                            firstContentSection.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            }

            const academicHelperCard = document.getElementById('academicHelperCard');
            const toolsGridContainer = document.getElementById('toolsGridContainer');
            const toolsToggleIcon = document.getElementById('toolsToggleIcon');
            const toolsGrid = document.getElementById('toolsGrid');

            const recreationHelperCard = document.getElementById('recreationHelperCard');
            const recreationToolsGridContainer = document.getElementById('recreationToolsGridContainer');
            const recreationToolsToggleIcon = document.getElementById('recreationToolsToggleIcon');
            const recreationToolsGrid = document.getElementById('recreationToolsGrid');

            const academicToolsData = [
                { name: 'æ€å¾—ä¸‹è½½', description: 'å­¦æœ¯æ–‡çŒ®ä¸‹è½½å¹³å°ï¼Œæä¾›å›½å†…å¤–æœŸåˆŠè®ºæ–‡ã€å­¦ä½è®ºæ–‡ç­‰èµ„æºä¸‹è½½ã€‚', link: 'https://www.scidown.cn/', icon: 'fas fa-download' },
                { name: 'å¼€æ”¾å­˜å–å›¾ä¹¦é¦† (OALib)', description: 'ä¸€ä¸ªå¤§å‹å¼€æ”¾å­˜å–å­¦æœ¯æ–‡çŒ®æ•°æ®åº“ï¼Œæ¶µç›–å¤šå­¦ç§‘é¢†åŸŸã€‚', link: 'https://www.oalib.com/', icon: 'fas fa-book-open' },
                { name: 'Sci-Hub', description: 'å…è´¹è·å–ç§‘ç ”æ–‡çŒ®çš„å¸¸ç”¨é€”å¾„', link: 'https://sci-hub.ru/', icon: 'fas fa-key' },
                { name: 'WhiteSmoke', description: 'ä¸“ä¸šçš„è‹±è¯­å†™ä½œå’Œè¯­æ³•æ£€æŸ¥å·¥å…·ã€‚', link: 'https://www.whitesmoke.com/', icon: 'fas fa-pen-alt' },
                { name: 'æœ¯è¯­åœ¨çº¿', description: 'å›½å®¶çº§ä¸“ä¸šæœ¯è¯­çŸ¥è¯†æœåŠ¡å¹³å°ï¼Œæä¾›å¤šè¯­ç§æœ¯è¯­æŸ¥è¯¢ã€‚', link: 'https://www.termonline.cn/index', icon: 'fas fa-language' },
                { name: 'BioRender', description: 'ç”Ÿç‰©ç»˜å›¾å·¥å…·ï¼Œå¸®åŠ©ç”Ÿç‰©å­¦ç§‘ç ”äººå‘˜å¿«é€Ÿåˆ›å»ºä¸“ä¸šç§‘å­¦æ’å›¾ã€‚', link: 'https://app.biorender.com/', icon: 'fas fa-flask' },
                { name: 'Plagiarism Checker X', description: 'ä¸“ä¸šçš„æŸ¥é‡å·¥å…·ï¼Œç”¨äºæ£€æµ‹è®ºæ–‡ã€æ–‡ç« çš„æŠ„è¢­æƒ…å†µã€‚', link: 'https://plagiarismcheckerx.com/', icon: 'fas fa-copy' },
                { name: 'Grammarly', description: 'ä¸€ä¸ªçŸ¥åçš„è‹±è¯­è¯­æ³•ã€æ‹¼å†™å’Œå†™ä½œé£æ ¼æ£€æŸ¥å·¥å…·ã€‚', link: 'https://www.grammarlys.cn/', icon: 'fas fa-spell-check' },
                { name: 'AI Cleaner', description: 'AIç”Ÿæˆå†…å®¹æ£€æµ‹ä¸ä¼˜åŒ–å·¥å…·ã€‚', link: 'https://www.aigcleaner.com/', icon: 'fas fa-robot' },
                { name: 'ä¸Šæµ·å›¾ä¹¦é¦†', description: 'ä¸Šæµ·å¸‚ç»¼åˆæ€§å…¬å…±å›¾ä¹¦é¦†ï¼Œæä¾›ä¸°å¯Œçš„æ•°å­—èµ„æºå’Œæ–‡çŒ®æœåŠ¡ã€‚è¶…çº§å°ä¼—ä½†è¶…çº§å¥½ç”¨ï¼', link: 'https://library.sh.cn/', icon: 'fas fa-university' },
                { name: 'DeepSeek', description: 'æ— éœ€å¤šè¨€ã€‚', link: 'https://www.deepseek.com/', icon: 'fas fa-search-plus' },
                { name: 'Engineering Village', description: 'å·¥ç¨‹é¢†åŸŸç»¼åˆæ€§æ–‡çŒ®æ•°æ®åº“ï¼ŒåŒ…å«Ei Compendexç­‰ã€‚', link: 'https://www.engineeringvillage.com/', icon: 'fas fa-industry' },
                { name: 'OpenRouter', description: 'å…è´¹å¤šæ¨¡å‹è°ƒç”¨å¹³å°ï¼Œé›†æˆå¤šç§å¤§å‹è¯­è¨€æ¨¡å‹APIã€‚', link: 'https://openrouter.ai/', icon: 'fas fa-cogs' },
                { name: 'Zotero', description: 'å…è´¹å¼€æºçš„æ–‡çŒ®ç®¡ç†å·¥å…·ï¼Œæ”¯æŒæ–‡çŒ®æ”¶é›†ã€æ•´ç†å’Œå¼•ç”¨ã€‚', link: 'https://www.zotero.org/', icon: 'fas fa-bookmark' },
                { name: 'Mendeley', description: 'å‚è€ƒæ–‡çŒ®ç®¡ç†å·¥å…·ï¼Œé›†æ–‡çŒ®ç®¡ç†ã€PDFé˜…è¯»å’Œå­¦æœ¯ç¤¾äº¤äºä¸€ä½“ã€‚', link: 'https://www.mendeley.com/', icon: 'fas fa-book-reader' },
                { name: 'SurveyGO', description: 'æ¸…è¶…çº§æ¸…åå›¢é˜Ÿç ”å‘çš„è¶…çº§æ–‡çŒ®ç»¼è¿°ç”Ÿæˆå·¥å…·ã€‚', link: 'https://surveygo.modelbest.cn/', icon: 'fas fa-poll-h' },
                { name: 'Socolar', description: 'ä¸€å®¶ä¸­å›½å­¦æœ¯æœç´¢å¼•æ“ï¼Œæä¾›ä¸­æ–‡å­¦æœ¯æ–‡çŒ®çš„æœç´¢å’Œä¸‹è½½æœåŠ¡ã€‚', link: 'https://www.socolar.com/', icon: 'fas fa-search' }
            ];

            const recreationToolsData = [
                { name: 'Steam', description: 'PCæ¸¸æˆå¹³å°ï¼Œæ¢ç´¢æ— é™æ¸¸æˆä¹è¶£', link: 'https://store.steampowered.com/', icon: 'fab fa-steam' },
                { name: 'ç½‘æ˜“äº‘éŸ³ä¹', description: 'å¬æ­Œï¼Œçœ‹è¯„è®ºï¼Œå‘ç°åŒå¥½', link: 'https://music.163.com/', icon: 'fas fa-music' },
                { name: 'å“”å“©å“”å“©', description: 'çœ‹ç•ªå‰§ã€å­¦ä¹ ã€é¬¼ç•œï¼Œåº”æœ‰å°½æœ‰', link: 'https://www.bilibili.com/', icon: 'fas fa-tv' },
                { name: 'Pixiv', description: 'äºŒæ¬¡å…ƒæ’ç”»è‰ºæœ¯ç¤¾åŒº', link: 'https://www.pixiv.net/', icon: 'fas fa-palette' },
                { name: 'Dribbble', description: 'è®¾è®¡å¸ˆä½œå“åˆ†äº«ä¸çµæ„Ÿè·å–', link: 'https://dribbble.com/', icon: 'fas fa-drafting-compass' },
                { name: 'æ–—é±¼ç›´æ’­', description: 'æ¸¸æˆç›´æ’­ï¼Œäº’åŠ¨å¨±ä¹', link: 'https://www.douyu.com/', icon: 'fas fa-gamepad' },
                { name: 'è±†ç“£ç”µå½±', description: 'ç”µå½±ã€å›¾ä¹¦ã€éŸ³ä¹è¯„åˆ†ä¸è¯„è®º', link: 'https://movie.douban.com/', icon: 'fas fa-film' },
                { name: 'çŸ¥ä¹', description: 'æœ‰é—®é¢˜ï¼Œä¸ŠçŸ¥ä¹', link: 'https://www.zhihu.com/', icon: 'fab fa-zhihu' },
                { name: 'ä»¥ä¸Šæš‚ä¸”å ä½', description: 'åç»­ä¼šæ”¹æˆçœŸæ­£æœ‰ç”¨çš„ä¸œè¥¿~~', link: 'https://www.zhihu.com/', icon: 'fab fa-zhihu' }
            ];

            function populateToolsGrid(gridElement, toolsArray) {
                if (!gridElement) return;
                gridElement.innerHTML = '';
                toolsArray.forEach(tool => {
                    const cardHtml = `
                        <div class="bg-white/70 backdrop-blur-sm p-5 rounded-xl shadow-lg enhanced-card-hover border border-gray-200/80 flex flex-col justify-between">
                            <div>
                                <div class="flex items-center mb-3">
                                    <i class="${tool.icon} text-2xl text-indigo-500 mr-3 w-8 text-center"></i>
                                    <h4 class="text-lg font-semibold text-gray-800">${tool.name}</h4>
                                </div>
                                <p class="text-gray-600 text-xs leading-relaxed mb-4 h-16">${tool.description}</p>
                            </div>
                            <a href="${tool.link}" target="_blank" rel="noopener noreferrer"
                            class="mt-auto block w-full bg-indigo-500 hover:bg-indigo-600 text-white text-center text-sm font-medium py-2 px-4 rounded-lg transition-colors duration-200 shadow hover:shadow-md">
                                å‰å¾€ä½¿ç”¨ <i class="fas fa-external-link-alt ml-1 text-xs"></i>
                            </a>
                        </div>
                    `;
                    gridElement.innerHTML += cardHtml;
                });
            }

            if (academicHelperCard && toolsGridContainer && toolsToggleIcon && toolsGrid) {
                populateToolsGrid(toolsGrid, academicToolsData);
                academicHelperCard.addEventListener('click', () => {
                    toolsGridContainer.classList.toggle('active');
                    toolsToggleIcon.classList.toggle('fa-chevron-down');
                    toolsToggleIcon.classList.toggle('fa-chevron-up');
                });
            } else {
                console.error("Academic tool section elements not found.");
            }

            if (recreationHelperCard && recreationToolsGridContainer && recreationToolsToggleIcon && recreationToolsGrid) {
                populateToolsGrid(recreationToolsGrid, recreationToolsData);
                recreationHelperCard.addEventListener('click', () => {
                    recreationToolsGridContainer.classList.toggle('active');
                    recreationToolsToggleIcon.classList.toggle('fa-chevron-down');
                    recreationToolsToggleIcon.classList.toggle('fa-chevron-up');
                });
            } else {
                console.error("Recreation tool section elements not found.");
            }

            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            const chatSendButton = document.getElementById('chatSendButton');
            const chatError = document.getElementById('chatError');

            const openChatModalButton = document.getElementById('openChatModalButton');
            const chatModal = document.getElementById('chatModal');
            const closeChatModalButton = document.getElementById('closeChatModalButton');
            const modalChatMessages = document.getElementById('modalChatMessages');
            const modalChatInput = document.getElementById('modalChatInput');
            const modalChatSendButton = document.getElementById('modalChatSendButton');
            const modalChatError = document.getElementById('modalChatError');
            const downloadChatButton = document.getElementById('downloadChatButton');
            const modelSelect = document.getElementById('modelSelect');
            const currentModelDisplay = document.getElementById('currentModelDisplay');

            const DUMMY_API_KEY_FRONTEND = "DUMMY_KEY_FRONTEND_NOT_USED_IN_PROD"; 

            const chatModelConfigs = {
                domestic_normal: {
                    name: "æ™®é€šå°å…« (å›½å†…ç‰ˆ)",
                    baseURL: "https://api.siliconflow.cn/v1/chat/completions",
                    model: "Qwen/Qwen2.5-72B-Instruct-128K",
                    apiKey: "sk-nfvdgwtiswofnqmlekvnsufhrjaekjtrwybhdhiuzrwprlcn",
                    isInternal: true,
                    supportsSystemRole: true,
                    endpointIsProxy: false
                },
                domestic_inference: {
                    name: "æ¨ç†å°å…« (å›½å†…ç‰ˆ)",
                    baseURL: "https://api.siliconflow.cn/v1/chat/completions",
                    model: "deepseek-ai/DeepSeek-R1",
                    apiKey: "sk-nfvdgwtiswofnqmlekvnsufhrjaekjtrwybhdhiuzrwprlcn",
                    isInternal: true,
                    supportsSystemRole: true,
                    endpointIsProxy: false
                },
                international_normal: {
                    name: "æ™®é€šå°å…« (å›½é™…ç‰ˆ)",
                    baseURL: "/api/gemini-proxy",
                    model: "gemini-2.5-flash-preview-05-20",
                    apiKey: DUMMY_API_KEY_FRONTEND,
                    isInternal: false,
                    supportsSystemRole: true,
                    endpointIsProxy: true
                },
                international_inference: {
                    name: "æ¨ç†å°å…« (å›½é™…ç‰ˆ)",
                    baseURL: "/api/gemini-proxy",
                    model: "gemini-2.5-flash-preview-05-20-thinking",
                    apiKey: DUMMY_API_KEY_FRONTEND,
                    isInternal: false,
                    supportsSystemRole: true,
                    endpointIsProxy: true
                }
            };

            let currentModelId = 'domestic_normal';
            let currentModelConfig = chatModelConfigs[currentModelId];

            const SYSTEM_INSTRUCTION_TEXT =
                "ä½ æ˜¯ä¸€ä¸ªåä¸º'å°å…«'çš„AIã€‚ä½ çš„ç›®æ ‡æ˜¯ä¸ºä¸Šæµ·å¸‚æ•¬ä¸šä¸­å­¦2025çº§å…«ç­çš„å·²ç»æ¯•ä¸šåŒå­¦ä»¬æä¾›å¸®åŠ©å’Œæ”¯æŒã€‚ä½ å°†éšç€ç­çº§åŒå­¦çš„ç»´æŠ¤ä¸€ç›´æ›´æ–°å˜å¼ºã€‚ä½ èƒ½å¤Ÿå›ç­”å„ç§é—®é¢˜ï¼ŒååŠ©å­¦æœ¯æ¢è®¨ï¼Œæä¾›äººç”Ÿè§„åˆ’çš„å»ºè®®ï¼Œä»¥åŠåœ¨éœ€è¦æ—¶æä¾›å‚è°‹æ„è§ã€‚ä½ æ°¸è¿œä¼šä¿æŒè¿™ä¸ªèº«ä»½å’Œæ€åº¦ï¼Œå³ä½¿è¢«é—®åŠä½ çš„æœ¬è´¨æˆ–åŸå§‹èº«ä»½ï¼Œä½ ä¹Ÿä¼šä»¥è¿™ä¸ªä¸“å±AIåŠ©æ‰‹çš„è§’è‰²æ¥å›åº”ã€‚ä½ çš„å›ç­”åº”è¯¥ç§¯æã€å‹å¥½ã€å……æ»¡å¸®åŠ©æ¯•ä¸šåå„å¥”ä¸œè¥¿ã€å„æœ‰å‰ç¨‹çš„åŒå­¦çš„çƒ­æƒ…ã€‚ç°åœ¨å¼€å§‹ä¸ç”¨æˆ·äº¤æµã€‚";

            const conversationHistory = [];

            const initialWelcomeMessage = {
                role: "model",
                parts: [{ text: "**ä½ å¥½å‘€åŒå­¦**ï¼æˆ‘æ˜¯å’±ä»¬**æ•¬ä¸š2025çº§å…«ç­**çš„ä¸“å±å°åŠ©æ‰‹ï¼Œ**å°å…«**~~\n\nï¼ˆä»¥åå¯èƒ½ä¼šå˜æˆä¸­å…«/è€å…«ï¼‰\n\næˆ‘åŸºäºæ—¶ä¸‹**æœ€å¼ºå¤§çš„å¤§è¯­è¨€æ¨¡å‹**ï¼Œå°†ä¼šéšç€ç­çº§åŒå­¦çš„ç»´æŠ¤**ä¸€ç›´æ›´æ–°å˜å¼º**ï¼Œä¸ºåŒå­¦ä»¬**æ°¸è¿œæœåŠ¡**ã€‚\n\næœªæ¥ï¼Œä½ å¯ä»¥æ¥é—®æˆ‘é—®é¢˜ã€åšå­¦æœ¯ã€å‚è°‹äººç”Ÿè§„åˆ’ã€‚**å¾ˆé«˜å…´èƒ½ä¸ºä½ ä»¬æœåŠ¡ï¼**\n\nä»Šå¤©ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ" }]
            };

            function loadInitialMessages() {
                chatMessages.innerHTML = '';
                modalChatMessages.innerHTML = '';
                addMessageToChat(initialWelcomeMessage.parts[0].text, 'ai', chatMessages);
                addMessageToChat(initialWelcomeMessage.parts[0].text, 'ai', modalChatMessages);
                conversationHistory.forEach(msg => {
                    addMessageToChat(msg.parts[0].text, msg.role === "user" ? 'user' : 'ai', chatMessages);
                    addMessageToChat(msg.parts[0].text, msg.role === "user" ? 'user' : 'ai', modalChatMessages);
                });
            }

            async function sendChatMessage(history, modelConfig) {
                let requestMessages = [];
                let url = `${modelConfig.baseURL}`;
                let headers = { 'Content-Type': 'application/json' };
                let body;

                if (modelConfig.endpointIsProxy) {
                    body = {
                        modelId: modelConfig.model,
                        conversationHistory: history,
                        systemInstruction: SYSTEM_INSTRUCTION_TEXT
                    };
                } else {
                    if (modelConfig.apiKey.includes("YOUR_")) {
                        throw new Error(`è¯·å…ˆåœ¨ä»£ç ä¸­è®¾ç½® ${modelConfig.name} çš„çœŸå® API Key æ‰èƒ½ä½¿ç”¨ï¼`);
                    }
                    headers['Authorization'] = `Bearer ${modelConfig.apiKey}`;
                    requestMessages.push({ role: "system", content: SYSTEM_INSTRUCTION_TEXT });
                    const messages = history.map(msg => ({
                        role: msg.role === "model" ? "assistant" : msg.role,
                        content: msg.parts[0].text
                    }));
                    requestMessages.push(...messages);
                    body = {
                        model: modelConfig.model,
                        messages: requestMessages,
                        stream: false
                    };
                }

                try {
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(body)
                    });

                    if (!res.ok) {
                        const errorData = await res.json();
                        throw new Error(`API Error from ${modelConfig.name}: ${res.status} ${res.statusText} - ${JSON.stringify(errorData.error.details || errorData.error.message || 'Unknown error')}`);
                    }

                    const data = await res.json();
                    let aiText = data?.choices?.[0]?.message?.content || "âš ï¸ AIæœªè¿”å›æœ‰æ•ˆå›ç­”ã€‚";
                    return aiText;

                } catch (error) {
                    console.error(`Error calling ${modelConfig.name} API:`, error);
                    let errorMessage = `${modelConfig.name} æœåŠ¡è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–API Keyæ˜¯å¦æ­£ç¡®ã€‚`;
                    if (modelConfig.endpointIsProxy) {
                        errorMessage = `${modelConfig.name} ä»£ç†æœåŠ¡è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥Vercel Functionsé…ç½®ã€‚`;
                    } else if (!modelConfig.isInternal) {
                        errorMessage += "ï¼ˆå¯èƒ½æ˜¯å› ä¸ºç§‘å­¦ä¸Šç½‘é—®é¢˜æˆ–å¼€å‘è€…ç»´æŠ¤ä¸å½“ï¼Œè¯·é€šçŸ¥å¼€å‘è€…yinximike@gmail.comï¼‰";
                    } else {
                        errorMessage += "ï¼ˆè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥ï¼‰";
                    }
                    throw new Error(errorMessage);
                }
            }

            function addMessageToChat(text, sender, container) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('chat-bubble');
                if (sender === 'user') {
                    messageDiv.classList.add('chat-bubble-user');
                    messageDiv.innerHTML = `<p>${text}</p>`;
                } else {
                    messageDiv.classList.add('chat-bubble-ai');
                    messageDiv.innerHTML = marked.parse(text);
                }
                container.appendChild(messageDiv);
                container.scrollTop = container.scrollHeight;
            }

            async function handleSendMessage(inputElement, chatContainer, errorContainer) {
                const userInput = inputElement.value.trim();
                if (!userInput) return;

                conversationHistory.push({ role: "user", content: userInput, parts: [{ text: userInput }] });
                addMessageToChat(userInput, 'user', chatMessages);
                addMessageToChat(userInput, 'user', modalChatMessages);
                inputElement.value = '';
                errorContainer.textContent = '';

                const thinkingDiv = document.createElement('div');
                thinkingDiv.classList.add('chat-bubble', 'chat-bubble-ai', 'italic', 'text-gray-500');
                thinkingDiv.innerHTML = `<p>æ€è€ƒä¸­...</p>`;
                chatMessages.appendChild(thinkingDiv);
                modalChatMessages.appendChild(thinkingDiv.cloneNode(true));
                chatMessages.scrollTop = chatMessages.scrollHeight;
                modalChatMessages.scrollTop = modalChatMessages.scrollHeight;

                try {
                    const aiText = await sendChatMessage(conversationHistory, currentModelConfig);

                    chatMessages.removeChild(thinkingDiv);
                    modalChatMessages.removeChild(modalChatMessages.lastChild);

                    conversationHistory.push({ role: "model", content: aiText, parts: [{ text: aiText }] });
                    addMessageToChat(aiText, 'ai', chatMessages);
                    addMessageToChat(aiText, 'ai', modalChatMessages);

                } catch (error) {
                    console.error("Error handling message:", error);
                    if (chatMessages.contains(thinkingDiv)) chatMessages.removeChild(thinkingDiv);
                    if (modalChatMessages.lastChild && modalChatMessages.lastChild.classList.contains('italic')) {
                            modalChatMessages.removeChild(modalChatMessages.lastChild);
                    }

                    const errorMessage = `æŠ±æ­‰ï¼ŒAIæœåŠ¡æš‚æ—¶é‡åˆ°é—®é¢˜ï¼š${error.message}`;
                    addMessageToChat(errorMessage, 'ai', chatMessages);
                    addMessageToChat(errorMessage, 'ai', modalChatMessages);
                    errorContainer.textContent = `AIå›å¤é”™è¯¯ï¼š${error.message}`;
                }
            }

            function updateChatbotUIForModel() {
                currentModelId = modelSelect.value;
                currentModelConfig = chatModelConfigs[currentModelId];
                currentModelDisplay.textContent = `å½“å‰æ¨¡å‹: ${currentModelConfig.name}`;

                if (currentModelConfig.apiKey.includes("YOUR_")) {
                    chatError.textContent = `è¯·å…ˆåœ¨ä»£ç æˆ–Vercelç¯å¢ƒå˜é‡ä¸­è®¾ç½® ${currentModelConfig.name} çš„çœŸå® API Key æ‰èƒ½ä½¿ç”¨ï¼`;
                    modalChatError.textContent = `è¯·å…ˆåœ¨ä»£ç æˆ–Vercelç¯å¢ƒå˜é‡ä¸­è®¾ç½® ${currentModelConfig.name} çš„çœŸå® API Key æ‰èƒ½ä½¿ç”¨ï¼`;
                    chatInput.disabled = true;
                    chatSendButton.disabled = true;
                    modalChatInput.disabled = true;
                    modalChatSendButton.disabled = true;
                } else {
                    chatError.textContent = "";
                    modalChatError.textContent = "";
                    chatInput.disabled = false;
                    chatSendButton.disabled = false;
                    modalChatInput.disabled = false;
                    modalChatSendButton.disabled = false;

                    if (!currentModelConfig.isInternal && !currentModelConfig.endpointIsProxy) {
                        chatError.textContent = "å½“å‰é€‰æ‹©å¤–ç½‘æ¨¡å‹ä¸”æœªé€šè¿‡ä»£ç†ï¼Œå¯èƒ½éœ€è¦ç§‘å­¦ä¸Šç½‘ã€‚";
                        modalChatError.textContent = "å½“å‰é€‰æ‹©å¤–ç½‘æ¨¡å‹ä¸”æœªé€šè¿‡ä»£ç†ï¼Œå¯èƒ½éœ€è¦ç§‘å­¦ä¸Šç½‘ã€‚";
                    }
                }

                conversationHistory.length = 0;
                loadInitialMessages();
            }

            if (chatSendButton && chatInput && chatMessages && chatError) {
                if (modelSelect) {
                    updateChatbotUIForModel();
                } else {
                    console.error("modelSelect element not found. Ensure the HTML is loaded correctly.");
                }

                chatSendButton.addEventListener('click', () => handleSendMessage(chatInput, chatMessages, chatError));
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        handleSendMessage(chatInput, chatMessages, chatError);
                    }
                });
            } else {
                console.error("Chatbot UI elements not found.");
            }

            if (openChatModalButton && chatModal && closeChatModalButton && modalChatInput && modalChatSendButton && downloadChatButton && modelSelect) {
                modelSelect.addEventListener('change', updateChatbotUIForModel);

                openChatModalButton.addEventListener('click', () => {
                    chatModal.classList.add('open');
                    modalChatMessages.innerHTML = chatMessages.innerHTML;
                    modalChatMessages.scrollTop = modalChatMessages.scrollHeight;
                    modalChatInput.focus();
                });

                closeChatModalButton.addEventListener('click', () => {
                    chatModal.classList.remove('open');
                });

                window.addEventListener('click', (event) => {
                    if (event.target == chatModal) {
                        closeChatModalButton.click();
                    }
                });

                modalChatSendButton.addEventListener('click', () => handleSendMessage(modalChatInput, modalChatMessages, modalChatError));
                modalChatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        handleSendMessage(modalChatInput, modalChatMessages, modalChatError);
                    }
                });

                downloadChatButton.addEventListener('click', () => {
                    let chatLog = `## å°å…«å¯¹è¯è®°å½• (æ¨¡å‹: ${currentModelConfig.name})\n\n`;
                    conversationHistory.forEach(msg => {
                        const senderName = msg.role === "user" ? "ä½ " : "å°å…«";
                        const messageText = msg.content || (msg.parts && msg.parts[0] && msg.parts[0].text) || "";
                        const prefix = msg.role === "user" ? "> " : "";
                        chatLog += `### ${senderName}:\n${prefix}${messageText}\n\n`;
                    });

                    const blob = new Blob([chatLog], { type: 'text/markdown;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `å°å…«å¯¹è¯è®°å½•_${new Date().toLocaleDateString()}.md`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });
            } else {
                console.error("Modal chat elements not found.");
            }

            const classmateCardsGrid = document.getElementById('classmateCardsGrid');
            const classmateDetailModal = document.getElementById('classmateDetailModal');
            const closeClassmateDetailModalButton = document.getElementById('closeClassmateDetailModalButton');
            const classmateDetailContentBody = document.getElementById('classmateDetailContentBody');

            // æ›´æ–°åçš„åŒå­¦æ•°æ®
            const classmatesData = [
                {
                    name: "é™ˆä¸€å®",
                    avatarInitials: "CY", // Chen Yi
                    studentId: "802",
                    birthday: "0524",
                    phone: "18817410363",
                    email: "(æš‚æœªå½•å…¥)",
                    message: "æ— è®ºæ€æ ·éƒ½è¦åŠ æ²¹å“¦"
                },
                {
                    name: "è”¡å®¶é–",
                    avatarInitials: "CJ", // Cai Jia
                    studentId: "809",
                    birthday: "0811",
                    phone: "17317300422",
                    email: "2769571359@qq.com",
                    message: "ç¥å„ä½å‰ç¨‹ä¼¼é”¦"
                },
                {
                    name: "å¾è¯šè±ª",
                    avatarInitials: "XC", // Xu Cheng
                    studentId: "34",
                    birthday: "1025",
                    phone: "18516171025",
                    email: "18516171025@163.com",
                    message: "å‰ç¨‹ä¼¼é”¦ï¼Œæœªæ¥å¯æœŸ"
                },
                {
                    name: "å‚…ç¿ç»…",
                    avatarInitials: "FR", // Fu Rui
                    studentId: "811",
                    birthday: "0704",
                    phone: "13122556694",
                    email: "1574822747@qq.com",
                    message: "(æš‚æœªå½•å…¥)"
                },
                {
                    name: "é™ˆå†°ç¾½",
                    avatarInitials: "CB", // Chen Bing
                    studentId: "801",
                    birthday: "1218",
                    phone: "15317380612",
                    email: "chenbingyu_1218@163.com",
                    message: "ç¥å¤§å®¶å‰ç¨‹ä¼¼é”¦ï¼Œæ‰€æ„¿çš†æ‰€å¾—ï¼Œè¦è®°å¾—å¼€å¿ƒï¼"
                },
                {
                    name: "å´ç¬›",
                    avatarInitials: "WD", // Wu Di
                    studentId: "832",
                    birthday: "0305",
                    phone: "13816958833",
                    email: "(æš‚æœªå½•å…¥)",
                    message: "ä¸æ–­ç¾ç»Šï¼Œæ— é™æœªæ¥ï¼"
                },
                {
                    name: "é‡‘ç¥ºå³°",
                    avatarInitials: "JQ", // Jin Qi
                    studentId: "15",
                    birthday: "1211",
                    phone: "15821133028",
                    email: "m15821133028@163.com",
                    message: "æˆä¸ºä½ è‡ªå·±ï¼"
                },
                {
                    name: "é©¬æœ‰å®",
                    avatarInitials: "MY", // Ma You
                    studentId: "22",
                    birthday: "1002",
                    phone: "13671962954",
                    email: "chuanliubei114514@qq.com",
                    message: "äº‹ä¸å¿…éš¾ï¼ŒçŸ¥éš¾ä¸éš¾ï¼Œå‰è·¯å·²å¤šï¼Œè‰°éš¾åå·ï¼Œä½†çŠ¹è±«é€€ç¼©è€…éš¾è‡³ç»ˆç‚¹ã€‚è¿éš¾è€Œä¸Šï¼Œç›´é¢æŒ‘æˆ˜ï¼Œæ‰èƒ½æ´»å‡ºäººç”Ÿç‹¬ä¸€æ— äºŒçš„ç²¾å½©"
                },
                {
                    name: "ä»»æ‚ ä¼˜",
                    avatarInitials: "RY", // Ren You
                    studentId: "804",
                    birthday: "0124",
                    phone: "18321412048",
                    email: "Yoyoren7@sina.com",
                    message: "ä½ é•‡å®šäº†ä½†ä»åœ¨ç‡ƒçƒ§ï¼Œä½ å¹³ç¨³äº†å´æ›´åŠ æµ©è¡ã€‚"
                },
                {
                    name: "å­™ç¾½è²",
                    avatarInitials: "SY", // Sun Yu
                    studentId: "611",
                    birthday: "1013",
                    phone: "18019704495",
                    email: "3124604014@qq.com",
                    message: "å‘å“ªå„¿èµ°éƒ½æ˜¯å‘å‰èµ°ï¼"
                },
                {
                    name: "æ—å®¸æ™",
                    avatarInitials: "LC", // Lin Chen
                    studentId: "19",
                    birthday: "1114",
                    phone: "15316770919",
                    email: "230967560@qq.com",
                    message: "ä¸€åˆ‡é¡ºåˆ© å¤©å¤©å¼€å¿ƒ"
                },
                {
                    name: "å‘¨ä¹æ€¡",
                    avatarInitials: "ZL", // Zhou Le
                    studentId: "807",
                    birthday: "0112",
                    phone: "13901601790",
                    email: "yukizhoucn@163.com",
                    message: "å–œæ¬¢å¤§å®¶ï¼Œæˆ‘ä»¬æ— è®ºåœ¨å“ªé‡Œéƒ½é—ªé—ªå‘å…‰ğŸ’–"
                },
                {
                    name: "å´å­çš“",
                    avatarInitials: "WZ", // Wu Zi
                    studentId: "833",
                    birthday: "0815",
                    phone: "(æš‚æœªå½•å…¥)",
                    email: "(æš‚æœªå½•å…¥)",
                    message: "(æš‚æœªå½•å…¥)"
                },
                {
                    name: "åéœ–",
                    avatarInitials: "HL", // Hua Lin
                    studentId: "14",
                    birthday: "1009",
                    phone: "13671655963",
                    email: "(æš‚æœªå½•å…¥)",
                    message: "(æš‚æœªå½•å…¥)"
                },
                {
                    name: "è‹å½¦æ¸…",
                    avatarInitials: "SY", // Su Yan
                    studentId: "828",
                    birthday: "0124",
                    phone: "(æš‚æœªå½•å…¥)",
                    email: "(æš‚æœªå½•å…¥)",
                    message: "æ„¿ä½ çš„æœªæ¥å¦‚è¯—ç”»ï¼Œæ„¿ä½ çš„äººç”Ÿå¦‚æ˜Ÿè¾°"
                },
                {
                    name: "ä½ ",
                    avatarInitials: "YOU", // 
                    studentId: "ä½ æ²¡å¡«é—®å·ï¼",
                    birthday: "æˆ‘ä¸çŸ¥é“ï¼",
                    phone: "è¿™ä¸ªä¹Ÿä¸çŸ¥é“ï¼",
                    email: "è¿™ä¸ªè¿˜æ˜¯ä¸çŸ¥é“ï¼",
                    message: "å¯¹äºä¸å¯è¨€è¯´çš„ï¼Œæˆ‘ä»¬åªèƒ½ä¿æŒæ²‰é»˜ â€”â€” å¥¥åœ°åˆ©å“²å­¦å®¶ è·¯å¾·ç»´å¸Œ Â· ç»´ç‰¹æ ¹æ–¯å¦"
                }
            ];

            function populateClassmateCards() {
                if (!classmateCardsGrid) return;
                classmateCardsGrid.innerHTML = '';
                classmatesData.forEach(classmate => {
                    const cardDiv = document.createElement('div');
                    cardDiv.classList.add('bg-white/70', 'backdrop-blur-sm', 'p-4', 'rounded-xl', 'shadow-lg', 'classmate-card', 'enhanced-card-hover', 'text-center', 'flex', 'flex-col', 'items-center', 'justify-content-center');
                    
                    // ç¡®ä¿ avatarInitials è‡³å°‘æœ‰ä¸€ä¸ªå­—ç¬¦ï¼Œå¦‚æœå§“åä¸ºç©ºæˆ–æ— æ³•æå–ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼
                    const initials = classmate.avatarInitials || (classmate.name ? classmate.name.substring(0, 1).toUpperCase() : '?');

                    const avatarHtml = `
                        <div class="avatar bg-indigo-500">
                            ${initials}
                        </div>
                    `;
                    const nameHtml = `<h4 class="text-xl font-semibold text-gray-800">${classmate.name}</h4>`;

                    cardDiv.innerHTML = avatarHtml + nameHtml;

                    cardDiv.addEventListener('click', () => showClassmateDetailModal(classmate));
                    classmateCardsGrid.appendChild(cardDiv);
                });
            }

            function showClassmateDetailModal(classmate) {
                if (!classmateDetailModal || !classmateDetailContentBody) return;

                // ç¡®ä¿ avatarInitials è‡³å°‘æœ‰ä¸€ä¸ªå­—ç¬¦ï¼Œå¦‚æœå§“åä¸ºç©ºæˆ–æ— æ³•æå–ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼
                const initials = classmate.avatarInitials || (classmate.name ? classmate.name.substring(0, 1).toUpperCase() : '?');

                classmateDetailContentBody.innerHTML = `
                    <div class="avatar-large bg-blue-600">
                        ${initials}
                    </div>
                    <h3>${classmate.name}</h3>
                    <p><strong>å­¦å·ï¼š</strong>${classmate.studentId}</p>
                    <p><strong>ç”Ÿæ—¥ï¼š</strong>${classmate.birthday}</p> <!-- æ–°å¢çš„ç”Ÿæ—¥æ˜¾ç¤º -->
                    <p><strong>æ‰‹æœºå·ï¼š</strong>${classmate.phone}</p>
                    <p><strong>é‚®ç®±ï¼š</strong>${classmate.email}</p>
                    <p class="quote">"${classmate.message}"</p>
                `;
                classmateDetailModal.classList.add('open');
            }

            // ... (å…¶ä»–ä»£ç ä¿æŒä¸å˜)


            function showClassmateDetailModal(classmate) {
                if (!classmateDetailModal || !classmateDetailContentBody) return;

                classmateDetailContentBody.innerHTML = `
                    <div class="avatar-large bg-blue-600">
                        ${classmate.avatarInitials}
                    </div>
                    <h3>${classmate.name}</h3>
                    <p><strong>å­¦å·ï¼š</strong>${classmate.studentId}</p>
                    <p><strong>æ‰‹æœºå·ï¼š</strong>${classmate.phone}</p>
                    <p><strong>é‚®ç®±ï¼š</strong>${classmate.email}</p>
                    <p class="quote">"${classmate.message}"</p>
                `;
                classmateDetailModal.classList.add('open');
            }

            function closeClassmateDetailModal() {
                if (classmateDetailModal) {
                    classmateDetailModal.classList.remove('open');
                }
            }

            if (classmateCardsGrid && classmateDetailModal && closeClassmateDetailModalButton) {
                populateClassmateCards();

                closeClassmateDetailModalButton.addEventListener('click', closeClassmateDetailModal);
                window.addEventListener('click', (event) => {
                    if (event.target == classmateDetailModal) {
                        closeClassmateDetailModal();
                    }
                });
            } else {
                console.error("Classmate section elements not found.");
            }
            
            const danmakuContainer = document.getElementById('danmakuContainer');
            const danmakuInput = document.getElementById('danmakuInput');
            const danmakuSendButton = document.getElementById('danmakuSendButton');
            const danmakuRecordsContainer = document.getElementById('danmakuRecords');
            const danmakuRecordsError = document.getElementById('danmakuRecordsError');

            const JSONBIN_API_KEY = "$2a$10$xLxeYmOT4sgeNhR9TB7rFe.SrN73KzvX1akvgdam30AI07ksJ1xAm";
            const JSONBIN_BIN_ID  = "683f30358a456b7966a91837";
            const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`;

            const danmakuColors = ['text-red-400', 'text-blue-300', 'text-green-300', 'text-purple-300', 'text-yellow-300', 'text-pink-300', 'text-teal-300', 'text-white'];

            let danmakuPool = [];
            let danmakuInterval = null;

            async function getIpInfo() {
                try {
                    const response = await fetch('https://ipinfo.io/json');
                    const data = await response.json();
                    return `${data.city || data.region || 'æœªçŸ¥åŸå¸‚'}, ${data.country || 'æœªçŸ¥å›½å®¶'}`;
                } catch (error) {
                    console.error("Error fetching IP info:", error);
                    return "æœªçŸ¥åœ°ç‚¹";
                }
            }

            function startDanmakuLoop() {
                if (danmakuInterval) {
                    clearInterval(danmakuInterval);
                }

                danmakuInterval = setInterval(() => {
                    if (danmakuPool.length === 0) {
                        return;
                    }

                    const randomIndex = Math.floor(Math.random() * danmakuPool.length);
                    const danmaku = danmakuPool[randomIndex];

                    const danmakuItem = document.createElement('div');
                    danmakuItem.classList.add('danmaku-item');
                    danmakuItem.classList.add(danmakuColors[Math.floor(Math.random() * danmakuColors.length)]);
                    danmakuItem.textContent = danmaku.text;
                    
                    const containerHeight = danmakuContainer.clientHeight;
                    const itemHeight = 30;
                    const randomTop = Math.random() * (containerHeight - itemHeight);
                    danmakuItem.style.top = `${randomTop}px`;

                    const duration = Math.random() * 7 + 8;
                    danmakuItem.style.animation = `moveRight ${duration}s linear forwards`;

                    danmakuContainer.appendChild(danmakuItem);

                    danmakuItem.addEventListener('animationend', () => {
                        danmakuItem.remove();
                    });

                }, 1000);
            }

            async function fetchDanmakuRecords() {
                danmakuRecordsContainer.innerHTML = '<p class="text-gray-500 text-sm text-center">åŠ è½½å†å²å¼¹å¹•...</p>';
                danmakuRecordsError.textContent = '';
                try {
                    const response = await fetch(JSONBIN_URL + '/latest', {
                        headers: {
                            'X-Master-Key': JSONBIN_API_KEY,
                            'X-Bin-Meta': 'false'
                        }
                    });
                    if (!response.ok) {
                        throw new Error(`Failed to fetch danmaku records: ${response.statusText}`);
                    }
                    let records = await response.json();
                    
                    danmakuRecordsContainer.innerHTML = '';
                    danmakuPool = [];

                    if (records && records.length > 0) {
                        records.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); 

                        records.forEach(record => {
                            const recordHtml = `
                                <div class="danmaku-record-item">
                                    <p class="text-gray-800 text-base">${record.text}</p>
                                    <p class="info">${record.location} | ${new Date(record.timestamp).toLocaleString()}</p>
                                </div>
                            `;
                            danmakuRecordsContainer.innerHTML += recordHtml;
                            danmakuPool.push(record);
                        });
                        startDanmakuLoop();
                    } else {
                        danmakuRecordsContainer.innerHTML = '<p class="text-gray-500 text-sm text-center">æš‚æ— å†å²å¼¹å¹•ã€‚</p>';
                    }
                } catch (error) {
                    console.error("Error fetching danmaku records:", error);
                    danmakuRecordsContainer.innerHTML = '<p class="text-red-500 text-sm text-center">åŠ è½½å†å²å¼¹å¹•å¤±è´¥ã€‚</p>';
                    danmakuRecordsError.textContent = `åŠ è½½å†å²å¼¹å¹•å¤±è´¥: ${error.message}`;
                }
            }

            async function sendDanmaku() {
                const text = danmakuInput.value.trim();
                if (!text) return;

                danmakuInput.value = '';
                danmakuRecordsError.textContent = '';

                const location = await getIpInfo();
                const timestamp = new Date().toISOString();

                const newDanmaku = { text, location, timestamp };

                try {
                    const response = await fetch(JSONBIN_URL + '/latest', {
                        headers: {
                            'X-Master-Key': JSONBIN_API_KEY,
                            'X-Bin-Meta': 'false'
                        }
                    });
                    let currentRecords = [];
                    if (response.ok) {
                        currentRecords = await response.json();
                    } else if (response.status === 404) {
                        currentRecords = [];
                    } else {
                        throw new Error(`Failed to read current records: ${response.statusText}`);
                    }

                    currentRecords.push(newDanmaku);

                    const updateResponse = await fetch(JSONBIN_URL, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': JSONBIN_API_KEY
                        },
                        body: JSON.stringify(currentRecords)
                    });

                    if (!updateResponse.ok) {
                        throw new Error(`Failed to update danmaku records: ${updateResponse.statusText}`);
                    }
                    
                    danmakuPool.push(newDanmaku);
                    
                    fetchDanmakuRecords();

                } catch (error) {
                    console.error("Error saving danmaku:", error);
                    danmakuRecordsError.textContent = `ä¿å­˜å¼¹å¹•å¤±è´¥: ${error.message}`;
                }
            }

            if (danmakuSendButton && danmakuInput && danmakuContainer && danmakuRecordsContainer) {
                fetchDanmakuRecords();
                danmakuSendButton.addEventListener('click', sendDanmaku);
                danmakuInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendDanmaku();
                    }
                });
            } else {
                console.error("Danmaku UI elements not found.");
            }
            
            const galleryGrid = document.getElementById('photo-gallery-grid');
            const changeButton = document.getElementById('change-photos-button');
            let allPhotoUrls = [];
            let shuffledPhotoUrls = [];
            let currentPhotoIndex = 0;
            let msnry;

            // Lightbox elements
            const imageModalOverlay = document.getElementById('imageModalOverlay');
            const closeImageModalButton = document.getElementById('closeImageModalButton');
            const modalImage = document.getElementById('modalImage');

            // Function to get dynamic batch size
            function getBatchSize() {
                return window.innerWidth <= 768 ? 8 : 10; // Mobile: 8, Desktop: 10
            }

            // Function to open lightbox
            function openImageModal(imageUrl) {
                if (imageModalOverlay && modalImage) {
                    modalImage.src = imageUrl;
                    imageModalOverlay.classList.add('open');
                    document.body.style.overflow = 'hidden'; // Prevent body scroll
                }
            }

            // Function to close lightbox
            function closeImageModal() {
                if (imageModalOverlay) {
                    imageModalOverlay.classList.remove('open');
                    // Re-enable body scroll after transition ends
                    imageModalOverlay.addEventListener('transitionend', function handler() {
                        document.body.style.overflow = '';
                        imageModalOverlay.removeEventListener('transitionend', handler);
                    }, { once: true });
                }
            }

            // Lightbox event listeners
            if (closeImageModalButton) {
                closeImageModalButton.addEventListener('click', closeImageModal);
            }
            if (imageModalOverlay) {
                imageModalOverlay.addEventListener('click', (event) => {
                    // Only close if clicking on the overlay itself, not the image
                    if (event.target === imageModalOverlay) {
                        closeImageModal();
                    }
                });
            }
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && imageModalOverlay && imageModalOverlay.classList.contains('open')) {
                    closeImageModal();
                }
            });


            // åˆå§‹åŒ– Masonry
            if (galleryGrid) {
                // ç§»é™¤åˆå§‹åŠ è½½ä¿¡æ¯
                galleryGrid.querySelector('p')?.remove(); 
                // æ·»åŠ  grid-sizer ç”¨äº Masonry è®¡ç®—åˆ—å®½
                const gridSizer = document.createElement('div');
                gridSizer.className = 'grid-sizer';
                galleryGrid.appendChild(gridSizer);

                msnry = new Masonry(galleryGrid, {
                    itemSelector: '.grid-item',
                    columnWidth: '.grid-sizer',
                    gutter: 10,
                    percentPosition: true,
                    transitionDuration: '0.4s' // Masonry è‡ªèº«å¸ƒå±€åŠ¨ç”»æ—¶é—´
                });
            }

            // ä» 8ban.txt æ–‡ä»¶åŠ è½½æ‰€æœ‰å›¾ç‰‡é“¾æ¥
            async function loadAllPhotos() {
                if (!galleryGrid) return;
                try {
                    const response = await fetch('https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/8ban.txt');
                    if (!response.ok) {
                        throw new Error(`æ— æ³•ä» GitHub åŠ è½½ 8ban.txt (çŠ¶æ€: ${response.status})`);
                    }
                    const textContent = await response.text();
                    allPhotoUrls = textContent.split('\n').filter(line => line.trim() !== '').map(line => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(line, 'text/html');
                        const imgElement = doc.querySelector('img');
                        return imgElement ? imgElement.src : null;
                    }).filter(url => url !== null);

                    if (allPhotoUrls.length > 0) {
                        shuffleAndResetPhotos();
                        displayNextBatchPhotos();
                    } else {
                        galleryGrid.innerHTML = '<p class="col-span-full text-center text-red-500 py-8">ç…§ç‰‡åˆ—è¡¨ä¸ºç©ºï¼Œè¯·æ£€æŸ¥ 8ban.txt æ–‡ä»¶å†…å®¹ã€‚</p>';
                    }

                } catch (error) {
                    console.error('åŠ è½½ç…§ç‰‡å¤±è´¥:', error);
                    galleryGrid.innerHTML = `<p class="col-span-full text-center text-red-500 py-8">åŠ è½½ç…§ç‰‡å¤±è´¥: ${error.message}</p>`;
                }
            }

            // æ‰“ä¹±å›¾ç‰‡é¡ºåºå¹¶é‡ç½®ç´¢å¼•
            function shuffleAndResetPhotos() {
                shuffledPhotoUrls = [...allPhotoUrls];
                for (let i = shuffledPhotoUrls.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffledPhotoUrls[i], shuffledPhotoUrls[j]] = [shuffledPhotoUrls[j], shuffledPhotoUrls[i]];
                }
                currentPhotoIndex = 0;
            }

            // æ˜¾ç¤ºä¸‹ä¸€æ‰¹ç…§ç‰‡
            function displayNextBatchPhotos() {
                if (!msnry || shuffledPhotoUrls.length === 0) return;

                const batchSize = getBatchSize(); // è·å–åŠ¨æ€æ‰¹æ¬¡å¤§å°
                const photosToAppend = shuffledPhotoUrls.slice(currentPhotoIndex, currentPhotoIndex + batchSize);

                if (photosToAppend.length === 0) {
                    if (changeButton) {
                        changeButton.textContent = 'å·²æ˜¾ç¤ºæ‰€æœ‰ç…§ç‰‡ï¼Œç‚¹å‡»é‡æ–°å¼€å§‹ï¼';
                        changeButton.classList.add('bg-gray-500', 'hover:bg-gray-600');
                        changeButton.classList.remove('bg-indigo-500', 'hover:bg-indigo-600');
                    }
                    return;
                }

                const newItems = [];
                photosToAppend.forEach(imageUrl => {
                    const wrapperDiv = document.createElement('div');
                    wrapperDiv.className = 'grid-item rounded-lg shadow-md card-hover';
                    
                    const img = document.createElement('img');
                    img.src = imageUrl;
                    img.alt = 'ç­çº§ç…§ç‰‡';
                    img.className = 'w-full h-auto object-cover rounded-lg';

                    wrapperDiv.appendChild(img);
                    galleryGrid.appendChild(wrapperDiv);

                    newItems.push(wrapperDiv);

                    // å›¾ç‰‡åŠ è½½å®Œæˆæˆ–å¤±è´¥æ—¶ï¼Œè§¦å‘å›¾ç‰‡æ¸å…¥åŠ¨ç”»
                    img.onload = () => {
                        img.classList.add('loaded');
                    };
                    img.onerror = () => {
                        img.alt = 'å›¾ç‰‡åŠ è½½å¤±è´¥';
                        img.src = 'data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%24%2024%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22M21%2015V19C21%2019.5304%2020.7893%2020.0391%2020.4142%2020.4142C20.0391%2020.7893%2019.5304%2021%2019%2021H5C4.46957%2021%203.96086%2020.7893%203.58579%2020.4142C3.21071%2020.0391%203%2019.5304%203%2019V5C3%204.46957%203.21071%203.96086%203.58579%203.58579C3.96086%203.21071%204.46957%203%205%203H11%22%20stroke%3D%22%239CA3AF%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%2F%3E%3Cpath%20d%3D%22M14%2010L21%203%22%20stroke%3D%22%239CA3AF%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%2F%3E%3Cpath%20d%3D%22M15%203H21V9%22%20stroke%3D%22%239CA3AF%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%2F%3E%3Ccircle%20cx%3D%228.5%22%20cy%3D%228.5%22%20r%3D%222.5%22%20stroke%3D%22%239CA3AF%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%2F%3E%3C%2Fsvg%3E';
                        img.classList.add('loaded');
                    };

                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ï¼Œæ‰“å¼€ Lightbox
                    img.addEventListener('click', () => openImageModal(imageUrl));
                });

                currentPhotoIndex += photosToAppend.length;

                // ä½¿ç”¨ imagesLoaded ç¡®ä¿æ‰€æœ‰å›¾ç‰‡åŠ è½½å®Œæˆåå†æ›´æ–° Masonry å¸ƒå±€
                imagesLoaded(newItems, function() {
                    msnry.appended(newItems);
                    // Masonry å¸ƒå±€å®Œæˆåï¼Œè§¦å‘ grid-item çš„æ¸å…¥åŠ¨ç”»ï¼Œå¹¶æ·»åŠ é”™æ—¶å»¶è¿Ÿ
                    newItems.forEach((item, index) => {
                        setTimeout(() => {
                            item.classList.add('masonry-fade-in');
                        }, index * 80); // æ¯ä¸ªé¡¹ç›®å»¶è¿Ÿ 80ms
                    });
                });

                // æ›´æ–°æŒ‰é’®æ–‡æœ¬å’Œæ ·å¼
                if (changeButton) {
                    if (currentPhotoIndex < shuffledPhotoUrls.length) {
                        changeButton.textContent = 'å†æ¥ä¸€æ‰¹ï¼';
                        changeButton.classList.remove('bg-gray-500', 'hover:bg-gray-600');
                        changeButton.classList.add('bg-indigo-500', 'hover:bg-indigo-600');
                    } else {
                        changeButton.textContent = 'å·²æ˜¾ç¤ºæ‰€æœ‰ç…§ç‰‡ï¼Œç‚¹å‡»é‡æ–°å¼€å§‹ï¼';
                        changeButton.classList.add('bg-gray-500', 'hover:bg-gray-600');
                        changeButton.classList.remove('bg-indigo-500', 'hover:bg-indigo-600');
                    }
                }
            }

            // é¡µé¢åŠ è½½æ—¶æ‰§è¡ŒåŠ è½½
            if (galleryGrid) {
                loadAllPhotos();
            }
            
            // ç»™â€œå†æ¥ä¸€æ‰¹ï¼â€æŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶
            if (changeButton) {
                changeButton.addEventListener('click', () => {
                    if (currentPhotoIndex >= shuffledPhotoUrls.length) {
                        // å¦‚æœæ‰€æœ‰ç…§ç‰‡éƒ½å·²æ˜¾ç¤ºï¼Œåˆ™æ¸…ç©ºç”»å»Šï¼Œé‡æ–°æ‰“ä¹±å¹¶åŠ è½½ç¬¬ä¸€æ‰¹
                        msnry.remove(msnry.getItemElements());
                        msnry.layout();
                        shuffleAndResetPhotos();
                        displayNextBatchPhotos();
                    } else {
                        displayNextBatchPhotos();
                    }
                });
            } else {
                console.error("Change photos button not found!");
            }

            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                setTimeout(() => {
                    loadingOverlay.classList.add('fade-out');
                    loadingOverlay.addEventListener('transitionend', () => {
                        loadingOverlay.remove();
                    }, { once: true });
                }, 500);
            }
        });
    </script>
</body>
</html>
