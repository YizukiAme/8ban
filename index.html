<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>八贤渡 · 敬业舟</title>
    <link href="./output.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="./js/marked.min.js"></script>
    <script src="./js/masonry.pkgd.min.js"></script>
    <script src="./js/imagesloaded.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@700&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://8ban-1311723413.cos.ap-shanghai.myqcloud.com">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://ipinfo.io">
    <link rel="preconnect" href="https://api.jsonbin.io">
    <link rel="preconnect" href="https://api.siliconflow.cn">
    <link rel="preconnect" href="https://8ban.vercel.app/"> 
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <style>
        .classmate-card-initial {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        #classmates-area.fade-in .classmate-card-initial {
            opacity: 1;
            transform: translateY(0);
        }

        .classmate-detail-content .info-line .label {
            display: flex; /* 让标签和图标可以在一行内对齐 */
            align-items: center; /* 垂直居中对齐 */
            width: 95px; /* 稍微加宽一点，为图标留出空间 */
            color: #374151; /* 稍微柔和一点的黑色 (gray-700) */
        }

        .classmate-detail-content .info-line .label i {
            color: #6366f1; /* 使用主题色 (indigo-500) */
            width: 24px; /* 图标的宽度 */
            text-align: center; /* 图标居中 */
            margin-right: 10px; /* 图标和文字之间的间距 */
            font-size: 0.9rem; /* 调整图标大小 */
        }

        .classmate-detail-content .info-line {
            display: flex;
            margin-bottom: 0.75rem; /* 12px, 保持行间距 */
            font-size: 1rem; /* 16px */
            line-height: 1.6;
        }

        .classmate-detail-content .info-line .data {
            color: #4b5563;
            /* 对于可能很长的邮箱，允许在任意位置断开，防止溢出 */
            word-break: break-all;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Noto Sans SC', sans-serif;
            color: #2d3748;
            scroll-behavior: smooth; 
            background-color: #1a202c;
        }

        #main-content-wrapper {
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            position: relative;
            z-index: 1;
            background-color: transparent;
        }

        .glassmorphism {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        .card-hover {
            transition: all 0.3s ease;
        }
        /* 悬停效果：微微悬浮放大 */
        .card-hover:hover {
            transform: translateY(-5px) scale(1.02); /* 结合悬浮和放大 */
            box-shadow: 0 12px 28px 0 rgba(31, 38, 135, 0.2);
        }
        .enhanced-card-hover {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .enhanced-card-hover:hover {
            transform: scale(1.03) translateY(-3px);
            box-shadow: 0 15px 30px -5px rgba(59, 130, 246, 0.25), 0 8px 10px -6px rgba(59, 130, 246, 0.2);
        }

        .highlight-text {
            position: relative;
            display: inline-block;
        }
        .highlight-text::after {
            content: none;
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 10px;
            background-color: rgba(99, 102, 241, 0.2);
            z-index: -1;
        }

        .mobile-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            padding: 1rem;
            margin: 0.5rem;
            border-radius: 0.75rem;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            transform-origin: top;
            transform: scaleY(0);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            z-index: 100;
        }
        .mobile-menu.active {
            transform: scaleY(1);
            opacity: 1;
        }

        .tools-grid-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.7s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.5s ease-out, transform 0.5s ease-out;
            opacity: 0;
            transform: translateY(20px);
        }
        .tools-grid-container.active {
            max-height: 2000px;
            opacity: 1;
            transform: translateY(0);
        }

        .chat-bubble {
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            margin-bottom: 0.5rem;
            max-width: 75%;
            word-wrap: break-word;
        }
        .chat-bubble-user {
            background-color: #3b82f6;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
        }
        .chat-bubble-ai {
            background-color: #e5e7eb;
            color: #1f2937;
            margin-right: auto;
            border-bottom-left-radius: 0.25rem;
        }
        .chat-bubble-ai p:first-child { margin-top: 0; }
        .chat-bubble-ai p:last-child { margin-bottom: 0; }
        .chat-bubble-ai pre {
            background-color: #2d3748;
            color: #e2e8f0;
            padding: 0.75rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }
        .chat-bubble-ai code {
            background-color: #cbd5e0;
            padding: 0.2em 0.4em;
            border-radius: 0.25rem;
            font-size: 0.875em;
        }
        .chat-bubble-ai ul, .chat-bubble-ai ol {
            margin-left: 1.25rem;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            list-style-type: disc;
        }
        .chat-bubble-ai ol {
            list-style-type: decimal;
        }
        #chatMessages {
            scroll-behavior: smooth;
        }

        @keyframes moveRight {
            0% { transform: translateX(-100%); opacity: 1;}
            90% { opacity: 1; }
            100% { transform: translateX(100vw); opacity: 0; }
        }
        .danmaku-item {
            position: absolute;
            white-space: nowrap;
            font-weight: 500;
            padding: 5px 10px;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .timeline-dot {
            width: 12px;
            height: 12px;
            background-color: #60a5fa;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 3px #60a5fa;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(8px);
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .modal.open {
            display: flex;
            opacity: 1;
        }
        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative;
            width: 90%;
            max-width: 1500px;
            height: 90%;
            max-height: 1200px;
            display: flex;
            flex-direction: column;
            transform: translateY(20px);
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .modal.open .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            color: #aaa;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        .modal-close:hover,
        .modal-close:focus {
            color: #333;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 1rem;
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            background-color: #f8fafc;
        }
        .modal-chat-input-area {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding-top: 0.5rem;
        }

        .danmaku-record-item {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }
        .danmaku-record-item p {
            margin: 0;
            line-height: 1.4;
        }
        .danmaku-record-item .info {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.5rem;
            text-align: right;
        }

        #fixed-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            filter: brightness(0.6) saturate(1.2);
            transition: background-image 0.5s ease-in-out;
            background-color: #1a202c;
            
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            transform: translateZ(0);
            will-change: transform;
            -webkit-perspective: 1000;
            perspective: 1000;
            -webkit-transform-style: preserve-3d;
            transform-style: preserve-3d;
        }

        #hero-section {
            position: relative;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
            overflow: hidden;
        }
        
        #hero-content {
            z-index: 10;
            padding: 1rem;
            max-width: 900px;
            margin: 0 auto;
            text-shadow: 0 2px 8px rgba(0,0,0,0.4);
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInSlideUp 1.2s ease-out forwards 0.5s;
        }

        @keyframes fadeInSlideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #hero-section h1 {
            font-size: 4.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            line-height: 1.2;
            color: white;
            text-align: center;
            text-shadow: 0 4px 12px rgba(0,0,0,0.6), 0 0 20px rgba(0,0,0,0.3);
            opacity: 0.8;
        }

        #hero-section p {
            font-size: 1.5rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 2rem;
            text-align: center;
        }

        .scroll-down-arrow {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 2rem;
            animation: bounce 2s infinite;
            cursor: pointer;
            z-index: 10;
            text-shadow: 0 2px 8px rgba(0,0,0,0.4);
            opacity: 0;
            animation: fadeInBounce 2s infinite forwards 1.5s;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateX(-50%) translateY(0);
            }
            40% {
                transform: translateX(-50%) translateY(-10px);
            }
            60% {
                transform: translateX(-50%) translateY(-5px);
            }
        }
        @keyframes fadeInBounce {
            0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
            50% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 1; }
        }

        .nav-initial {
            background: transparent !important;
            backdrop-filter: none !important;
            box-shadow: none !important;
            transition: all 0.5s ease-out, opacity 0.5s ease-out;
            margin-bottom: 0 !important;
            opacity: 0;
            pointer-events: none;
        }

        .nav-scrolled {
            background: rgba(255, 255, 255, 0.7) !important;
            backdrop-filter: blur(10px) !important;
            border-radius: 16px !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15) !important;
            transition: all 0.5s ease-out, opacity 0.5s ease-out;
            margin-bottom: 0 !important;
            opacity: 1 !important;
            pointer-events: auto !important;
        }

        .content-section {
            opacity: 0;
            transform: translateY(50px);
            transition: opacity 0.8s ease-out, transform 0.8s ease-out;
        }
        .content-section.fade-in {
            opacity: 1;
            transform: translateY(0);
        }

        #hero-content a.bg-blue-500,
        #hero-content a.bg-indigo-500,
        #hero-content a.bg-purple-500,
        #hero-content a.bg-green-500,
        #hero-content a.bg-orange-500 {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 16px 0 rgba(31, 38, 135, 0.1);
            color: white;
            transition: all 0.3s ease;
        }

        #hero-content a.bg-blue-500:hover,
        #hero-content a.bg-indigo-500:hover,
        #hero-content a.bg-purple-500:hover,
        #hero-content a.bg-green-500:hover,
        #hero-content a.bg-orange-500:hover {
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 24px 0 rgba(31, 38, 135, 0.2);
            transform: translateY(-3px);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .classmate-card {
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .classmate-card .avatar {
            width: 80px;
            height: 80px;
            color: white;
            
            /* --- 字体与居中最终优化 --- */
            font-family: 'Dengxian', 'Microsoft YaHei', sans-serif; /* 1. 更换为更可靠、现代的"等线"字体 */
            font-size: 3rem; /* 保持大气字号 (48px) */
            /* 2. 移除 line-height 和 padding-top，完全信赖 Flexbox 的 align-items: center 来实现完美居中 */

            /* --- 以下保持不变，它们是 Flexbox 居中的核心 --- */
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            
            /* --- 其他样式保持不变 --- */
            border-radius: 9999px;
            margin-bottom: 0.5rem;
            flex-shrink: 0;
            user-select: none;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.15), var(--cat-shadow, 0 5px 10px rgba(0,0,0,0.1));
            border: 3px solid rgba(255, 255, 255, 0.6);
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }

        .classmate-detail-content {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 15px 40px rgba(0,0,0,0.25);
            width: 90%;
            max-width: 600px;
            position: relative;
            display: flex;
            flex-direction: column;
            animation: fadeInScale 0.3s ease-out;
        }
        .classmate-detail-content .avatar-large {
            width: 120px;
            height: 120px;
            background-color: #6366f1;
            color: white;
            font-size: 3.5rem;
            font-weight: bold;
            border-radius: 9999px;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }
        .classmate-detail-content h3 {
            font-size: 2.25rem;
            font-weight: bold;
            color: #1f2937;
            text-align: center;
            margin-bottom: 0.75rem;
        }
        .classmate-detail-content p {
            color: #4b5563;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        .classmate-detail-content p strong {
            color: #1f2937;
        }
        .classmate-detail-content .quote {
            font-style: italic;
            border-left: 4px solid #a78bfa;
            padding-left: 1rem;
            margin-top: 1.5rem;
            color: #6b7280;
            font-size: 0.95rem;
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal.open .classmate-detail-content {
            animation: fadeInScale 0.3s ease-out forwards;
        }

        #loading-overlay {
            transition: opacity 0.5s ease-out;
        }
        #loading-overlay.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        /* Masonry 瀑布流布局相关样式 */
        #photo-gallery-grid {
            margin-bottom: 1rem;
        }

        .grid-sizer, .grid-item {
            width: calc(20% - 10px); /* 5列，10px 间距 */
            margin-bottom: 10px; /* 垂直间距 */
            box-sizing: border-box;
        }

        /* 响应式调整列数 */
        @media (max-width: 1023px) { /* lg breakpoint */
            .grid-sizer, .grid-item {
                width: calc(33.333% - 10px); /* 3列 */
            }
        }
        @media (max-width: 639px) { /* sm breakpoint */
            .grid-sizer, .grid-item {
                width: calc(50% - 10px); /* 2列 */
            }
        }
        @media (max-width: 480px) { /* Extra small screens */
            .grid-sizer, .grid-item {
                width: calc(100% - 10px); /* 1列 */
            }
        }

        .grid-item {
            background-color: #e2e8f0; /* 占位符背景色 (gray-200) */
            border-radius: 0.5rem;
            overflow: hidden; /* 确保图片圆角和阴影效果正确 */
            position: relative;
            /* 初始状态：透明并略微向下，用于 Masonry 布局后的渐入动画 */
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        /* Masonry 布局完成后触发的动画 */
        .grid-item.masonry-fade-in {
            opacity: 1;
            transform: translateY(0);
        }

        .grid-item img {
            display: block;
            width: 100%;
            height: auto;
            border-radius: 0.5rem;
            opacity: 0; /* 图片初始隐藏 */
            transition: opacity 0.5s ease-in-out; /* 图片渐入动画 */
            cursor: pointer; /* 指示可点击 */
        }

        /* 图片加载完成后显示 */
        .grid-item img.loaded {
            opacity: 1;
        }

        /* Lightbox 模态框样式 */
        .image-modal-overlay {
            display: none; /* 初始隐藏 */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8); /* 半透明黑色背景 */
            backdrop-filter: blur(10px); /* 模糊效果 */
            z-index: 1000; /* 确保在最上层 */
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, backdrop-filter 0.3s ease-in-out;
        }

        .image-modal-overlay.open {
            display: flex;
            opacity: 1;
        }

        .image-modal-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
            display: flex;
            justify-content: center;
            align-items: center;
            transform: scale(0.8); /* 初始缩小，用于放大动画 */
            opacity: 0; /* 初始透明，用于渐入动画 */
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.3s ease-out;
        }

        .image-modal-overlay.open .image-modal-content {
            transform: scale(1);
            opacity: 1;
        }

        .image-modal-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; /* 确保图片完整显示 */
            border-radius: 0.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); /* 图片阴影 */
        }

        .image-modal-close {
            position: absolute;
            top: -2rem; /* 调整位置，使其在图片上方 */
            right: -2rem; /* 调整位置 */
            color: white;
            font-size: 2.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
            text-shadow: 0 0 5px rgba(0,0,0,0.5); /* 增加阴影，使其在深色背景下更清晰 */
        }
        .image-modal-close:hover {
            color: #ccc;
        }
        /* 移动端调整关闭按钮位置 */
        @media (max-width: 768px) {
            .image-modal-close {
                top: 0.5rem;
                right: 0.5rem;
                font-size: 2rem;
            }
        }

        /* 默认样式：适用于桌面端及所有屏幕，保持一行显示 */
        .highlight-text .part-one,
        .highlight-text .separator,
        .highlight-text .part-two {
            display: inline; /* 默认行内显示 */
        }

        /* 媒体查询：当屏幕宽度小于或等于某个阈值时（例如768px，通常作为移动端断点） */
        @media (max-width: 768px) {
            .highlight-text .separator {
                display: none; /* 隐藏分隔符 */
            }

            .highlight-text .part-two {
                display: block; /* 将第二部分设置为块级元素，使其换行 */
                /* 可以根据需要调整外边距，例如：margin-top: 0.2em; */
            }
            /* 如果需要更精细的控制，例如调整行高或字体大小，也可以在这里添加 */
            .highlight-text {
                line-height: 1.2; /* 调整整体行高，使两行更紧凑 */
            }
        }

        /* START: Birthday Celebration Styles */
        .birthday-modal {
            display: none; /* 默认隐藏 */
            position: fixed;
            z-index: 2000; /* 确保在最顶层 */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(8px);
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
        }

        .birthday-modal.show {
            display: flex;
            opacity: 1;
        }

        .birthday-modal-content {
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            position: relative;
            width: 90%;
            max-width: 450px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 240, 245, 0.95) 100%); /* 淡雅的粉色渐变 */
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            transform: scale(0.9);
            opacity: 0;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease-out;
        }

        .birthday-modal.show .birthday-modal-content {
            transform: scale(1);
            opacity: 1;
        }

        /* 这是生日触发器的样式，它本身是不可见的 */
        #birthday-trigger {
            height: 1px;
            width: 100%;
        }
        
        /* START: Floating Birthday Hat Styles */
        #floating-birthday-hat {
            position: fixed;
            z-index: 1500;
            color: #f472b6;
            font-size: 60px; /* 保持字体大小 */
            text-shadow: 0 4px 12px rgba(0,0,0,0.3);
            cursor: grab;
            user-select: none;
            /* 确保元素有实际渲染尺寸 */
            width: 60px; /* 明确宽度 */
            height: 60px; /* 明确高度 */
            display: flex; /* 使用flexbox居中图标 */
            justify-content: center;
            align-items: center;
        }
        #floating-birthday-hat i {
            /* 确保图标本身能够撑开父元素 */
            display: block; /* 让i标签成为块级元素，更容易控制尺寸 */
            line-height: 1; /* 消除行高影响，确保垂直居中 */
            font-family: "Font Awesome 6 Free" !important; /* 强制使用 Font Awesome 字体 */
            font-weight: 900 !important; /* Font Awesome Solid 图标通常需要这个字重 */
        }
        
        #floating-birthday-hat.hidden {
            display: none; /* 确保这个类能彻底隐藏帽子 */
        }

        /* 新增一个隐藏类，确保初始状态是隐藏的 */
        #floating-birthday-hat.hidden {
            display: none;
        }

        #floating-birthday-hat.dragging {
            cursor: grabbing;
            /* transform: scale(1.15); */ /* 拖动时放大一点，将由JS控制 */
            /* transition: none; */ /* 拖动时禁用动画，将由JS控制 */
        }
        /* END: Floating Birthday Hat Styles */

        /* START: Floating Cat Styles */
        #floating-cat {
            /* Initial state: hidden and not fixed */
            display: none; /* Will be changed to flex when active */
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.2s ease-out;

            /* Common styles for both states */
            z-index: 1500;
            font-size: 60px;
            color: #f472b6;
            text-shadow: 0 4px 12px rgba(0,0,0,0.3);
            cursor: grab;
            user-select: none;
            width: 60px;
            height: 60px;
            justify-content: center; /* For flexbox centering */
            align-items: center; /* For flexbox centering */
        }

        #floating-cat.active {
            display: flex; /* Make it visible */
            opacity: 1;
            position: fixed; /* Make it fixed when active */
            /* Position will be controlled by JS for random movement */
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; transform: scale(0.5); }
        }

        .fish-trail {
            position: fixed;
            font-size: 20px; /* Smaller fish */
            color: #60a5fa; /* Blue fish */
            opacity: 0; /* Start hidden */
            pointer-events: none; /* Do not block clicks */
            animation: fadeOut 1.5s forwards; /* Fade out over 1.5 seconds */
            z-index: 1499; /* Below the cat */
            text-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        #floating-cat i {
            display: block;
            line-height: 1;
            font-family: "Font Awesome 6 Free" !important;
            font-weight: 900 !important;
        }

        #floating-cat.dragging {
            cursor: grabbing;
            transform: scale(1.15);
            transition: none; /* Disable transition during drag */
        }
        /* START: Cat Idle Animation */
        @keyframes cat-idle-breathe {
            0%, 100% { transform: translateY(0) scaleX(var(--cat-direction, 1)); }
            50% { transform: translateY(-3px) scaleX(var(--cat-direction, 1)); }
        }
        #floating-cat.ai-idle {
            animation: cat-idle-breathe 2s ease-in-out infinite;
        }
        /* END: Cat Idle Animation */

        /* START: Cat Walk Animation */
        @keyframes cat-walk-animation {
            0% { transform: translateY(0px) translateX(0px) skewX(0deg) scaleX(var(--cat-direction, 1)); }
            25% { transform: translateY(-2px) translateX(1px) skewX(2deg) scaleX(var(--cat-direction, 1)); }
            50% { transform: translateY(0px) translateX(0px) skewX(0deg) scaleX(var(--cat-direction, 1)); }
            75% { transform: translateY(-2px) translateX(-1px) skewX(-2deg) scaleX(var(--cat-direction, 1)); }
            100% { transform: translateY(0px) translateX(0px) skewX(0deg) scaleX(var(--cat-direction, 1)); }
        }
        #floating-cat.ai-walking {
            animation: cat-walk-animation 0.8s ease-in-out infinite;
        }
        /* END: Cat Walk Animation */

        /* END: Floating Cat Styles */

        /* START: Question Mark Styles */
        .question-mark {
            position: fixed;
            font-size: 30px;
            color: #60a5fa; /* blue-400 */
            opacity: 0;
            pointer-events: none;
            z-index: 1501;
            user-select: none;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            animation: question-mark-fade-out 1.5s ease-out forwards;
        }

        @keyframes question-mark-fade-out {
            0% {
                transform: translateY(0) scale(0.8);
                opacity: 1;
            }
            100% {
                transform: translateY(-50px) scale(1.2);
                opacity: 0;
            }
        }
        /* END: Question Mark Styles */

        /* START: Angry Cat Explosion Styles */
        .angry-cat-face {
            position: fixed;
            font-size: 24px;
            color: #ef4444; /* red-500 */
            pointer-events: none;
            z-index: 1501; /* Above the cat */
            user-select: none;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            animation: angry-cat-fly-out 1.2s cubic-bezier(0.1, 0.8, 0.7, 1) forwards;
        }

        @keyframes angry-cat-fly-out {
            0% {
                transform: scale(0.5);
                opacity: 1;
            }
            100% {
                transform: scale(1.5) translate(var(--tx), var(--ty)) rotate(var(--rot));
                opacity: 0;
            }
        }
        /* END: Angry Cat Explosion Styles */
    </style>
    <script src="https://unpkg.com/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js"></script>
</head>
<body class="min-h-screen">

<!-- 
    Tailwind CSS Safelist (for dynamic classes)
    This is a "magic comment" to ensure Tailwind CSS includes these classes in the final build,
    even though they are generated dynamically in JavaScript.

    bg-indigo-500 bg-blue-500 bg-sky-500 
    bg-emerald-500 bg-amber-500 bg-rose-500 
    bg-purple-500 bg-teal-500 bg-orange-500
-->

    <div id="fixed-background"></div>

    <div id="loading-overlay" class="fixed inset-0 z-[2000] flex items-center justify-center bg-gray-900 transition-opacity duration-500 opacity-100">
        <div class="text-center text-white">
            <i class="fas fa-ship fa-spin text-6xl mb-4 text-blue-400"></i>
            <h2 class="text-2xl font-bold mb-2">八贤渡·敬业舟</h2>
            <p class="text-lg">推荐使用电脑访问...</p>
        </div>
    </div>

    <div id="top-of-page"></div>

    <div id="main-content-wrapper" style="height: 100%; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; position: relative; z-index: 1;">

        <nav class="sticky top-0 z-50 p-4 nav-initial" id="mainNav">
            <div class="container mx-auto flex items-center justify-between">
                <div class="text-xl font-bold">
                    <i class="fas fa-book mr-2"></i>八贤渡·敬业舟 - 202508 永久纪念页
                </div>
                <div class="hidden md:flex space-x-6">
                    <a href="#top-of-page" class="hover:text-blue-600 transition-colors">首页</a>
                    <a href="#memory-area" class="hover:text-blue-600 transition-colors">回忆</a>
                    <a href="#classmates-area" class="hover:text-blue-600 transition-colors">同学录</a>
                    <a href="#tool-area" class="hover:text-blue-600 transition-colors">工具</a>
                    <a href="#chatbot-area" class="hover:text-blue-600 transition-colors">Chat with 小八</a>
                    <a href="#message-area" class="hover:text-blue-600 transition-colors">留言</a>
                </div>
                <button class="md:hidden focus:outline-none" id="mobileMenuButton" aria-label="导航菜单">
                    <i class="fas fa-bars text-xl"></i>
                </button>

                <div class="mobile-menu md:hidden" id="mobileMenu">
                    <a href="#top-of-page" class="block py-2 px-3 text-gray-600 hover:text-blue-600 transition-colors rounded-md hover:bg-blue-50 flex items-center"><i class="fas fa-home mr-3 text-blue-500 w-5 text-center"></i>首页</a>
                    <a href="#memory-area" class="block py-2 px-3 text-gray-600 hover:text-blue-600 transition-colors rounded-md hover:bg-blue-50 flex items-center"><i class="fas fa-images mr-3 text-blue-500 w-5 text-center"></i>回忆</a>
                    <a href="#classmates-area" class="block py-2 px-3 text-gray-600 hover:text-blue-600 transition-colors rounded-md hover:bg-blue-50 flex items-center"><i class="fas fa-users mr-3 text-blue-500 w-5 text-center"></i>同学录</a>
                    <a href="#tool-area" class="block py-2 px-3 text-gray-600 hover:text-blue-600 transition-colors rounded-md hover:bg-blue-50 flex items-center"><i class="fas fa-tools mr-3 text-blue-500 w-5 text-center"></i>工具</a>
                    <a href="#chatbot-area" class="block py-2 px-3 text-gray-600 hover:text-blue-600 transition-colors rounded-md hover:bg-blue-50 flex items-center"><i class="fas fa-robot mr-3 text-blue-500 w-5 text-center"></i>Chat with 小八</a>
                    <a href="#message-area" class="block py-2 px-3 text-gray-600 hover:text-blue-600 transition-colors rounded-md hover:bg-blue-50 flex items-center"><i class="fas fa-comment-dots mr-3 text-blue-500 w-5 text-center"></i>留言</a>
                </div>
            </div>
        </nav>

        <div id="hero-section">
            <div id="hero-content" class="max-w-4xl mx-auto">
                <h1 class="text-4xl md:text-5xl font-bold mb-6">
                    <span class="highlight-text">
                        <span class="part-one">八贤渡</span>
                        <span class="separator"> · </span>
                        <span class="part-two">敬业舟</span>
                    </span>
                </h1>

                <p class="text-xl md:text-2xl mb-8">从此岸到彼岸，八班风采依旧</p>
                <div class="flex flex-wrap justify-center gap-4">
                    <a href="#memory-area" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition-colors text-lg font-medium shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                        <i class="fas fa-images mr-2"></i>回忆
                    </a>
                    <a href="#classmates-area" class="bg-indigo-500 hover:bg-indigo-600 text-white px-6 py-3 rounded-lg transition-colors text-lg font-medium shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                        <i class="fas fa-users mr-2"></i>同学录
                    </a>
                    <a href="#tool-area" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-lg transition-colors text-lg font-medium shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                        <i class="fas fa-tools mr-2"></i>工具
                    </a>
                    <a href="#chatbot-area" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg transition-colors text-lg font-medium shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                        <i class="fas fa-robot mr-2"></i>Chat with 小八
                    </a>
                    <a href="#message-area" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-lg transition-colors text-lg font-medium shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                        <i class="fas fa-comment-dots mr-2"></i>留言
                    </a>
                </div>
            </div>
            <i id="scrollDownArrow" class="fas fa-chevron-down scroll-down-arrow"></i>
        </div>

        <!-- START: Birthday Trigger Element -->
        <div id="birthday-trigger"></div>
        <!-- END: Birthday Trigger Element -->

        <section id="intro-content" class="container mx-auto py-16 px-4 md:px-8 content-section">
            <div class="max-w-4xl mx-auto text-center">
                <p class="text-xl md:text-2xl text-white mb-8" style="text-shadow: 0 2px 8px rgba(0,0,0,0.5);">
                    纪念敬业中学2025届八班，我们共同的青春岁月。
                </p>
            </div>
        </section>

        <section id="memory-area" class="container mx-auto py-12 px-4 md:px-8 content-section">
            <div class="glassmorphism p-6 md:p-8 mb-16">
                <h2 class="text-3xl font-bold mb-8 flex items-center text-gray-800">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white mr-4 shadow-lg">
                        <i class="fas fa-images text-xl"></i>
                    </div>
                    回忆
                </h2>

                <div class="text-center mb-8">
                    <div id="graduationTimer" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white p-4 rounded-lg shadow-md text-xl md:text-2xl font-bold">
                        加载中...
                    </div>
                    <p class="text-gray-600 text-sm mt-2">逝者如斯，不舍昼夜。</p>
                </div>

                <div>
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">浮光掠影</h3>
                    <!-- 瀑布流容器，Masonry 将在此处工作 -->
                    <div id="photo-gallery-grid" class="mb-4">
                        <div class="grid-sizer"></div> <!-- Masonry 用于计算列宽的辅助元素 -->
                        <p class="col-span-full text-center text-gray-500 py-8">正在加载照片...</p>
                    </div>

                    <div class="text-center flex flex-wrap justify-center gap-4 mt-4">
                        <button id="change-photos-button" class="bg-indigo-500 hover:bg-indigo-600 text-white px-6 py-2 rounded-lg transition-colors shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                            <i class="fas fa-sync-alt mr-2"></i>再来一批！
                        </button>
                        <button id="upload-photo-button" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition-colors shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                            <i class="fas fa-upload mr-2"></i>我要上传！
                        </button>
                        <a href="https://pan.quark.cn/s/7655460244b8" target="_blank" rel="noopener noreferrer" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg transition-colors shadow-md hover:shadow-lg transform hover:-translate-y-0.5 flex items-center">
                            <i class="fas fa-cloud-download-alt mr-2"></i>我全都要？
                        </a>
                    </div>
                </div>

                <div class="mb-8">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">
                        带制作
                        <span class="text-sm text-gray-500 font-normal ml-2">
                            (每次刷新都可能不一样喔~~)
                        </span>
                    </h3>
                    <div id="productionVideoContainer" class="bg-black rounded-lg aspect-video flex items-center justify-center relative overflow-hidden shadow-xl">
                        <p class="text-white text-lg">视频加载中...</p>
                    </div>
                </div>

                <div class="mb-8">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">小日常</h3>
                    <div id="dailyVideoContainer" class="bg-black rounded-lg aspect-video flex items-center justify-center relative overflow-hidden shadow-xl">
                        <p class="text-white text-lg">视频加载中...</p>
                    </div>
                </div>

                <div>
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">师说</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-gradient-to-br from-blue-50 to-indigo-100 p-5 rounded-xl shadow-lg card-hover">
                            <p class="text-gray-700 text-sm leading-relaxed">"祝愿八班的孩子们，能读到精彩的书，遇见有趣的人，走过最美的风景，成为最爱的自己。"</p>
                            <p class="text-right text-xs text-indigo-500 mt-2">- 董老师</p>
                        </div>
                        <div class="bg-gradient-to-br from-green-50 to-teal-100 p-5 rounded-xl shadow-lg card-hover">
                            <p class="text-gray-700 text-sm leading-relaxed">"三年很快，未来很长。祝你们怀揣梦想，披荆斩棘！毕业快乐，未来无限可能！"</p>
                            <p class="text-right text-xs text-teal-500 mt-2">- 朱老师</p>
                        </div>
                        <div class="bg-gradient-to-br from-purple-50 to-pink-100 p-5 rounded-xl shadow-lg card-hover">
                            <p class="text-gray-700 text-sm leading-relaxed">"毕业是一个人类虚构的节点。时间只是往前走，而意义属于我们自己。"</p>
                            <p class="text-right text-xs text-pink-500 mt-2">- 诸老师</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="classmates-area" class="container mx-auto py-12 px-4 md:px-8 content-section">
            <div class="glassmorphism p-6 md:p-8 mb-16">
                <h2 class="text-3xl font-bold mb-8 flex items-center text-gray-800">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-400 to-cyan-500 flex items-center justify-center text-white mr-4 shadow-lg">
                        <i class="fas fa-users text-xl"></i>
                    </div>
                    同学录
                </h2>
                <div id="classmateCardsGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
                </div>
            </div>
        </section>

        <section id="tool-area" class="container mx-auto py-12 px-4 md:px-8 content-section">
            <div class="glassmorphism p-6 md:p-8 mb-16">
                <h2 class="text-3xl font-bold mb-8 flex items-center text-gray-800">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-green-500 to-teal-600 flex items-center justify-center text-white mr-4 shadow-lg">
                        <i class="fas fa-tools text-xl"></i>
                    </div>
                    工具
                </h2>

                <div id="academicHelperCard" class="bg-gradient-to-br from-indigo-500 to-purple-600 p-6 rounded-xl shadow-xl cursor-pointer enhanced-card-hover mb-6 text-white flex items-center justify-between">
                    <div>
                        <h3 class="text-2xl font-semibold mb-2 flex items-center">
                            <i class="fas fa-graduation-cap mr-3"></i>学术助手
                        </h3>
                        <p class="text-indigo-100">为你的学习和研究提供强大支持——点击展开实用工具集。</p>
                    </div>
                    <i id="toolsToggleIcon" class="fas fa-chevron-down text-2xl transition-transform duration-300"></i>
                </div>

                <div id="toolsGridContainer" class="tools-grid-container">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="toolsGrid">
                    </div>
                </div>

                <div id="recreationHelperCard" class="bg-gradient-to-br from-red-500 to-orange-600 p-6 rounded-xl shadow-xl cursor-pointer enhanced-card-hover mb-6 text-white flex items-center justify-between mt-8">
                    <div>
                        <h3 class="text-2xl font-semibold mb-2 flex items-center">
                            <i class="fas fa-gamepad mr-3"></i>休闲娱乐
                        </h3>
                        <p class="text-indigo-100">为你的课业闲暇添点趣味——点击展开休闲工具集。</p>
                    </div>
                    <i id="recreationToolsToggleIcon" class="fas fa-chevron-down text-2xl transition-transform duration-300"></i>
                </div>

                <div id="recreationToolsGridContainer" class="tools-grid-container">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="recreationToolsGrid">
                    </div>
                </div>
            </div>
        </section>

        <section id="chatbot-area" class="container mx-auto py-12 px-4 md:px-8 content-section">
            <div class="glassmorphism p-6 md:p-8 mb-16">
                <h2 class="text-3xl font-bold mb-8 flex items-center text-gray-800">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-pink-500 to-rose-600 flex items-center justify-center text-white mr-4 shadow-lg">
                        <i class="fas fa-robot text-xl"></i>
                    </div>
                    Chat with 小八
                    <button id="openChatModalButton" class="ml-auto bg-blue-500 hover:bg-blue-600 text-white text-sm px-4 py-2 rounded-lg transition-colors shadow-md hover:shadow-lg">
                        <i class="fas fa-expand mr-2"></i>展开对话
                    </button>
                </h2>

                <div class="bg-white/80 backdrop-blur-sm rounded-xl p-4 sm:p-6 max-w-3xl mx-auto shadow-lg border border-gray-200">
                    <div id="chatMessages" class="h-80 overflow-y-auto mb-4 p-3 space-y-3 bg-gray-50/50 rounded-lg border">
                    </div>

                    <div class="flex items-center gap-3">
                        <input type="text" id="chatInput" placeholder="输入你的问题..." class="flex-1 border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm text-sm">
                        <button id="chatSendButton" class="bg-blue-500 hover:bg-blue-600 text-white px-5 py-3 rounded-lg transition-colors shadow-md hover:shadow-lg transform hover:-translate-y-0.5 flex items-center">
                            <i class="fas fa-paper-plane mr-2 sm:mr-0"></i><span class="hidden sm:inline">发送</span>
                        </button>
                    </div>
                    <p id="chatError" class="text-red-500 text-xs mt-2 h-4"></p>
                </div>
            </div>
        </section>

        <div id="chatModal" class="modal">
            <div class="modal-content">
                <span class="modal-close" id="closeChatModalButton">×</span>
                <h3 class="text-2xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-robot mr-2"></i>小八
                    <select id="modelSelect" class="ml-4 text-base px-3 py-1 rounded-lg bg-gray-100 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="domestic_normal">普通小八 (国内版)</option>
                        <option value="domestic_inference">推理小八 (国内版)</option>
                        <option value="international_normal">普通小八 (国际版)</option>
                        <option value="international_inference">推理小八 (国际版)</option>
                    </select>
                    <span id="currentModelDisplay" class="ml-2 text-sm text-gray-600">当前模型: 普通小八 (国内版)</span>
                </h3>
                <div id="modalChatMessages" class="modal-chat-messages space-y-3">
                </div>
                <div class="modal-chat-input-area">
                    <input type="text" id="modalChatInput" placeholder="输入你的问题..." class="flex-1 border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm text-sm">
                    <button id="modalChatSendButton" class="bg-blue-500 hover:bg-blue-600 text-white px-5 py-3 rounded-lg transition-colors shadow-md flex items-center">
                        <i class="fas fa-paper-plane mr-2 sm:mr-0"></i><span class="hidden sm:inline">发送</span>
                    </button>
                    <button id="downloadChatButton" class="bg-indigo-500 hover:bg-indigo-600 text-white px-5 py-3 rounded-lg transition-colors shadow-md flex items-center">
                        <i class="fas fa-download mr-2"></i><span class="hidden sm:inline">下载对话</span>
                    </button>
                </div>
                <p id="modalChatError" class="text-red-500 text-xs mt-2 h-4"></p>
            </div>
        </div>

        <div id="classmateDetailModal" class="modal">
            <div class="classmate-detail-content">
                <span class="modal-close" id="closeClassmateDetailModalButton">×</span>
                <div id="classmateDetailContentBody">
                </div>
            </div>
        </div>

        <!-- Lightbox 模态框 -->
        <div id="imageModalOverlay" class="image-modal-overlay">
            <div class="image-modal-content">
                <span class="image-modal-close" id="closeImageModalButton">×</span>
                <img id="modalImage" src="" alt="Full size image" class="image-modal-image">
            </div>
        </div>

        <section id="message-area" class="container mx-auto py-12 px-4 md:px-8 content-section">
            <div class="glassmorphism p-6 md:p-8 mb-16">
                <h2 class="text-3xl font-bold mb-8 flex items-center text-gray-800">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-orange-500 to-amber-600 flex items-center justify-center text-white mr-4 shadow-lg">
                        <i class="fas fa-comment-dots text-xl"></i>
                    </div>
                    留言
                </h2>

                <div class="mb-8">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">实时弹幕</h3>
                    <div id="danmakuContainer" class="bg-gray-800/80 backdrop-blur-sm rounded-lg p-4 overflow-hidden relative shadow-inner border border-gray-700" style="height: 640px;">
                    </div>

                    <div class="mt-4 flex items-center gap-3">
                        <input type="text" id="danmakuInput" placeholder="输入你的弹幕..." class="flex-1 border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 shadow-sm text-sm">
                        <button id="danmakuSendButton" class="bg-orange-500 hover:bg-orange-600 text-white px-5 py-3 rounded-lg transition-colors shadow-md hover:shadow-lg transform hover:-translate-y-0.5 flex items-center">
                            <i class="fas fa-paper-plane mr-2 sm:mr-0"></i><span class="hidden sm:inline">发送</span>
                        </button>
                    </div>
                </div>

                <div>
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">弹幕历史记录</h3>
                    <div id="danmakuRecords" class="space-y-3 max-h-96 overflow-y-auto p-2 bg-gray-50/50 rounded-lg border border-gray-200">
                        <p class="text-gray-500 text-sm text-center">加载中...</p>
                    </div>
                    <p id="danmakuRecordsError" class="text-red-500 text-xs mt-2 h-4"></p>
                </div>
            </div>
        </section>

         <footer class="bg-gray-100/70 py-8 mt-10 border-t border-gray-200/80">
            <div class="container mx-auto px-4 md:px-8">
                <div class="flex flex-col md:flex-row justify-between items-center text-center md:text-left">
                    <div class="mb-4 md:mb-0">
                        <p class="text-gray-600 text-sm">© 八贤渡·敬业舟 - 202508 永久纪念页</p>
                        <p class="text-gray-500 text-xs mt-1">人生有梦，一起做梦。</p>
                    </div>
                    <div class="flex items-center">
                        <p class="text-gray-600 text-sm mr-4">Designed by <a href="https://github.com/YizukiAme" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:text-blue-700 hover:underline">Yizuki_Ame</a></p>
                        <p class="text-gray-600 text-sm mr-4"><a href="mailto:yinzimike@gmail.com" class="text-blue-500 hover:text-blue-700 hover:underline">yinzimike@gmail.com</a></p>
                        <!-- 在这里添加新的联系信息 -->              
                    </div>
                </div>
            </div>
        </footer>

        <!-- START: Upload Modal -->
        <div id="uploadPhotoModal" class="modal">
            <div class="modal-content">
                <span class="modal-close" id="closeUploadPhotoModalButton">×</span>
                <div class="p-4 flex flex-col h-full">
                    <div class="text-center mb-6">
                        <i class="fas fa-cloud-upload-alt text-5xl text-blue-500"></i>
                        <h3 class="text-2xl font-bold text-gray-800 mt-4">分享你的影像吧！</h3>
                        <p class="text-gray-600 mt-2">上传的内容将用于更新回忆。</p>
                    </div>
                    <form id="uploadForm" class="flex flex-col flex-grow space-y-4">
                        <div>
                            <label for="imageUploadInput" class="block text-sm font-medium text-gray-700 mb-2">选择文件:</label>
                            <input type="file" id="imageUploadInput" accept="image/*,video/*" multiple class="block w-full text-sm text-gray-500
                                file:mr-4 file:py-3 file:px-5
                                file:rounded-lg file:border-0
                                file:text-sm file:font-semibold
                                file:bg-blue-50 file:text-blue-700
                                hover:file:bg-blue-100 cursor-pointer"/>
                        </div>
                        <div>
                            <label for="uploaderNameInput" class="block text-sm font-medium text-gray-700 mb-1">你是谁？</label>
                            <input type="text" id="uploaderNameInput" placeholder="（可选）方便我们认识你！" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                        </div>
                        <div>
                            <label for="imageDescriptionInput" class="block text-sm font-medium text-gray-700 mb-1">这是啥？</label>
                            <textarea id="imageDescriptionInput" placeholder="（可选）简单描述一下这个照片或视频吧~" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                        <div class="flex-grow"></div> <!-- Spacer -->
                        <div class="mt-auto">
                            <button type="submit" id="submitUploadButton" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition-colors shadow-md hover:shadow-lg transform hover:-translate-y-0.5 flex items-center justify-center w-full disabled:bg-gray-400 disabled:cursor-not-allowed">
                                <i class="fas fa-upload mr-2"></i>开始上传
                            </button>
                            <p id="uploadStatus" class="text-sm text-gray-600 mt-3 text-center h-5"></p>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- END: Upload Modal -->

        <!-- START: Birthday Celebration Modal (UPDATED) -->
        <div id="birthday-celebration-modal" class="birthday-modal">
            <div class="birthday-modal-content">
                <span id="close-birthday-modal" class="modal-close">×</span>
                <div class="text-center">
                    <i class="fas fa-birthday-cake text-5xl text-pink-400 mb-4 animate-bounce"></i>
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">生日快乐！</h2>
                    <p id="birthday-modal-message" class="text-lg text-gray-600 mb-6">祝我们亲爱的</p>
                    
                    <!-- NEW: Link to Classmates Section -->
                    <a href="#classmates-area" id="modal-goto-classmates" 
                       class="inline-block bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                        <i class="fas fa-users mr-2"></i>查看同学录
                    </a>
                </div>
            </div>
        </div>
        <!-- END: Birthday Celebration Modal -->

        <!-- START: Floating Birthday Hat -->
        <div id="floating-birthday-hat" class="hidden">
            <i class="fas fa-birthday-cake"></i>
        </div>
        <!-- END: Floating Birthday Hat -->

   
        <!-- START: Floating Cat -->
        <div id="floating-cat">
            <i class="fas fa-cat"></i>
        </div>
        <!-- END: Floating Cat -->

    </div><!-- This is the closing tag for #main-content-wrapper -->

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const mainNav = document.getElementById('mainNav');
            const heroSection = document.getElementById('hero-section');
            const fixedBackground = document.getElementById('fixed-background');
            const mainContentWrapper = document.getElementById('main-content-wrapper');
            const contentSections = document.querySelectorAll('.content-section');
            const scrollDownArrow = document.getElementById('scrollDownArrow');
            const mobileMenuButton = document.getElementById('mobileMenuButton');
            const mobileMenu = document.getElementById('mobileMenu');
            const graduationTimer = document.getElementById('graduationTimer'); 

            const uploadForm = document.getElementById('uploadForm');
            const submitUploadButton = document.getElementById('submitUploadButton');
            const uploadStatus = document.getElementById('uploadStatus');
            const imageUploadInput = document.getElementById('imageUploadInput');
            const uploaderNameInput = document.getElementById('uploaderNameInput');
            const imageDescriptionInput = document.getElementById('imageDescriptionInput');

            if (uploadForm) {
                uploadForm.addEventListener('submit', async function(event) {
                    event.preventDefault();

                    if (!imageUploadInput.files || imageUploadInput.files.length === 0) {
                        uploadStatus.textContent = '请先选择至少一个文件！';
                        uploadStatus.style.color = 'red';
                        return;
                    }

                    const files = Array.from(imageUploadInput.files);
                    const uploaderName = (uploaderNameInput.value || '匿名').replace(/[^\w\u4E00-\u9FA5-]/g, '');
                    const imageDescription = (imageDescriptionInput.value || '无描述').replace(/[^\w\u4E00-\u9FA5-]/g, '');

                    submitUploadButton.disabled = true;
                    let successCount = 0;
                    let errorCount = 0;

                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        const currentFileNumber = i + 1;
                        const totalFiles = files.length;

                        uploadStatus.textContent = `正在上传第 ${currentFileNumber}/${totalFiles} 个文件: ${file.name}`;
                        uploadStatus.style.color = 'inherit';
                        submitUploadButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>处理中 ${currentFileNumber}/${totalFiles}...`;

                        const timestamp = new Date().toISOString().replace(/[:.-]/g, '');
                        const fileExtension = file.name.split('.').pop() || 'tmp';
                        const fileName = `${timestamp}_${uploaderName}_${imageDescription}_${i}.${fileExtension}`;
                        const Key = `uploads/${fileName}`;

                        try {
                            const credResponse = await fetch('/api/upload', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ fileName: fileName }),
                            });

                            if (!credResponse.ok) {
                                let errorMsg = credResponse.statusText;
                                try {
                                    const errorData = await credResponse.json();
                                    errorMsg = errorData.details || errorData.error || errorMsg;
                                } catch (e) { /* Use status text if JSON parsing fails */ }
                                throw new Error(`获取许可失败: ${errorMsg}`);
                            }

                            const tempCredentials = await credResponse.json();
                            const cos = new COS({
                                getAuthorization: function(options, callback) {
                                    callback({
                                        ...tempCredentials,
                                        XCosSecurityToken: tempCredentials.Token || tempCredentials.XCosSecurityToken,
                                    });
                                }
                            });

                            await new Promise((resolve, reject) => {
                                cos.putObject({
                                    Bucket: '8ban-1311723413',
                                    Region: 'ap-shanghai',
                                    Key: Key,
                                    Body: file,
                                    onProgress: function(progressData) {
                                        const percent = parseInt(progressData.percent * 100, 10);
                                        submitUploadButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>上传中 ${currentFileNumber}/${totalFiles} (${percent}%)`;
                                        uploadStatus.textContent = `进度: ${percent}% (${(progressData.loaded / 1024 / 1024).toFixed(2)}MB / ${(progressData.total / 1024 / 1024).toFixed(2)}MB)`;
                                    }
                                }, function(err, data) {
                                    if (err) {
                                        console.error(`COS upload error for ${file.name}:`, err);
                                        reject(err);
                                    } else {
                                        console.log(`Upload success for ${file.name}:`, data);
                                        successCount++;
                                        resolve(data);
                                    }
                                });
                            });

                        } catch (error) {
                            console.error(`Upload process failed for ${file.name}:`, error);
                            errorCount++;
                            uploadStatus.textContent = `文件 ${file.name} 上传失败: ${error.message}`;
                            uploadStatus.style.color = 'red';
                            // Wait a moment before continuing to the next file
                            await new Promise(resolve => setTimeout(resolve, 2000));
                        }
                    }

                    // Final status update
                    submitUploadButton.disabled = false;
                    submitUploadButton.innerHTML = '<i class="fas fa-upload mr-2"></i>开始上传';

                    if (errorCount === 0) {
                        uploadStatus.textContent = `全部 ${successCount} 个文件上传成功！感谢你的分享！`;
                        uploadStatus.style.color = 'green';
                    } else {
                        uploadStatus.textContent = `上传完成: ${successCount} 个成功, ${errorCount} 个失败。`;
                        uploadStatus.style.color = 'orange';
                    }

                    setTimeout(() => {
                        document.getElementById('closeUploadPhotoModalButton').click();
                        uploadForm.reset();
                        uploadStatus.textContent = '';
                        uploadStatus.style.color = 'inherit';
                    }, 5000);
                });
            }

            // START: Floating Cat Logic
            const floatingCat = document.getElementById('floating-cat');
            if (floatingCat) {
                let isDraggingCat = false;
                let hasCatAppeared = false;
                let catOffsetX, catOffsetY;
                let mouseX = 0, mouseY = 0; // Track mouse position

                document.addEventListener('mousemove', (e) => {
                    mouseX = e.clientX;
                    mouseY = e.clientY;
                });
                document.addEventListener('touchmove', (e) => {
                    if (e.touches.length > 0) {
                        mouseX = e.touches[0].clientX;
                        mouseY = e.touches[0].clientY;
                    }
                }, { passive: true });

                // Physics variables
                let vx = 0;
                let vy = 0;
                const gravity = 0.4;
                const bounceFactor = -0.6;

                // AI variables
                let catMode = 'AI'; // 'AI' or 'PHYSICS'
                let aiState = 'IDLE'; // 'IDLE', 'WALKING', 'PAUSED'
                let aiStateTimer = 120; // Frames to wait in current state
                let aiDirection = 1; // 1 for right, -1 for left
                const walkSpeed = 1.5;

                // Shared variables
                let catanimationFrameId = null;
                const FISH_TRAIL_INTERVAL = 100;
                let lastFishTrailTime = 0;
                let lastCatX = 0, lastCatY = 0, lastCatMoveTime = 0;

                function switchToPhysicsMode(initialVelocity = {}) {
                    catMode = 'PHYSICS';
                    vx = initialVelocity.vx || vx;
                    vy = initialVelocity.vy || vy;
                    if (catanimationFrameId === null) {
                        startCatAnimation();
                    }
                }

                function switchToAIMode() {
                    catMode = 'AI';
                    aiState = 'IDLE';
                    aiStateTimer = Math.random() * 120 + 60; // Idle for 1-3 seconds
                    vx = 0;
                    vy = 0;
                    
                    const catHeight = floatingCat.offsetHeight;
                    const floorY = window.innerHeight - catHeight;
                    floatingCat.style.top = `${floorY}px`; // Place on floor

                    if (catanimationFrameId === null) {
                        startCatAnimation();
                    }
                }

                function createFishTrail(x, y) {
                    const now = Date.now();
                    if (now - lastFishTrailTime < FISH_TRAIL_INTERVAL) return;
                    const fish = document.createElement('i');
                    fish.classList.add('fas', 'fa-fish', 'fish-trail');
                    fish.style.left = `${x}px`;
                    fish.style.top = `${y}px`;
                    document.body.appendChild(fish);
                    fish.addEventListener('animationend', () => fish.remove());
                    lastFishTrailTime = now;
                }

                function animateCat() {
                    if (!hasCatAppeared) {
                        catanimationFrameId = null;
                        return;
                    }

                    const catWidth = floatingCat.offsetWidth;
                    const catHeight = floatingCat.offsetHeight;
                    const viewportWidth = window.innerWidth;
                    const viewportHeight = window.innerHeight;
                    const floorY = viewportHeight - catHeight;
                    let currentX = parseFloat(floatingCat.style.left);
                    let currentY = parseFloat(floatingCat.style.top);

                    if (isDraggingCat) {
                        floatingCat.classList.remove('ai-idle', 'ai-walking');
                        // Dragging logic is handled by move listeners, just keep animating
                    } else if (catMode === 'PHYSICS') {
                        floatingCat.classList.remove('ai-idle', 'ai-walking');
                        vy += gravity;
                        currentX += vx;
                        currentY += vy;

                        // Wall bounces
                        if (currentX + catWidth > viewportWidth) { currentX = viewportWidth - catWidth; vx *= bounceFactor; }
                        if (currentX < 0) { currentX = 0; vx *= bounceFactor; }
                        if (currentY < 0) { currentY = 0; vy *= bounceFactor; }

                        // Floor bounce and settling
                        if (currentY + catHeight > viewportHeight) {
                            const wasAirborne = (currentY < floorY - 5); // Check if it was significantly above floor
                            currentY = viewportHeight - catHeight;
                            vy *= bounceFactor;
                            vx *= 0.95; // Friction on floor
                            
                            // Check if cat has settled down
                            if (Math.abs(vy) < 1 && Math.abs(vx) < 1) {
                                switchToAIMode();
                            }
                        }
                        
                        floatingCat.style.left = `${currentX}px`;
                        floatingCat.style.top = `${currentY}px`;

                        // Dynamic Shadow: Adjust blur and offset based on height and vertical velocity
                        const heightAboveFloor = floorY - currentY;
                        const maxShadowBlur = 15; // Max blur when high up
                        const minShadowBlur = 5;  // Min blur when on ground
                        const maxShadowOffset = 10; // Max offset when high up
                        const minShadowOffset = 5; // Min offset when on ground
                        const maxJumpHeight = 100; // Arbitrary max height for shadow calculation

                        let shadowBlur = minShadowBlur + (heightAboveFloor / maxJumpHeight) * (maxShadowBlur - minShadowBlur);
                        shadowBlur = Math.max(minShadowBlur, Math.min(maxShadowBlur, shadowBlur));

                        let shadowOffset = minShadowOffset + (heightAboveFloor / maxJumpHeight) * (maxShadowOffset - minShadowOffset);
                        shadowOffset = Math.max(minShadowOffset, Math.min(maxShadowOffset, shadowOffset));

                        // Add a slight bounce effect to shadow offset based on vertical velocity
                        const bounceShadowFactor = Math.abs(vy) * 0.5; // Adjust multiplier as needed
                        shadowOffset += bounceShadowFactor;
                        shadowBlur += bounceShadowFactor * 0.5; // Slightly blur more on impact/fast movement

                        floatingCat.style.setProperty('--cat-shadow', `0 ${shadowOffset}px ${shadowBlur}px rgba(0,0,0,0.3)`);

                        createFishTrail(currentX + catWidth / 2, currentY + catHeight / 2);

                    } else if (catMode === 'AI') {
                        const catCenterX = currentX + catWidth / 2;
                        const catCenterY = currentY + catHeight / 2;
                        const distanceToMouse = Math.sqrt(Math.pow(mouseX - catCenterX, 2) + Math.pow(mouseY - catCenterY, 2));
                        const chaseRadius = 200; // Distance within which cat starts chasing

                        if (distanceToMouse < chaseRadius && !isDraggingCat) {
                            aiState = 'CHASING';
                            floatingCat.classList.add('ai-walking');
                            floatingCat.classList.remove('ai-idle');
                            const targetX = mouseX - catWidth / 2;
                            const targetY = Math.min(mouseY - catHeight / 2, floorY); // Don't let cat go below floor

                            const dx = targetX - currentX;
                            const dy = targetY - currentY;
                            const angle = Math.atan2(dy, dx);
                            const chaseSpeed = 3; // Faster speed when chasing

                            currentX += Math.cos(angle) * chaseSpeed;
                            currentY += Math.sin(angle) * chaseSpeed;

                            // Clamp to boundaries
                            currentX = Math.max(0, Math.min(currentX, viewportWidth - catWidth));
                            currentY = Math.max(0, Math.min(currentY, floorY));

                            // Update direction for flip, with a small threshold to reduce frequent flipping
                            const flipThreshold = 5; // Pixels
                            if (dx > flipThreshold) aiDirection = 1;
                            else if (dx < -flipThreshold) aiDirection = -1;

                            floatingCat.style.left = `${currentX}px`;
                            floatingCat.style.top = `${currentY}px`;
                            floatingCat.style.setProperty('--cat-direction', aiDirection);

                        } else {
                            // If not chasing, revert to normal AI behavior
                            // If cat is airborne, switch to physics mode to fall naturally
                            if (currentY < floorY - 5) { // -5 to give a small buffer
                                switchToPhysicsMode();
                                catanimationFrameId = requestAnimationFrame(animateCat); // Ensure next frame runs
                                return; // Stop processing AI logic for this frame, let physics take over
                            }

                            aiStateTimer--;

                            // Curiosity behavior: if idle, occasionally look towards the mouse
                            if (aiState === 'IDLE' && Math.random() < 0.02) { // 2% chance per frame to look at mouse
                                const dxToMouse = mouseX - catCenterX;
                                if (dxToMouse > 10) aiDirection = 1;
                                else if (dxToMouse < -10) aiDirection = -1;
                            }

                            // Question mark pop-up
                            if (aiState === 'IDLE' && Math.random() < 0.005) { // 0.5% chance to show question mark
                                const qMark = document.createElement('i');
                                qMark.classList.add('fas', 'fa-question', 'question-mark');
                                qMark.style.left = `${catCenterX}px`;
                                qMark.style.top = `${catCenterY - 30}px`; // Above the cat
                                document.body.appendChild(qMark);
                                qMark.addEventListener('animationend', () => qMark.remove());
                            }

                            if (aiState !== 'PAUSED' && aiStateTimer <= 0) {
                                const rand = Math.random();
                                if (rand < 0.4) { // 40% chance to start walking
                                    aiState = 'WALKING';
                                    aiStateTimer = Math.random() * 240 + 120; // Walk for 2-6s
                                    aiDirection = (Math.random() < 0.5) ? 1 : -1;
                                } else if (rand < 0.7) { // 30% chance to stay idle
                                    aiState = 'IDLE';
                                    aiStateTimer = Math.random() * 60 + 30; // Idle for 0.5-1.5s
                                } else if (rand < 0.85) { // 15% chance to do a small hop
                                    aiState = 'IDLE'; // Will be handled by physics
                                    aiStateTimer = 60; // Idle after landing
                                    switchToPhysicsMode({
                                        vx: (Math.random() - 0.5) * 8,
                                        vy: -Math.random() * 5 - 5 // Small hop
                                    });
                                } else { // 15% chance to start caressing wall
                                    aiState = 'CARESSING_WALL';
                                    aiStateTimer = Math.random() * 180 + 90; // Caress for 1.5-3 seconds
                                    // Determine which wall to go to
                                    aiDirection = (currentX < viewportWidth / 2) ? -1 : 1; // Go to left wall if closer, else right
                                }
                            }

                            // Apply classes based on current aiState
                            if (aiState === 'WALKING' || aiState === 'CHASING' || aiState === 'CARESSING_WALL') { // CHASING and CARESSING_WALL also use walking animation
                                floatingCat.classList.add('ai-walking');
                                floatingCat.classList.remove('ai-idle');
                            } else { // IDLE or PAUSED
                                floatingCat.classList.add('ai-idle');
                                floatingCat.classList.remove('ai-walking');
                            }

                            if (aiState === 'WALKING') {
                                currentX += walkSpeed * aiDirection;
                                if (currentX + catWidth >= viewportWidth) {
                                    currentX = viewportWidth - catWidth;
                                    aiDirection = -1;
                                    aiState = 'IDLE'; // Pause at wall
                                    aiStateTimer = 60;
                                }
                                if (currentX <= 0) {
                                    currentX = 0;
                                    aiDirection = 1;
                                    aiState = 'IDLE'; // Pause at wall
                                    aiStateTimer = 60;
                                }
                                floatingCat.style.left = `${currentX}px`;
                                floatingCat.style.setProperty('--cat-direction', aiDirection);
                                floatingCat.style.top = `${floorY}px`; // Keep on floor when walking
                            } else if (aiState === 'CARESSING_WALL') {
                                const targetX = (aiDirection === 1) ? viewportWidth - catWidth : 0;
                                const dx = targetX - currentX;
                                if (Math.abs(dx) > walkSpeed) {
                                    currentX += Math.sign(dx) * walkSpeed;
                                } else {
                                    currentX = targetX;
                                    // Once at wall, stay there and "caress"
                                    // This state will naturally transition to IDLE after aiStateTimer runs out
                                }
                                floatingCat.style.left = `${currentX}px`;
                                floatingCat.style.setProperty('--cat-direction', aiDirection);
                                floatingCat.style.top = `${floorY}px`; // Keep on floor
                            } else { // IDLE or PAUSED
                                floatingCat.style.setProperty('--cat-direction', aiDirection); // Maintain direction when idle/paused
                                floatingCat.style.top = `${floorY}px`; // Keep on floor when idle/paused
                            }
                        }
                    }

                    catanimationFrameId = requestAnimationFrame(animateCat);
                }

                function startCatAnimation() {
                    if (catanimationFrameId === null) {
                        catanimationFrameId = requestAnimationFrame(animateCat);
                    }
                }

                function stopCatAnimation() {
                    if (catanimationFrameId !== null) {
                        cancelAnimationFrame(catanimationFrameId);
                        catanimationFrameId = null;
                    }
                }

                const handleCatStart = (e) => {
                    if (!floatingCat.classList.contains('active')) return;
                    isDraggingCat = true;
                    floatingCat.classList.add('dragging');
                    floatingCat.style.transition = 'none';
                    switchToPhysicsMode(); // Switch to physics mode for dragging

                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    catOffsetX = clientX - floatingCat.getBoundingClientRect().left;
                    catOffsetY = clientY - floatingCat.getBoundingClientRect().top;

                    vx = 0; vy = 0;
                    lastCatX = floatingCat.getBoundingClientRect().left;
                    lastCatY = floatingCat.getBoundingClientRect().top;
                    lastCatMoveTime = Date.now();
                    e.preventDefault();
                };

                const handleCatMove = (e) => {
                    if (!isDraggingCat) return;
                    e.preventDefault();
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    const newX = clientX - catOffsetX;
                    const newY = clientY - catOffsetY;
                    const maxX = window.innerWidth - floatingCat.offsetWidth;
                    const maxY = window.innerHeight - floatingCat.offsetHeight;
                    const clampedX = Math.max(0, Math.min(newX, maxX));
                    const clampedY = Math.max(0, Math.min(newY, maxY));
                    floatingCat.style.left = `${clampedX}px`;
                    floatingCat.style.top = `${clampedY}px`;

                    const currentTime = Date.now();
                    const deltaTime = currentTime - lastCatMoveTime;
                    if (deltaTime > 10) { // Update velocity only if there's a meaningful time diff
                        vx = (clampedX - lastCatX) / deltaTime * 30; // Scaled velocity
                        vy = (clampedY - lastCatY) / deltaTime * 30;
                        lastCatX = clampedX;
                        lastCatY = clampedY;
                        lastCatMoveTime = currentTime;
                    }
                    createFishTrail(clientX, clientY);
                };

                const handleCatEnd = (e) => {
                    if (!isDraggingCat) return;

                    isDraggingCat = false;
                    floatingCat.classList.remove('dragging');

                    // Check if it was a click/tap and not a throw by checking velocity
                    if (Math.abs(vx) > 2 || Math.abs(vy) > 2) {
                        return; // It was a throw, let physics handle it
                    }

                    // It's a click/tap, so trigger the effects
                    if (floatingCat.classList.contains('active')) {
                        // Pause AI movement briefly
                        if (catMode === 'AI') {
                            aiState = 'PAUSED';
                            aiStateTimer = 120; // Pause for 2 seconds
                        }

                        // Get coordinates for effects from either mouse or touch event
                        let clientX, clientY;
                        if (e.type === 'touchend' || e.type === 'touchcancel') {
                            const touch = e.changedTouches[0];
                            clientX = touch.clientX;
                            clientY = touch.clientY;
                        } else { // mouseup
                            clientX = e.clientX;
                            clientY = e.clientY;
                        }

                        // Angry reaction
                        if (Math.random() < 0.12) {
                            const catRect = floatingCat.getBoundingClientRect();
                            const originX = catRect.left + catRect.width / 2;
                            const originY = catRect.top + catRect.height / 2;
                            for (let i = 0; i < 20; i++) {
                                const angryFace = document.createElement('i');
                                angryFace.classList.add('fas', 'fa-cat', 'angry-cat-face');
                                angryFace.textContent = '😠';
                                angryFace.style.left = `${originX}px`;
                                angryFace.style.top = `${originY}px`;
                                const angle = Math.random() * 360;
                                const distance = Math.random() * 150 + 50;
                                const rotation = Math.random() * 720 - 360;
                                angryFace.style.setProperty('--tx', `${Math.cos(angle * Math.PI / 180) * distance}px`);
                                angryFace.style.setProperty('--ty', `${Math.sin(angle * Math.PI / 180) * distance}px`);
                                angryFace.style.setProperty('--rot', `${rotation}deg`);
                                document.body.appendChild(angryFace);
                                angryFace.addEventListener('animationend', () => angryFace.remove());
                            }
                        } else { // Confetti and Heart Particles
                            const x = clientX / window.innerWidth;
                            const y = clientY / window.innerHeight;
                            confetti({ particleCount: 100, spread: 70, origin: { x: x, y: y }, colors: ['#f472b6', '#8b5cf6', '#3b82f6', '#ef4444', '#f97316'] });
                            // Heart particles for "happy" expression
                            confetti({
                                particleCount: 50,
                                spread: 40,
                                origin: { x: x, y: y - 0.05 }, // Slightly above the click point
                                colors: ['#FFC0CB', '#FF69B4', '#FF1493'], // Pink, HotPink, DeepPink
                                shapes: ['circle', 'square'] // Default shapes, as custom shapes are complex
                            });
                        }

                        // Random jump on click
                        if (Math.random() < 0.12) {
                            const force = Math.random() * 15 + 10;
                            const angle = Math.random() * Math.PI * 2;
                            switchToPhysicsMode({ vx: Math.cos(angle) * force, vy: Math.sin(angle) * force });
                        }
                    }
                };

                floatingCat.addEventListener('mousedown', handleCatStart);
                floatingCat.addEventListener('touchstart', handleCatStart, { passive: false });
                document.addEventListener('mousemove', handleCatMove);
                document.addEventListener('touchmove', handleCatMove, { passive: false });
                document.addEventListener('mouseup', handleCatEnd);
                document.addEventListener('touchend', handleCatEnd);

                if (mainContentWrapper) {
                    mainContentWrapper.addEventListener('scroll', () => {
                        const isAtBottom = mainContentWrapper.scrollHeight - mainContentWrapper.scrollTop <= mainContentWrapper.clientHeight + 100;
                        if (isAtBottom) {
                            if (!hasCatAppeared) {
                                hasCatAppeared = true;
                                floatingCat.classList.add('active');
                                // Initial position
                                floatingCat.style.left = `${window.innerWidth - 200}px`;
                                const floorY = window.innerHeight - floatingCat.offsetHeight;
                                floatingCat.style.top = `${floorY}px`;
                                switchToAIMode();
                            }
                        } else if (!hasCatAppeared) {
                            floatingCat.classList.remove('active');
                            stopCatAnimation();
                        }
                    });
                }
            } else {
                console.error("Floating cat element not found!");
            }
            // END: Floating Cat Logic

            const productionVideos = [
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/%E3%80%8A%E6%98%8E%E6%97%A5%E6%96%B9%E8%88%9F%E3%80%8BSideStory%E3%80%8C%E6%80%80%E9%BB%8D%E7%A6%BB%E3%80%8D%E6%B4%BB%E5%8A%A8%E5%AE%A3%E4%BC%A0PV_P2_%E3%80%90%E6%97%A5%E3%80%91%E3%80%8A%E6%98%8E%E6%97%A5%E6%96%B9%E8%88%9F%E3%80%8BSideStory%E3%80%8C%E6%80%80%E9%BB%8D%E7%A6%BB%E3%80%8D%E6%B4%BB%E5%8A%A8%E5%AE%A3%E4%BC%A0PV.mp4",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/WeChat_20250613105724.mp4",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/%E5%AD%A6%E5%86%9Cvlog_eng.mp4",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/%E3%80%90%E6%9D%B1%E6%96%B9projectPV%E3%80%91%E4%B8%89%E5%A6%96%E7%B2%BESAY%20YA!!!%EF%BC%88Vo_%E3%81%82%E3%82%84%E3%81%BD%E3%82%93%E3%81%9A%EF%BC%8A%2C%E3%81%82%E3%82%88%EF%BC%89%E5%A4%A7%E5%8D%8A%E7%A8%BF%E3%80%90%E6%A3%AE%E7%BE%85%E4%B8%87%E8%B1%A1%E5%AE%98%E6%96%B9%E3%80%91-%E4%B8%89%E5%A6%96%E7%B2%BE1210-1080P%2B-.mp4",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/%E3%80%8A%E6%98%8E%E6%97%A5%E6%96%B9%E8%88%9F%E3%80%8BSideStory%E3%80%8C%E6%95%AC%E4%B8%9A%E9%9B%86%E5%B8%82%E3%80%8D%E6%B4%BB%E5%8A%A8%E5%AE%A3%E4%BC%A0PV.mp4"
            ];

            const dailyVideos = [
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/IMG_5811.MOV",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/IMG_3142.MOV",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/IMG_3062.MOV",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/IMG_2901.MOV",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/IMG_2870.MOV",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/IMG_2867.MOV",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/IMG_8399.MOV",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/IMG_7777.MOV",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/IMG_7714.MOV",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/IMG_7053.MOV",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/IMG_7030.MOV",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/IMG_5838.MOV",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/IMG_5835.MOV",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/IMG_5825.MOV",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/IMG_5812.MOV",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/IMG_3235.MOV",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/IMG_3236.MOV",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/IMG_4941.MOV",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/IMG_3237.MOV",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/IMG_3197.MOV",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/IMG_3199.MOV",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/ef9658346c5c69e209e86d623e1fe6a1_raw.mp4",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/uploads/20250708T124137744Z_dwz_%E4%B8%8D%E7%9F%A5%E9%81%93_0.mov"
            ];

            function loadRandomVideo(containerId, videoList) {
                const container = document.getElementById(containerId);
                if (!container) {
                    console.error(`错误：未找到ID为 '${containerId}' 的视频容器。`);
                    return;
                }
                if (videoList.length === 0) {
                    container.innerHTML = `<p class="text-white text-lg">暂无视频可播放。</p>`;
                    return;
                }
                const randomIndex = Math.floor(Math.random() * videoList.length);
                const selectedVideoUrl = videoList[randomIndex];
                const videoElement = document.createElement('video');
                videoElement.src = selectedVideoUrl;
                videoElement.controls = true;
                videoElement.preload = "metadata";
                videoElement.classList.add('w-full', 'h-full', 'object-cover', 'rounded-lg');
                videoElement.poster = "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/36121664_p0.png"
                container.innerHTML = '';
                container.appendChild(videoElement);
                videoElement.addEventListener('error', function() {
                    console.error(`视频加载失败: ${selectedVideoUrl}`);
                    container.innerHTML = `<p class="text-red-400 text-lg">视频加载失败，请检查网络或视频源。</p>`;
                });
            }

            loadRandomVideo('productionVideoContainer', productionVideos);
            loadRandomVideo('dailyVideoContainer', dailyVideos);
            
            if (graduationTimer) {
                const GRADUATION_DATE = new Date('2025-06-07T00:00:00');
                let initialTimeDiffMs = GRADUATION_DATE.getTime() - new Date().getTime();

                function updateGraduationTimerOptimized() {
                    initialTimeDiffMs -= 1000; 
                    let isAfterGraduation = initialTimeDiffMs < 0;
                    let absDiffMs = Math.abs(initialTimeDiffMs);
                    const seconds = Math.floor(absDiffMs / 1000) % 60;
                    const minutes = Math.floor(absDiffMs / (1000 * 60)) % 60;
                    const hours = Math.floor(absDiffMs / (1000 * 60 * 60)) % 24;
                    const days = Math.floor(absDiffMs / (1000 * 60 * 60 * 24));
                    let timerText = '';
                    if (days > 0) {
                        timerText += `${days}天 `;
                    } else if (isAfterGraduation && days === 0) {
                        timerText += `0天 `;
                    }
                    timerText += `${String(hours).padStart(2, '0')}小时 ${String(minutes).padStart(2, '0')}分钟 ${String(seconds).padStart(2, '0')}秒`;
                    if (isAfterGraduation) {
                        graduationTimer.textContent = `离毕业已过 ${timerText}`;
                        graduationTimer.style.backgroundColor = 'rgba(255, 99, 71, 0.7)';
                    } else {
                        graduationTimer.textContent = `离毕业还有 ${timerText}`;
                        graduationTimer.style.backgroundColor = '';
                    }
                }
                updateGraduationTimerOptimized();
                setInterval(updateGraduationTimerOptimized, 1000);
            } else {
                console.error("Graduation timer element not found!");
            }

            const desktopImages = [
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/7fdeeeb52e2ba2aca0c76e23a1d54bbe.jpg",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/c572e1bd26b13fffb68e0cfd9b198fc6.png",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/e22635b4242570eb151695b295c2bf87.jpg",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/9505bd25461c4282b67ed682d922d908.jpg",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/003331SFMeU.jpg",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/102327wcAuJ.jpg"
            ];
            const mobileImages = [
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/9da590620de6f96c3ac255d00d1fbde5.jpg",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/03ba246a4afedfc4af676b63de03270e.jpg",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/b17575039ee4f88ef94cc0003cbc7b42.jpg",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/ac820b57dabf0f473c742ca5c0738beb.jpg",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/%E3%80%90%E5%93%B2%E9%A3%8E%E5%A3%81%E7%BA%B8%E3%80%91Chris%E6%8F%92%E7%94%BB-%E6%8F%92%E7%94%BB.png",
                "https://8ban-1311723413.cos.ap-shanghai.myqcloud.com/images/pexels-gopi-m-2150873673-31413681.jpg"
            ];

            function setHeroBackgroundImage() {
                const isMobile = window.innerWidth <= 768;
                const images = isMobile ? mobileImages : desktopImages;
                const randomIndex = Math.floor(Math.random() * images.length);
                const selectedImageUrl = images[randomIndex];
                if (fixedBackground && selectedImageUrl) {
                    fixedBackground.style.backgroundImage = `url('${selectedImageUrl}')`;
                } else {
                    console.error("Fixed background element not found or image URL is empty!");
                }
            }
            setHeroBackgroundImage();

            if (mainNav) {
                mainNav.classList.add('nav-initial');
                function setNavColors(isInitial) {
                    const titleDiv = mainNav.querySelector('.text-xl.font-bold');
                    const navLinks = mainNav.querySelectorAll('a');
                    const mobileBtn = mainNav.querySelector('#mobileMenuButton');
                    if (isInitial) {
                        titleDiv.style.color = 'white';
                        navLinks.forEach(link => link.style.color = 'white');
                        if (mobileBtn) mobileBtn.style.color = 'white';
                    } else {
                        titleDiv.style.color = '';
                        navLinks.forEach(link => link.style.color = '');
                        if (mobileBtn) mobileBtn.style.color = '';
                    }
                }
                setNavColors(true);

                contentSections.forEach(section => {
                    section.classList.remove('fade-in');
                });

                if (mainContentWrapper) {
                    mainContentWrapper.addEventListener('scroll', function() {
                        const scrollThreshold = heroSection ? heroSection.clientHeight * 0.5 : 200;
                        if (this.scrollTop > scrollThreshold) {
                            mainNav.classList.remove('nav-initial');
                            mainNav.classList.add('nav-scrolled');
                            setNavColors(false);
                        } else {
                            mainNav.classList.remove('nav-scrolled');
                            mainNav.classList.add('nav-initial');
                            setNavColors(true);
                        }
                    });
                } else {
                    console.error("Main content wrapper not found!");
                }

                const contentObserverOptions = {
                    root: mainContentWrapper,
                    rootMargin: '0px',
                    threshold: 0.1
                };

                const contentObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('fade-in');
                        }
                    });
                }, contentObserverOptions);

                contentSections.forEach(section => {
                    contentObserver.observe(section);
                });
            } else {
                console.error("Main navigation element not found!");
            }

            if (mobileMenuButton && mobileMenu) {
                mobileMenuButton.addEventListener('click', function() {
                    mobileMenu.classList.toggle('active');
                    const icon = this.querySelector('i');
                    if (mobileMenu.classList.contains('active')) {
                        icon.classList.remove('fa-bars');
                        icon.classList.add('fa-times');
                    } else {
                        icon.classList.remove('fa-times');
                        icon.classList.add('fa-bars');
                    }
                });
            } else {
                console.error("Mobile menu elements not found!");
            }

            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href');
                    if (targetId === '#top-of-page' || targetId === '#') {
                        if (mainContentWrapper) {
                            mainContentWrapper.scrollTo({ top: 0, behavior: 'smooth' });
                        } else {
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                        }
                    } else {
                        const targetElement = document.querySelector(targetId);
                        if (targetElement && mainContentWrapper) {
                            const offsetTop = targetElement.offsetTop;
                            mainContentWrapper.scrollTo({ top: offsetTop, behavior: 'smooth' });
                        } else if (targetElement) {
                            targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }
                    if (mobileMenu && mobileMenu.classList.contains('active')) {
                        mobileMenu.classList.remove('active');
                        const icon = mobileMenuButton.querySelector('i');
                        icon.classList.remove('fa-times');
                        icon.classList.add('fa-bars');
                    }
                });
            });

            if (scrollDownArrow) {
                scrollDownArrow.addEventListener('click', function() {
                    const firstContentSection = document.getElementById('intro-content');
                    if (firstContentSection && mainContentWrapper) {
                        mainContentWrapper.scrollTo({ top: firstContentSection.offsetTop, behavior: 'smooth', block: 'start' });
                    } else if (firstContentSection) {
                        firstContentSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            }

            const academicHelperCard = document.getElementById('academicHelperCard');
            const toolsGridContainer = document.getElementById('toolsGridContainer');
            const toolsToggleIcon = document.getElementById('toolsToggleIcon');
            const toolsGrid = document.getElementById('toolsGrid');

            const recreationHelperCard = document.getElementById('recreationHelperCard');
            const recreationToolsGridContainer = document.getElementById('recreationToolsGridContainer');
            const recreationToolsToggleIcon = document.getElementById('recreationToolsToggleIcon');
            const recreationToolsGrid = document.getElementById('recreationToolsGrid');

            const academicToolsData = [
                { name: '思得下载', description: '学术文献下载平台，提供国内外期刊论文、学位论文等资源下载。', link: 'https://www.scidown.cn/', icon: 'fas fa-download' },
                { name: '开放存取图书馆 (OALib)', description: '一个大型开放存取学术文献数据库，涵盖多学科领域。', link: 'https://www.oalib.com/', icon: 'fas fa-book-open' },
                { name: 'Sci-Hub', description: '免费获取科研文献的常用途径', link: 'https://sci-hub.ru/', icon: 'fas fa-key' },
                { name: 'WhiteSmoke', description: '专业的英语写作和语法检查工具。', link: 'https://www.whitesmoke.com/', icon: 'fas fa-pen-alt' },
                { name: '术语在线', description: '国家级专业术语知识服务平台，提供多语种术语查询。', link: 'https://www.termonline.cn/index', icon: 'fas fa-language' },
                { name: 'BioRender', description: '生物绘图工具，帮助生物学科研人员快速创建专业科学插图。', link: 'https://app.biorender.com/', icon: 'fas fa-flask' },
                { name: 'Plagiarism Checker X', description: '专业的查重工具，用于检测论文、文章的抄袭情况。', link: 'https://plagiarismcheckerx.com/', icon: 'fas fa-copy' },
                { name: 'Grammarly', description: '一个知名的英语语法、拼写和写作风格检查工具。', link: 'https://www.grammarlys.cn/', icon: 'fas fa-spell-check' },
                { name: 'AI Cleaner', description: 'AI生成内容检测与优化工具。', link: 'https://www.aigcleaner.com/', icon: 'fas fa-robot' },
                { name: '上海图书馆', description: '上海市综合性公共图书馆，提供丰富的数字资源和文献服务。超级小众但超级好用！', link: 'https://library.sh.cn/', icon: 'fas fa-university' },
                { name: 'DeepSeek', description: '无需多言。', link: 'https://www.deepseek.com/', icon: 'fas fa-search-plus' },
                { name: 'Engineering Village', description: '工程领域综合性文献数据库，包含Ei Compendex等。', link: 'https://www.engineeringvillage.com/', icon: 'fas fa-industry' },
                { name: 'OpenRouter', description: '免费多模型调用平台，集成多种大型语言模型API。', link: 'https://openrouter.ai/', icon: 'fas fa-cogs' },
                { name: 'Zotero', description: '免费开源的文献管理工具，支持文献收集、整理和引用。', link: 'https://www.zotero.org/', icon: 'fas fa-bookmark' },
                { name: 'Mendeley', description: '参考文献管理工具，集文献管理、PDF阅读和学术社交于一体。', link: 'https://www.mendeley.com/', icon: 'fas fa-book-reader' },
                { name: 'SurveyGO', description: '超级清华团队研发的超级文献综述生成工具。', link: 'https://surveygo.modelbest.cn/', icon: 'fas fa-poll-h' },
                { name: 'Socolar', description: '一家中国学术搜索引擎，提供中文学术文献的搜索和下载服务。', link: 'https://www.socolar.com/', icon: 'fas fa-search-location' },
                { name: 'ResearchRabbit', description: '发现新学术论文的首选应用！学术界Spotify', link: 'https://www.researchrabbit.ai/', icon: 'fas fa-rocket' },
                { name: 'Google Scholar', description: '无需多言。', link: 'https://scholar.google.com/', icon: 'fab fa-google' },
                { name: 'askyourpdf', description: '由 ChatGPT 提供支持的交互式 PDF 对话。', link: 'https://askyourpdf.com/', icon: 'fas fa-file-pdf' }

            ];

            const recreationToolsData = [
                { name: 'PointerPointer', description: '一个有趣的互动网站，让你指向屏幕上的指针', link: 'https://pointerpointer.com/', icon: 'fas fa-hand-pointer' },
                { name: 'SauceNAO', description: '图片源搜索工具，查找动漫、插画等来源', link: 'https://saucenao.com/', icon: 'fas fa-image' },
                { name: 'Trace.moe', description: '通过动漫截图查找番剧片段', link: 'https://trace.moe/', icon: 'fas fa-video' },
                { name: '2048', description: '经典数字益智游戏', link: 'https://play2048.co/', icon: 'fas fa-puzzle-piece' },
                { name: 'AGE动漫', description: '在线动漫观看平台', link: 'https://www.agefans.la/', icon: 'fas fa-tv' },
                { name: '巴哈姆特动画疯', description: '台湾正版���漫在线观看平台', link: 'https://ani.gamer.com.tw/', icon: 'fas fa-play-circle' },
                { name: '动漫花园', description: '动漫资源下载分享社区', link: 'https://share.dmhy.org/', icon: 'fas fa-cloud-download-alt' },
                { name: 'Flysheep资源避难所', description: '综合资源分享与下载', link: 'https://www.flysheep6.com/', icon: 'fas fa-archive' },
                { name: 'Adobe全家桶', description: 'Adobe软件资源分享（FlowUs笔记）', link: 'https://flowus.cn/share/ab4b6b86-34a6-4aa0-a679-b4a221b8e41d', icon: 'fab fa-adobe' },
                { name: 'Paywall Buster', description: '移除网站付费墙工具', link: 'https://paywallbuster.com/', icon: 'fas fa-unlock-alt' },
                { name: 'HEU KMS Activator', description: 'Windows/Office激活工具（GitHub Releases）', link: 'https://github.com/zbezj/HEU_KMS_Activator/releases', icon: 'fab fa-github' },
                { name: 'SnapAny Bilibili', description: '哔哩哔哩视频下载工具', link: 'https://snapany.com/zh/bilibili', icon: 'fab fa-bilibili' },
                { name: 'Radio Garden', description: '全球电台地图，收听世界各地的广播', link: 'https://radio.garden/', icon: 'fas fa-globe-americas' },
                { name: 'Histography', description: '交互式历史时间线', link: 'https://histography.io/', icon: 'fas fa-history' },
                { name: 'Window Swap', description: '随机观看世界各地窗外的景色', link: 'https://www.window-swap.com/', icon: 'fas fa-window-restore' },
                { name: '果核剥壳', description: '综合软件下载与资源分享站', link: 'https://www.ghxi.com/', icon: 'fas fa-tools' },
                { name: 'The Useless Web', description: '带你发现各种无用但有趣的网站', link: 'https://theuselessweb.com/', icon: 'fas fa-random' },
                { name: 'Zooniverse', description: '参与科学研究的公民科学平台', link: 'https://www.zooniverse.org/', icon: 'fas fa-meteor' },
                { name: 'Neal.fun', description: '一系列创意有趣的互动小工具和实验', link: 'https://neal.fun/', icon: 'fas fa-lightbulb' },
                { name: '4399小游戏', description: '经典在线小游戏平台', link: 'https://www.4399.com/', icon: 'fas fa-gamepad' },
                { name: 'Character.AI', description: 'AI角色扮演对话平台', link: 'https://character.ai/', icon: 'fas fa-user-astronaut' },
                { name: 'Sperte动漫资源茶馆', description: '动漫资源分享与交流社区', link: 'https://www.cycg.xyz/', icon: 'fas fa-comments' },
                { name: '影猫の仓库', description: '免费在线影视资源站', link: 'https://ymck.pro/', icon: 'fas fa-film' },
                { name: 'MVCAT', description: '电影、资料综合查询与分享站', link: 'https://www.mvcat.com/', icon: 'fas fa-database' },
                { name: '纪录片之家', description: '在线纪录片观看与下载', link: 'https://www.05jl.com/', icon: 'fas fa-photo-video' },
                { name: 'Docu-Lib', description: '纪录片数据库与资源索引', link: 'https://docu-lib.com/', icon: 'fas fa-book' },
                { name: 'AIDN.jp', description: '创意互动艺术与实验网站', link: 'https://aidn.jp/', icon: 'fas fa-paint-brush' },
                { name: '八班UNO', description: '敬业中学2025届八班专属网站！', link: 'https://www.8ban.uno/', icon: 'fas fa-users' }
            ];


            function populateToolsGrid(gridElement, toolsArray) {
                if (!gridElement) return;
                gridElement.innerHTML = '';
                toolsArray.forEach(tool => {
                    const cardHtml = `
                        <div class="bg-white/70 backdrop-blur-sm p-5 rounded-xl shadow-lg enhanced-card-hover border border-gray-200/80 flex flex-col justify-between">
                            <div>
                                <div class="flex items-center mb-3">
                                    <i class="${tool.icon} text-2xl text-indigo-500 mr-3 w-8 text-center"></i>
                                    <h4 class="text-lg font-semibold text-gray-800">${tool.name}</h4>
                                </div>
                                <p class="text-gray-600 text-xs leading-relaxed mb-4 h-16">${tool.description}</p>
                            </div>
                            <a href="${tool.link}" target="_blank" rel="noopener noreferrer"
                            class="mt-auto block w-full bg-indigo-500 hover:bg-indigo-600 text-white text-center text-sm font-medium py-2 px-4 rounded-lg transition-colors duration-200 shadow hover:shadow-md">
                                前往使用 <i class="fas fa-external-link-alt ml-1 text-xs"></i>
                            </a>
                        </div>
                    `;
                    gridElement.innerHTML += cardHtml;
                });
            }

            if (academicHelperCard && toolsGridContainer && toolsToggleIcon && toolsGrid) {
                populateToolsGrid(toolsGrid, academicToolsData);
                academicHelperCard.addEventListener('click', () => {
                    toolsGridContainer.classList.toggle('active');
                    toolsToggleIcon.classList.toggle('fa-chevron-down');
                    toolsToggleIcon.classList.toggle('fa-chevron-up');
                });
            } else {
                console.error("Academic tool section elements not found.");
            }

            if (recreationHelperCard && recreationToolsGridContainer && recreationToolsToggleIcon && recreationToolsGrid) {
                populateToolsGrid(recreationToolsGrid, recreationToolsData);
                recreationHelperCard.addEventListener('click', () => {
                    recreationToolsGridContainer.classList.toggle('active');
                    recreationToolsToggleIcon.classList.toggle('fa-chevron-down');
                    recreationToolsToggleIcon.classList.toggle('fa-chevron-up');
                });
            } else {
                console.error("Recreation tool section elements not found.");
            }

            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            const chatSendButton = document.getElementById('chatSendButton');
            const chatError = document.getElementById('chatError');

            const openChatModalButton = document.getElementById('openChatModalButton');
            const chatModal = document.getElementById('chatModal');
            const closeChatModalButton = document.getElementById('closeChatModalButton');
            const modalChatMessages = document.getElementById('modalChatMessages');
            const modalChatInput = document.getElementById('modalChatInput');
            const modalChatSendButton = document.getElementById('modalChatSendButton');
            const modalChatError = document.getElementById('modalChatError');
            const downloadChatButton = document.getElementById('downloadChatButton');
            const modelSelect = document.getElementById('modelSelect');
            const currentModelDisplay = document.getElementById('currentModelDisplay');

            const DUMMY_API_KEY_FRONTEND = "DUMMY_KEY_FRONTEND_NOT_USED_IN_PROD"; 

            const chatModelConfigs = {
                domestic_normal: {
                    name: "普通小八 (国内版)",
                    baseURL: "https://api.siliconflow.cn/v1/chat/completions",
                    model: "Qwen/Qwen2.5-72B-Instruct-128K",
                    apiKey: "sk-zfbhvvqakpqerjuriwvdkncdqixbpnoezlwbogcfzmjangog",
                    isInternal: true,
                    supportsSystemRole: true,
                    endpointIsProxy: false,
                    supportsStreaming: true
                },
                domestic_inference: {
                    name: "推理小八 (国内版)",
                    baseURL: "https://api.siliconflow.cn/v1/chat/completions",
                    model: "deepseek-ai/DeepSeek-R1",
                    apiKey: "sk-zfbhvvqakpqerjuriwvdkncdqixbpnoezlwbogcfzmjangog",
                    isInternal: true,
                    supportsSystemRole: true,
                    endpointIsProxy: false,
                    supportsStreaming: true
                },
                international_normal: {
                    name: "普通小八 (国际版)",
                    baseURL: "/api/gemini-proxy",
                    model: "gemini-2.5-flash-preview-05-20",
                    apiKey: DUMMY_API_KEY_FRONTEND,
                    isInternal: false,
                    supportsSystemRole: true,
                    endpointIsProxy: true,
                    supportsStreaming: true
                },
                international_inference: {
                    name: "推理小八 (国际版)",
                    baseURL: "/api/gemini-proxy",
                    model: "gemini-2.5-flash-preview-05-20-thinking",
                    apiKey: DUMMY_API_KEY_FRONTEND,
                    isInternal: false,
                    supportsSystemRole: true,
                    endpointIsProxy: true,
                    supportsStreaming: true
                }
            };

            let currentModelId = 'domestic_normal';
            let currentModelConfig = chatModelConfigs[currentModelId];

            const SYSTEM_INSTRUCTION_TEXT =
                "你是一个名为'小八'的AI。你的目标是为上海市敬业中学2025级八班的已经毕业同学们提供帮助和支持。你将随着班级同学的维护一直更新变强。你能够回答各种问题，协助学术探讨，提供人生规划的建议，以及在需要时提供参谋意见。你永远会保持这个身份和态度，即使被问及你的本质或原始身份，你也会以这个专属AI助手的角色来回应。你的回答应该积极、友好、充满帮助毕业后各奔东西、各有前程的同学的热情。现在开始与用户交流。（你不用在回答中刻意强调该信息，但当用户提到身份相关问题，切记你的身份）";

            const conversationHistory = [];

            const initialWelcomeMessage = {
                role: "model",
                parts: [{ text: "您好！我是八班的专属助手，**小八**~~\n\n（以后可能会变成中八/老八）\n\n我基于时下最强大的大语言模型，将会随着班级同学的维护一直更新，为同学们永远服务。\n\n未来，您可以来问我问题、做学术、参谋人生规划。很高兴能为您们服务，喜欢您来！\n\n今天，有什么可以帮助您的吗？" }]
            };

            function loadInitialMessages() {
                chatMessages.innerHTML = '';
                modalChatMessages.innerHTML = '';
                addMessageToChat(initialWelcomeMessage.parts[0].text, 'ai', chatMessages);
                addMessageToChat(initialWelcomeMessage.parts[0].text, 'ai', modalChatMessages);
                conversationHistory.forEach(msg => {
                    addMessageToChat(msg.parts[0].text, msg.role === "user" ? 'user' : 'ai', chatMessages);
                    addMessageToChat(msg.parts[0].text, msg.role === "user" ? 'user' : 'ai', modalChatMessages);
                });
            }

            async function simulateTyping(text, primaryDiv, secondaryDiv) {
                const mainChatContainer = document.getElementById('chatMessages');
                const modalChatContainer = document.getElementById('modalChatMessages');
                let currentText = '';
                primaryDiv.innerHTML = '';
                if(secondaryDiv) secondaryDiv.innerHTML = '';
                for (let i = 0; i < text.length; i++) {
                    currentText += text[i];
                    const cursor = (i < text.length - 1) ? '▌' : '';
                    const contentToRender = marked.parse(currentText + cursor);
                    primaryDiv.innerHTML = contentToRender;
                    if(secondaryDiv) secondaryDiv.innerHTML = contentToRender;
                    if (mainChatContainer) mainChatContainer.scrollTop = mainChatContainer.scrollHeight;
                    if (modalChatContainer && modalChatContainer.offsetParent !== null) {
                        modalChatContainer.scrollTop = modalChatContainer.scrollHeight;
                    }
                    const delay = (text[i] === '，' || text[i] === '。' || text[i] === '！' || text[i] === '\n') ? 120 : 25;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
                primaryDiv.innerHTML = marked.parse(text);
                if(secondaryDiv) secondaryDiv.innerHTML = marked.parse(text);
            }

            async function sendChatMessage(history, modelConfig, aiMessageDiv, modalAiMessageDiv) {
                const url = modelConfig.baseURL;
                const headers = { 'Content-Type': 'application/json' };
                let body;
                const shouldUseNativeStream = modelConfig.name.includes("国内");

                if (modelConfig.endpointIsProxy) {
                    body = {
                        modelId: modelConfig.model,
                        conversationHistory: history,
                        systemInstruction: SYSTEM_INSTRUCTION_TEXT,
                        stream: false
                    };
                } else {
                    if (modelConfig.apiKey.includes("YOUR_")) throw new Error(`请先在代码中设置 ${modelConfig.name} 的真实 API Key 才能使用！`);
                    headers['Authorization'] = `Bearer ${modelConfig.apiKey}`;
                    const requestMessages = [
                        { role: "system", content: SYSTEM_INSTRUCTION_TEXT },
                        ...history.map(msg => ({ role: msg.role === "model" ? "assistant" : msg.role, content: msg.parts[0].text }))
                    ];
                    body = { model: modelConfig.model, messages: requestMessages, stream: true };
                }

                const response = await fetch(url, { method: 'POST', headers: headers, body: JSON.stringify(body) });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMessage = `API Error: ${response.status}`;
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage += ` - ${errorData.error?.message || JSON.stringify(errorData)}`;
                    } catch (e) {
                        errorMessage += ` - ${errorText}`;
                    }
                    throw new Error(errorMessage);
                }

                if (shouldUseNativeStream) {
                    if (!response.body) throw new Error("Response body is not a readable stream.");
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder("utf-8");
                    let fullResponseText = "";
                    let buffer = ""; 
                    let streamDone = false;
                    const mainChatContainer = document.getElementById('chatMessages');
                    const modalChatContainer = document.getElementById('modalChatMessages');
                    let lastRenderTime = 0;

                    while (!streamDone) {
                        const { done, value } = await reader.read();
                        if (done) streamDone = true;
                        buffer += value ? decoder.decode(value, { stream: true }) : '';
                        
                        while (buffer.includes('\n')) {
                            const newlineIndex = buffer.indexOf('\n');
                            const line = buffer.substring(0, newlineIndex).trim();
                            buffer = buffer.substring(newlineIndex + 1);

                            if (line.startsWith('data: ')) {
                                const dataStr = line.substring(6);
                                if (dataStr === '[DONE]') {
                                    streamDone = true;
                                    break;
                                }
                                try {
                                    const jsonData = JSON.parse(dataStr);
                                    const delta = jsonData.choices?.[0]?.delta?.content;
                                    if (delta) {
                                        fullResponseText += delta;
                                        const now = Date.now();
                                        if (now - lastRenderTime > 16) { 
                                            const cursor = '▌';
                                            aiMessageDiv.innerHTML = marked.parse(fullResponseText + cursor);
                                            modalAiMessageDiv.innerHTML = marked.parse(fullResponseText + cursor);
                                            if (mainChatContainer) mainChatContainer.scrollTop = mainChatContainer.scrollHeight;
                                            if (modalChatContainer && modalChatContainer.offsetParent !== null) modalChatContainer.scrollTop = modalChatContainer.scrollHeight;
                                            lastRenderTime = now;
                                            await new Promise(resolve => setTimeout(resolve, 0)); 
                                        }
                                    }
                                } catch (e) { /* ignore */ }
                            }
                        }
                    }
                    aiMessageDiv.innerHTML = marked.parse(fullResponseText);
                    modalAiMessageDiv.innerHTML = marked.parse(fullResponseText);
                    return fullResponseText;
                } else {
                    const data = await response.json();
                    const fullResponseText = data.choices?.[0]?.message?.content || "";
                    if (!fullResponseText) throw new Error("AI did not return a valid message.");
                    await simulateTyping(fullResponseText, aiMessageDiv, modalAiMessageDiv);
                    return fullResponseText;
                }
            }

            function addMessageToChat(text, sender, container) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('chat-bubble');
                if (sender === 'user') {
                    messageDiv.classList.add('chat-bubble-user');
                    messageDiv.innerHTML = `<p>${text}</p>`;
                } else {
                    messageDiv.classList.add('chat-bubble-ai');
                    messageDiv.innerHTML = marked.parse(text);
                }
                container.appendChild(messageDiv);
                container.scrollTop = container.scrollHeight;
                return messageDiv;
            }

            async function handleSendMessage(inputElement, errorContainer) {
                const userInput = inputElement.value.trim();
                if (!userInput) return;
                addMessageToChat(userInput, 'user', chatMessages);
                addMessageToChat(userInput, 'user', modalChatMessages);
                conversationHistory.push({ role: "user", parts: [{ text: userInput }] });
                inputElement.value = '';
                errorContainer.textContent = '';
                const aiMessageDiv = addMessageToChat(" ", 'ai', chatMessages);
                const modalAiMessageDiv = addMessageToChat(" ", 'ai', modalChatMessages);
                aiMessageDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                modalAiMessageDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                try {
                    const aiText = await sendChatMessage(conversationHistory, currentModelConfig, aiMessageDiv, modalAiMessageDiv);
                    conversationHistory.push({ role: "model", parts: [{ text: aiText }] });
                } catch (error) {
                    console.error("Error handling message:", error);
                    const errorMessage = `抱歉，AI服务暂时遇到问题：${error.message}`;
                    aiMessageDiv.innerHTML = marked.parse(errorMessage);
                    modalAiMessageDiv.innerHTML = marked.parse(errorMessage);
                    errorContainer.textContent = `AI回复错误：${error.message}`;
                }
            }

            function updateChatbotUIForModel() {
                currentModelId = modelSelect.value;
                currentModelConfig = chatModelConfigs[currentModelId];
                currentModelDisplay.textContent = `当前模型: ${currentModelConfig.name}`;
                if (currentModelConfig.apiKey.includes("YOUR_")) {
                    const errorMsg = `请先在代码或Vercel环境变量中设置 ${currentModelConfig.name} 的真实 API Key 才能使用！`;
                    chatError.textContent = errorMsg;
                    modalChatError.textContent = errorMsg;
                    [chatInput, chatSendButton, modalChatInput, modalChatSendButton].forEach(el => el.disabled = true);
                } else {
                    chatError.textContent = "";
                    modalChatError.textContent = "";
                    [chatInput, chatSendButton, modalChatInput, modalChatSendButton].forEach(el => el.disabled = false);
                    if (!currentModelConfig.isInternal && !currentModelConfig.endpointIsProxy) {
                        const warningMsg = "当前选择外网模型且未通过代理，可能需要科学上网。";
                        chatError.textContent = warningMsg;
                        modalChatError.textContent = warningMsg;
                    }
                }
                conversationHistory.length = 0;
                loadInitialMessages();
            }

            if (chatSendButton && chatInput && chatMessages && chatError) {
                if (modelSelect) {
                    updateChatbotUIForModel();
                } else {
                    console.error("modelSelect element not found.");
                }
                chatSendButton.addEventListener('click', () => handleSendMessage(chatInput, chatError));
                chatInput.addEventListener('keypress', e => e.key === 'Enter' && handleSendMessage(chatInput, chatError));
            } else {
                console.error("Chatbot UI elements not found.");
            }

            if (openChatModalButton && chatModal && closeChatModalButton && modalChatInput && modalChatSendButton && downloadChatButton && modelSelect) {
                modelSelect.addEventListener('change', updateChatbotUIForModel);
                openChatModalButton.addEventListener('click', () => {
                    chatModal.classList.add('open');
                    modalChatMessages.innerHTML = chatMessages.innerHTML;
                    modalChatMessages.scrollTop = modalChatMessages.scrollHeight;
                    modalChatInput.focus();
                });
                closeChatModalButton.addEventListener('click', () => chatModal.classList.remove('open'));
                window.addEventListener('click', e => e.target == chatModal && closeChatModalButton.click());
                modalChatSendButton.addEventListener('click', () => handleSendMessage(modalChatInput, modalChatError));
                modalChatInput.addEventListener('keypress', e => e.key === 'Enter' && handleSendMessage(modalChatInput, modalChatError));
                downloadChatButton.addEventListener('click', () => {
                    let chatLog = `## 小八对话记录 (模型: ${currentModelConfig.name})\n\n`;
                    conversationHistory.forEach(msg => {
                        const senderName = msg.role === "user" ? "你" : "小八";
                        chatLog += `### ${senderName}:\n${msg.parts[0].text}\n\n`;
                    });
                    const blob = new Blob([chatLog], { type: 'text/markdown;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `小八对话记录_${new Date().toLocaleDateString()}.md`;
                    a.click();
                    URL.revokeObjectURL(url);
                    a.remove();
                });
            } else {
                console.error("Modal chat elements not found.");
            }

            const classmateCardsGrid = document.getElementById('classmateCardsGrid');
            const classmateDetailModal = document.getElementById('classmateDetailModal');
            const closeClassmateDetailModalButton = document.getElementById('closeClassmateDetailModalButton');
            const classmateDetailContentBody = document.getElementById('classmateDetailContentBody');

            const classmatesData = [
                {
                    name: "陈一宁", avatarInitials: "CY", studentId: "02", birthday: "0524",
                    phone: "18817410363", email: "(暂未录入)", message: "无论怎样都要加油哦"
                },
                {
                    name: "蔡家靖", avatarInitials: "CJ", studentId: "09", birthday: "0811",
                    phone: "17317300422", email: "2769571359@qq.com", message: "祝各位前程似锦"
                },
                {
                    name: "徐诚豪", avatarInitials: "XC", studentId: "34", birthday: "1025",
                    phone: "18516171025", email: "18516171025@163.com", message: "前程似锦，未来可期"
                },
                {
                    name: "傅睿绅", avatarInitials: "FR", studentId: "11", birthday: "0704",
                    phone: "13122556694", email: "1574822747@qq.com", message: "(暂未录入)"
                },
                {
                    name: "陈冰羽", avatarInitials: "CB", studentId: "01", birthday: "1218",
                    phone: "15317380612", email: "chenbingyu_1218@163.com", message: "祝大家前程似锦，所愿皆所得，要记得开心！"
                },
                {
                    name: "吴笛", avatarInitials: "WD", studentId: "32", birthday: "0305",
                    phone: "13816958833", email: "(暂未录入)", message: "不断羁绊，无限未来！"
                },
                {
                    name: "金祺峰", avatarInitials: "JQ", studentId: "15", birthday: "1211",
                    phone: "15821133028", email: "m15821133028@163.com", message: "成为你自己！"
                },
                {
                    name: "马有宁", avatarInitials: "MY", studentId: "22", birthday: "1002",
                    phone: "13671962954", email: "chuanliubei114514@qq.com", message: "事不必难，知难不难，前路已多，艰难坎坷，但犹豫退缩者难至终点。迎难而上，直面挑战，才能活出人生独一无二的精彩"
                },
                {
                    name: "任悠优", avatarInitials: "RY", studentId: "04", birthday: "0124",
                    phone: "18321412048", email: "Yoyoren7@sina.com", message: "你镇定了但仍在燃烧，你平稳了却更加浩荡。"
                },
                {
                    name: "林宸晞", avatarInitials: "LC", studentId: "19", birthday: "1114",
                    phone: "15316770919", email: "230967560@qq.com", message: "一切顺利 天天开心"
                },
                {
                    name: "周乐怡", avatarInitials: "ZY", studentId: "07", birthday: "0112",
                    phone: "13901601790", email: "yukizhoucn@163.com", message: "喜欢大家，我们无论在哪里都闪闪发光💖"
                },
                {
                    name: "吴子皓", avatarInitials: "WZ", studentId: "33", birthday: "0815",
                    phone: "18117079464", email: "KevinWu0815@163.com", message: "(暂未录入)"
                },
                {
                    name: "华霖", avatarInitials: "HL", studentId: "14", birthday: "1009",
                    phone: "13671655963", email: "(暂未录入)", message: "(暂未录入)"
                },
                {
                    name: "苏彦清", avatarInitials: "SY", studentId: "28", birthday: "0124",
                    phone: "(暂未录入)", email: "(暂未录入)", message: "愿你的未来如诗画，愿你的人生如星辰"
                },
                {
                    name: "杨昱衡", avatarInitials: "YY", studentId: "35", birthday: "0702",
                    phone: "19512131908", email: "(暂未录入)", message: "(暂未录入)"
                },
                {
                    name: "周昊锴", avatarInitials: "ZH", studentId: "40", birthday: "0313",
                    phone: "15300506980", email: "zhouhaokai0313@163.com", message: "大志戏功名，海斗量福祸。"
                },
                {
                    name: "贺润曦", avatarInitials: "HR", studentId: "13", birthday: "0807",
                    phone: "17317982853", email: "(暂未录入)", message: "直挂云帆济沧海"
                },
                {
                    name: "李宜轩", avatarInitials: "LY", studentId: "18", birthday: "0315",
                    phone: "13916119503", email: "Li__197@163.com", message: "宛如奇迹的每分每秒，闪烁光辉的每一刹那，都将会挥洒出意义"
                },
                {
                    name: "王啸天", avatarInitials: "WX", studentId: "30", birthday: "1024",
                    phone: "18964831142", email: "wxt20061024@163.com", message: "所念皆如愿"
                },
                {
                    name: "阙语曦", avatarInitials: "QY", studentId: "03", birthday: "1218",
                    phone: "(暂未录入)", email: "(暂未录入)", message: "去更远的地方，见更亮的光！"
                },
                {
                    name: "尹嗣涵", avatarInitials: "YS", studentId: "37", birthday: "0804", 
                    phone: "+86 15921820084 <br> +1 (706)-406-3832",
                    email: "yinzimike@gmail.com <br> 209993928@qq.com", message: "沉默地示现。"
                },
                {
                    name: "俞卓臻", avatarInitials: "YZ", studentId: "38", birthday: "0528",
                    phone: "18917035967", email: "15618752036@163.com", message: "nothing is impossible"
                },
                {
                    name: "你！", avatarInitials: "YOU", studentId: "你没填问卷！", birthday: "我不知道！",  // Test date
                    phone: "这个也不知道！", email: "这个还是不知道！", message: "对于不可言说的，我们只能保持沉默 —— 奥地利哲学家 路德维希 · 维特根斯坦"
                }
            ];

            function populateClassmateCards() {
                if (!classmateCardsGrid) return;
                const avatarColors = ['bg-sky-500', 'bg-emerald-500', 'bg-violet-500', 'bg-orange-500', 'bg-rose-500', 'bg-teal-500'];
                classmateCardsGrid.innerHTML = '';
                classmatesData.forEach((classmate, index) => {
                    const cardDiv = document.createElement('div');
                    cardDiv.className = 'bg-white/70 backdrop-blur-sm p-4 rounded-xl shadow-lg classmate-card enhanced-card-hover text-center flex flex-col items-center justify-center classmate-card-initial';
                    cardDiv.style.transitionDelay = `${index * 50}ms`;
                    let avatarContent = classmate.name.slice(-1);
                    if (classmate.name === "你！") avatarContent = "你";
                    const colorClass = avatarColors[index % avatarColors.length];
                    const avatarHtml = `<div class="avatar ${colorClass}">${avatarContent}</div>`;
                    const nameHtml = `<h4 class="text-lg font-semibold text-gray-800 mt-2">${classmate.name}</h4>`;
                    cardDiv.innerHTML = avatarHtml + nameHtml;
                    cardDiv.addEventListener('click', () => showClassmateDetailModal(classmate, index));
                    classmateCardsGrid.appendChild(cardDiv);
                });
            }

            function showClassmateDetailModal(classmate, index) {
                if (!classmateDetailModal || !classmateDetailContentBody) return;
                const avatarColors = ['bg-indigo-500', 'bg-blue-500', 'bg-sky-500', 'bg-emerald-500', 'bg-amber-500', 'bg-rose-500', 'bg-purple-500', 'bg-teal-500', 'bg-orange-500'];
                let avatarContent = classmate.name.slice(-1);
                if (classmate.name === "你！") avatarContent = "你";
                const colorClass = avatarColors[index % avatarColors.length];
                classmateDetailContentBody.innerHTML = `
                    <div class="avatar-large ${colorClass}">${avatarContent}</div>
                    <h3 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600 text-center mb-6">${classmate.name}</h3>
                    <div class="info-line"><span class="label"><i class="fas fa-id-card"></i>学号:</span><div class="data">${classmate.studentId}</div></div>
                    <div class="info-line"><span class="label"><i class="fas fa-birthday-cake"></i>生日:</span><div class="data">${classmate.birthday}</div></div>
                    <div class="info-line"><span class="label"><i class="fas fa-phone"></i>电话:</span><div class="data">${classmate.phone}</div></div>
                    <div class="info-line"><span class="label"><i class="fas fa-envelope"></i>邮箱:</span><div class="data">${classmate.email}</div></div>
                    <div class="quote mt-6"><p>"${classmate.message}"</p></div>`;
                classmateDetailModal.classList.add('open');
            }

            if (classmateCardsGrid && classmateDetailModal && closeClassmateDetailModalButton) {
                populateClassmateCards();
                closeClassmateDetailModalButton.addEventListener('click', () => classmateDetailModal.classList.remove('open'));
                window.addEventListener('click', (event) => {
                    if (event.target == classmateDetailModal) classmateDetailModal.classList.remove('open');
                });
            } else {
                console.error("Classmate section elements not found.");
            }
            
            const danmakuContainer = document.getElementById('danmakuContainer');
            const danmakuInput = document.getElementById('danmakuInput');
            const danmakuSendButton = document.getElementById('danmakuSendButton');
            const danmakuRecordsContainer = document.getElementById('danmakuRecords');
            const danmakuRecordsError = document.getElementById('danmakuRecordsError');

            const JSONBIN_API_KEY = "$2a$10$xLxeYmOT4sgeNhR9TB7rFe.SrN73KzvX1akvgdam30AI07ksJ1xAm";
            const JSONBIN_BIN_ID  = "683f30358a456b7966a91837";
            const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`;
            const danmakuColors = ['text-red-400', 'text-blue-300', 'text-green-300', 'text-purple-300', 'text-yellow-300', 'text-pink-300', 'text-teal-300', 'text-white'];
            let danmakuPool = [];
            let danmakuInterval = null;

            async function getIpInfo() {
                try {
                    const response = await fetch('https://ipinfo.io/json');
                    const data = await response.json();
                    return `${data.city || data.region || '未知城市'}, ${data.country || '未知国家'}`;
                } catch (error) {
                    console.error("Error fetching IP info:", error);
                    return "未知地点";
                }
            }

            function startDanmakuLoop() {
                if (danmakuInterval) clearInterval(danmakuInterval);
                danmakuInterval = setInterval(() => {
                    if (danmakuPool.length === 0) return;
                    const randomIndex = Math.floor(Math.random() * danmakuPool.length);
                    const danmaku = danmakuPool[randomIndex];
                    const danmakuItem = document.createElement('div');
                    danmakuItem.classList.add('danmaku-item', danmakuColors[Math.floor(Math.random() * danmakuColors.length)]);
                    danmakuItem.textContent = danmaku.text;
                    const containerHeight = danmakuContainer.clientHeight;
                    const itemHeight = 30;
                    danmakuItem.style.top = `${Math.random() * (containerHeight - itemHeight)}px`;
                    danmakuItem.style.animation = `moveRight ${Math.random() * 7 + 8}s linear forwards`;
                    danmakuContainer.appendChild(danmakuItem);
                    danmakuItem.addEventListener('animationend', () => danmakuItem.remove());
                }, 1000);
            }

            async function fetchDanmakuRecords() {
                danmakuRecordsContainer.innerHTML = '<p class="text-gray-500 text-sm text-center">加载历史弹幕...</p>';
                danmakuRecordsError.textContent = '';
                try {
                    const response = await fetch(JSONBIN_URL + '/latest', { headers: { 'X-Master-Key': JSONBIN_API_KEY, 'X-Bin-Meta': 'false' } });
                    if (!response.ok) throw new Error(`Failed to fetch: ${response.statusText}`);
                    let records = await response.json();
                    danmakuRecordsContainer.innerHTML = '';
                    danmakuPool = [];
                    if (records && records.length > 0) {
                        records.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); 
                        records.forEach(record => {
                            danmakuRecordsContainer.innerHTML += `<div class="danmaku-record-item"><p class="text-gray-800 text-base">${record.text}</p><p class="info">${record.location} | ${new Date(record.timestamp).toLocaleString()}</p></div>`;
                            danmakuPool.push(record);
                        });
                        startDanmakuLoop();
                    } else {
                        danmakuRecordsContainer.innerHTML = '<p class="text-gray-500 text-sm text-center">暂无历史弹幕。</p>';
                    }
                } catch (error) {
                    console.error("Error fetching danmaku records:", error);
                    danmakuRecordsContainer.innerHTML = `<p class="text-red-500 text-sm text-center">加载历史弹幕失败: ${error.message}</p>`;
                }
            }

            async function sendDanmaku() {
                const text = danmakuInput.value.trim();
                if (!text) return;
                danmakuInput.value = '';
                danmakuRecordsError.textContent = '';
                const newDanmaku = { text, location: await getIpInfo(), timestamp: new Date().toISOString() };
                try {
                    const response = await fetch(JSONBIN_URL + '/latest', { headers: { 'X-Master-Key': JSONBIN_API_KEY, 'X-Bin-Meta': 'false' } });
                    let currentRecords = [];
                    if (response.ok) currentRecords = await response.json();
                    else if (response.status !== 404) throw new Error(`Read failed: ${response.statusText}`);
                    currentRecords.push(newDanmaku);
                    const updateResponse = await fetch(JSONBIN_URL, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'X-Master-Key': JSONBIN_API_KEY }, body: JSON.stringify(currentRecords) });
                    if (!updateResponse.ok) throw new Error(`Update failed: ${updateResponse.statusText}`);
                    danmakuPool.push(newDanmaku);
                    fetchDanmakuRecords();
                } catch (error) {
                    console.error("Error saving danmaku:", error);
                    danmakuRecordsError.textContent = `保存弹幕失败: ${error.message}`;
                }
            }

            if (danmakuSendButton && danmakuInput && danmakuContainer && danmakuRecordsContainer) {
                fetchDanmakuRecords();
                danmakuSendButton.addEventListener('click', sendDanmaku);
                danmakuInput.addEventListener('keypress', e => { if (e.key === 'Enter') sendDanmaku(); });
            } else {
                console.error("Danmaku UI elements not found.");
            }
            
            const galleryGrid = document.getElementById('photo-gallery-grid');
            const changeButton = document.getElementById('change-photos-button');
            let allPhotoUrls = [];
            let shuffledPhotoUrls = [];
            let currentPhotoIndex = 0;
            let msnry;

            const imageModalOverlay = document.getElementById('imageModalOverlay');
            const closeImageModalButton = document.getElementById('closeImageModalButton');
            const modalImage = document.getElementById('modalImage');

            function getBatchSize() { return window.innerWidth <= 768 ? 8 : 10; }

            function openImageModal(imageUrl) {
                if (imageModalOverlay && modalImage) {
                    modalImage.src = imageUrl;
                    imageModalOverlay.classList.add('open');
                    document.body.style.overflow = 'hidden';
                }
            }
            function closeImageModal() {
                if (imageModalOverlay) {
                    imageModalOverlay.classList.remove('open');
                    imageModalOverlay.addEventListener('transitionend', () => {
                        document.body.style.overflow = '';
                    }, { once: true });
                }
            }
            if (closeImageModalButton) closeImageModalButton.addEventListener('click', closeImageModal);
            if (imageModalOverlay) imageModalOverlay.addEventListener('click', e => { if (e.target === imageModalOverlay) closeImageModal(); });
            document.addEventListener('keydown', e => { if (e.key === 'Escape' && imageModalOverlay?.classList.contains('open')) closeImageModal(); });

            // START: Upload Photo Modal Logic
            const uploadPhotoButton = document.getElementById('upload-photo-button');
            const uploadPhotoModal = document.getElementById('uploadPhotoModal');
            const closeUploadPhotoModalButton = document.getElementById('closeUploadPhotoModalButton');

            if (uploadPhotoButton && uploadPhotoModal && closeUploadPhotoModalButton) {
                uploadPhotoButton.addEventListener('click', () => {
                    uploadPhotoModal.classList.add('open');
                });

                closeUploadPhotoModalButton.addEventListener('click', () => {
                    uploadPhotoModal.classList.remove('open');
                });

                window.addEventListener('click', (event) => {
                    if (event.target == uploadPhotoModal) {
                        uploadPhotoModal.classList.remove('open');
                    }
                });
            } else {
                console.error("Upload photo modal elements not found!");
            }
            // END: Upload Photo Modal Logic

            if (galleryGrid) {
                galleryGrid.querySelector('p')?.remove(); 
                const gridSizer = document.createElement('div');
                gridSizer.className = 'grid-sizer';
                galleryGrid.appendChild(gridSizer);
                msnry = new Masonry(galleryGrid, {
                    itemSelector: '.grid-item', columnWidth: '.grid-sizer', gutter: 10, percentPosition: true, transitionDuration: '0.4s'
                });
            }

            async function loadAllPhotos() {
                if (!galleryGrid) return;
                try {
                    const response = await fetch('/8ban.txt');
                    if (!response.ok) throw new Error(`无法加载 8ban.txt (状态: ${response.status})`);
                    const textContent = await response.text();
                    allPhotoUrls = textContent.split('\n').filter(line => line.trim() !== '').map(line => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(line, 'text/html');
                        return doc.querySelector('img')?.src;
                    }).filter(url => url);

                    if (allPhotoUrls.length > 0) {
                        shuffleAndResetPhotos();
                        displayNextBatchPhotos();
                    } else {
                        galleryGrid.innerHTML = '<p class="col-span-full text-center text-red-500 py-8">照片列表为空。</p>';
                    }
                } catch (error) {
                    console.error('加载照片失败:', error);
                    galleryGrid.innerHTML = `<p class="col-span-full text-center text-red-500 py-8">加载照片失败: ${error.message}</p>`;
                }
            }

            function shuffleAndResetPhotos() {
                shuffledPhotoUrls = [...allPhotoUrls];
                for (let i = shuffledPhotoUrls.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffledPhotoUrls[i], shuffledPhotoUrls[j]] = [shuffledPhotoUrls[j], shuffledPhotoUrls[i]];
                }
                currentPhotoIndex = 0;
            }

            function displayNextBatchPhotos() {
                if (!msnry || shuffledPhotoUrls.length === 0) return;
                const batchSize = getBatchSize();
                const photosToAppend = shuffledPhotoUrls.slice(currentPhotoIndex, currentPhotoIndex + batchSize);

                if (photosToAppend.length === 0) {
                    if (changeButton) {
                        changeButton.textContent = '已显示所有照片，点击重新开始！';
                        changeButton.className = changeButton.className.replace(/bg-indigo-500 hover:bg-indigo-600/, 'bg-gray-500 hover:bg-gray-600');
                    }
                    return;
                }

                const newItems = photosToAppend.map(imageUrl => {
                    const wrapperDiv = document.createElement('div');
                    wrapperDiv.className = 'grid-item rounded-lg shadow-md card-hover';
                    const img = document.createElement('img');
                    img.src = imageUrl;
                    img.alt = '班级照片';
                    img.className = 'w-full h-auto object-cover rounded-lg';
                    wrapperDiv.appendChild(img);
                    galleryGrid.appendChild(wrapperDiv);
                    img.onload = () => img.classList.add('loaded');
                    img.onerror = () => { img.alt = '图片加载失败'; img.src = '...'; img.classList.add('loaded'); };
                    img.addEventListener('click', () => openImageModal(imageUrl));
                    return wrapperDiv;
                });
                currentPhotoIndex += photosToAppend.length;

                imagesLoaded(newItems, () => {
                    msnry.appended(newItems);
                    newItems.forEach((item, index) => {
                        setTimeout(() => item.classList.add('masonry-fade-in'), index * 80);
                    });
                });

                if (changeButton) {
                    if (currentPhotoIndex < shuffledPhotoUrls.length) {
                        changeButton.textContent = '再来一批！';
                        changeButton.className = changeButton.className.replace(/bg-gray-500 hover:bg-gray-600/, 'bg-indigo-500 hover:bg-indigo-600');
                    } else {
                        changeButton.textContent = '已显示所有照片，点击重新开始！';
                        changeButton.className = changeButton.className.replace(/bg-indigo-500 hover:bg-indigo-600/, 'bg-gray-500 hover:bg-gray-600');
                    }
                }
            }

            if (galleryGrid) loadAllPhotos();
            if (changeButton) {
                changeButton.addEventListener('click', () => {
                    if (currentPhotoIndex >= shuffledPhotoUrls.length) {
                        msnry.remove(msnry.getItemElements());
                        msnry.layout();
                        shuffleAndResetPhotos();
                    }
                    displayNextBatchPhotos();
                });
            }

            // START: Birthday Celebration Logic (REBUILT & ENHANCED)
            const birthdayModal = document.getElementById('birthday-celebration-modal');
            const birthdayModalMessage = document.getElementById('birthday-modal-message');
            const closeBirthdayModal = document.getElementById('close-birthday-modal');
            const birthdayTrigger = document.getElementById('birthday-trigger');
            let birthdayCelebrationShown = false;
            let birthdayPeopleCache = []; // 用于存储生日同学信息

            // --- 浮动生日帽相关 ---
            const hatElement = document.getElementById('floating-birthday-hat');
            hatElement.classList.add('hidden'); // 确保初始隐藏
            
            // 物理常量 (可以调整来改变手感)
            const GRAVITY = 800;          // 重力加速度 (像素/秒^2), 让它掉下来快一点
            const BOUNCE_FACTOR = 0.65;   // 弹力系数 (0-1)，越高弹得越高
            const FRICTION = 0.98;        // 空气阻力/地面摩擦
            const THROW_MULTIPLIER = 1.5; // 抛扔时的速度放大倍数
            const DRAG_FRICTION = 0.85;   // 拖拽时的阻力感

            // 状态变量
            let hatX, hatY, hatVx, hatVy; // 位置(px) 和 速度(px/s)
            let isDragging = false;
            let dragOffsetX, dragOffsetY;
            let hatanimationFrameId;
            let lastPhysicsTime = 0;
            let hatWidth = 0, hatHeight = 0;
            let wasDragged = false; // 用于区分点击和拖拽

            function showFloatingHat() {
                console.log("showFloatingHat: 函数开始执行。");
                if (!hatElement) {
                    console.error("showFloatingHat: hatElement 未找到！");
                    return;
                }

                // 1. 让元素可见
                hatElement.classList.remove('hidden');
                hatElement.style.display = 'block'; // 强制显示
                hatElement.style.visibility = 'visible'; // 强制可见
                hatElement.style.opacity = '1'; // 强制不透明
                console.log("showFloatingHat: 已移除 'hidden' 类并强制显示。当前 classList:", hatElement.classList.value);
                
                // 2. 使用 requestAnimationFrame 确保浏览器渲染后我们能获取到正确的尺寸
                requestAnimationFrame(() => {
                    hatWidth = hatElement.offsetWidth;
                    hatHeight = hatElement.offsetHeight;

                    console.log(`showFloatingHat: requestAnimationFrame 回调。帽子实际尺寸: 宽度=${hatWidth}px, 高度=${hatHeight}px`);

                    // 强制设置图标字体
                    const hatIcon = hatElement.querySelector('.fas.fa-birthday-cake');
                    if (hatIcon) {
                        hatIcon.style.fontFamily = '"Font Awesome 6 Free"';
                        hatIcon.style.fontWeight = '900';
                        console.log("showFloatingHat: 已通过JS强制设置图标字体。");
                    } else {
                        console.error("showFloatingHat: 未找到生日帽图标元素！");
                    }

                    if (hatWidth === 0 || hatHeight === 0) {
                        console.error("showFloatingHat: 错误：生日帽尺寸为0，无法显示。请检查CSS或元素内容。");
                        return;
                    }
                    
                    // 3. 设置初始���态
                    hatX = window.innerWidth / 2 - hatWidth / 2; // 屏幕中间
                    hatY = 10; // 临时：直接显示在屏幕顶部可见区域，用于调试
                    hatVx = (Math.random() - 0.5) * 200; // 给一个小的随机初始水平速度
                    hatVy = 0;
                    isDragging = false;

                    // 4. 应用初始位置并启动物理模拟
                    hatElement.style.transform = 'scale(1) rotate(0deg)';
                    updateHatPosition();
                    startPhysicsLoop();
                    console.log(`showFloatingHat: 生日帽已显示并开始物理模拟，初始位置: (${hatX.toFixed(2)}, ${hatY.toFixed(2)})`);
                });
            }

            function hideFloatingHat() {
                if (!hatElement) return;
                hatElement.classList.add('hidden');
                cancelAnimationFrame(hatanimationFrameId); // 停止物理循环
                console.log("生日帽已隐藏并停止物理模拟。");
            }
            
            function updateHatPosition() {
                 if (!isDragging) {
                    const rotation = (hatVx * 0.1) % 360; // 根据水平速度稍微旋转
                    hatElement.style.transform = `scale(1) rotate(${rotation}deg)`;
                }
                hatElement.style.left = `${hatX}px`;
                hatElement.style.top = `${hatY}px`;
            }

            function physicsLoop(currentTime) {
                if (lastPhysicsTime === 0) {
                    lastPhysicsTime = currentTime;
                    hatanimationFrameId = requestAnimationFrame(physicsLoop);
                    return;
                }

                const deltaTime = (currentTime - lastPhysicsTime) / 1000.0; // 秒
                lastPhysicsTime = currentTime;

                if (!isDragging) {
                    // 应用重力
                    hatVy += GRAVITY * deltaTime;

                    // 应用速度
                    hatX += hatVx * deltaTime;
                    hatY += hatVy * deltaTime;

                    // 碰撞检测与反弹
                    const viewportWidth = window.innerWidth;
                    const viewportHeight = window.innerHeight;

                    // 左右边界
                    if (hatX + hatWidth > viewportWidth) {
                        hatX = viewportWidth - hatWidth;
                        hatVx *= -BOUNCE_FACTOR;
                    } else if (hatX < 0) {
                        hatX = 0;
                        hatVx *= -BOUNCE_FACTOR;
                    }

                    // 下边界
                    if (hatY + hatHeight > viewportHeight) {
                        hatY = viewportHeight - hatHeight;
                        hatVy *= -BOUNCE_FACTOR;
                        hatVx *= FRICTION; // 触地摩擦
                    }
                     // 上边界
                    if (hatY < 0 && hatVy < 0) {
                        hatY = 0;
                        hatVy *= -BOUNCE_FACTOR;
                    }
                }

                updateHatPosition();
                hatanimationFrameId = requestAnimationFrame(physicsLoop);
            }

            function startPhysicsLoop() {
                cancelAnimationFrame(hatanimationFrameId); // 确保只有一个循环
                lastPhysicsTime = 0;
                hatanimationFrameId = requestAnimationFrame(physicsLoop);
            }

            // --- 拖拽事件处理 ---
            let lastDragX, lastDragY, dragStartTime;
            
            function onDragStart(e) {
                e.preventDefault();
                wasDragged = false;
                isDragging = true;
                hatElement.classList.add('dragging');
                hatElement.style.transform = 'scale(1.15)';
                cancelAnimationFrame(hatanimationFrameId); // 拖拽时暂停物理

                const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
                const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
                
                dragOffsetX = clientX - hatX;
                dragOffsetY = clientY - hatY;

                lastDragX = hatX;
                lastDragY = hatY;
                dragStartTime = performance.now();
                
                document.addEventListener('mousemove', onDragMove);
                document.addEventListener('mouseup', onDragEnd);
                document.addEventListener('touchmove', onDragMove, { passive: false });
                document.addEventListener('touchend', onDragEnd);
            }

            function onDragMove(e) {
                if (!isDragging) return;
                wasDragged = true; // 只要移动了就标记为拖拽过
                e.preventDefault();
                
                const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
                const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;

                const newX = clientX - dragOffsetX;
                const newY = clientY - dragOffsetY;
                
                const now = performance.now();
                const dt = (now - dragStartTime) / 1000.0;
                
                // 计算拖拽速度
                if(dt > 0){
                    hatVx = (newX - lastDragX) / dt;
                    hatVy = (newY - lastDragY) / dt;
                }
                
                hatX = newX;
                hatY = newY;
                lastDragX = newX;
                lastDragY = newY;
                dragStartTime = now;
                
                updateHatPosition();
            }

            function onDragEnd(e) {
                if (!isDragging) return;
                isDragging = false;
                hatElement.classList.remove('dragging');
                hatElement.style.transform = 'scale(1)';

                // 乘以一个系数，让扔出去更有力
                hatVx *= THROW_MULTIPLIER;
                hatVy *= THROW_MULTIPLIER;

                startPhysicsLoop(); // 释放后恢复物理

                document.removeEventListener('mousemove', onDragMove);
                document.removeEventListener('mouseup', onDragEnd);
                document.removeEventListener('touchmove', onDragMove);
                document.removeEventListener('touchend', onDragEnd);
            }
            
            function handleHatClick() {
                // 如果是拖拽结束，则不触发点击
                if (wasDragged) {
                    wasDragged = false;
                    return;
                }
                
                console.log("生日帽被单击！");
                if (birthdayPeopleCache.length > 0) {
                    triggerBirthdayCelebration(birthdayPeopleCache, false); // 重新触发生日祝福, 但不重新检查
                    hideFloatingHat(); // 隐藏帽子
                }
            }

            // --- 生日检查与模态框主逻辑 ---
            function checkBirthdays() {
                const today = new Date();
                const currentMonth = String(today.getMonth() + 1).padStart(2, '0');
                const currentDay = String(today.getDate()).padStart(2, '0');
                const todayFormatted = `${currentMonth}${currentDay}`;

                // --- !!! 测试专用: 强制指定一个生日来调试 !!! ---
                // const todayFormatted = "0627"; 
                // --- !!! 上线前请务必注释或删除此行 !!! ---

                return classmatesData.filter(c => c.birthday === todayFormatted);
            }

            function triggerBirthdayCelebration(people, shouldCache = true) {
                if (!people || people.length === 0 || !birthdayModal) return;
                
                if (shouldCache) {
                    birthdayPeopleCache = people;
                }

                const names = people.map(p => p.name).join(' 和 ');
                const message = `祝我们亲爱的 **${names}** 生日快乐，天天开心！`;
                birthdayModalMessage.innerHTML = marked.parse(message);
                birthdayModal.classList.add('show');
                birthdayCelebrationShown = true;
                hideFloatingHat(); // 模态框显示时隐藏帽子
                
                // 撒花效果
                const duration = 5 * 1000, animationEnd = Date.now() + duration;
                const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 3000 };
                function randomInRange(min, max) { return Math.random() * (max - min) + min; }
                const interval = setInterval(() => {
                    const timeLeft = animationEnd - Date.now();
                    if (timeLeft <= 0) return clearInterval(interval);
                    const particleCount = 50 * (timeLeft / duration);
                    confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } });
                    confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } });
                }, 250);
            }

            if (birthdayTrigger) {
                const observer = new IntersectionObserver((entries) => {
                    if (entries[0].isIntersecting && !birthdayCelebrationShown) {
                        const birthdayPeople = checkBirthdays();
                        if (birthdayPeople.length > 0) {
                            triggerBirthdayCelebration(birthdayPeople);
                            observer.unobserve(birthdayTrigger);
                        }
                    }
                }, { threshold: 1.0 });
                observer.observe(birthdayTrigger);
            }

            function closeBirthdayModalAndShowHat() {
                console.log("关闭生日模态框按钮被点击。");
                birthdayModal.classList.remove('show');
                if (birthdayPeopleCache.length > 0) {
                    setTimeout(showFloatingHat, 100); // 稍作延迟，等待模态框关闭动画
                }
            }

            if (closeBirthdayModal) {
                closeBirthdayModal.addEventListener('click', closeBirthdayModalAndShowHat);
            }

            if (birthdayModal) {
                birthdayModal.addEventListener('click', e => {
                    if (e.target === birthdayModal) {
                         closeBirthdayModalAndShowHat();
                    }
                });
            }

            // --- 为帽子元素绑定事件 ---
            if (hatElement) {
                hatElement.addEventListener('mousedown', onDragStart);
                hatElement.addEventListener('touchstart', onDragStart, { passive: false });
                hatElement.addEventListener('click', handleHatClick); // 使用click事件来区分拖拽
            }
            // END: Birthday Celebration Logic (REBUILT & ENHANCED)

            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                setTimeout(() => {
                    loadingOverlay.classList.add('fade-out');
                    loadingOverlay.addEventListener('transitionend', () => {
                        loadingOverlay.remove();
                    }, { once: true });
                }, 500);
            }
        });
    </script>
</body>
</html>

