<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>青春纪念册 v8 - 八班专属</title>
    <script src="https://cdn.tailwindcss.com/3.3.3"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- 引入 Marked.js 用于 Markdown 渲染 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: #2d3748;
            overflow-x: hidden;
        }

        .glassmorphism {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 28px 0 rgba(31, 38, 135, 0.2);
        }

        /* Enhanced hover effect for specific cards */
        .enhanced-card-hover {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .enhanced-card-hover:hover {
            transform: scale(1.03) translateY(-3px);
            box-shadow: 0 15px 30px -5px rgba(59, 130, 246, 0.25), 0 8px 10px -6px rgba(59, 130, 246, 0.2); /* Blue glow */
        }

        .highlight-text {
            position: relative;
            display: inline-block;
        }

        .highlight-text::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 10px;
            background-color: rgba(99, 102, 241, 0.2);
            z-index: -1;
        }

        .mobile-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            padding: 1rem;
            margin: 0.5rem;
            border-radius: 0.75rem;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            transform-origin: top;
            transform: scaleY(0);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            z-index: 100;
        }

        .mobile-menu.active {
            transform: scaleY(1);
            opacity: 1;
        }

        /* Tool area reveal animation */
        .tools-grid-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.7s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.5s ease-out, transform 0.5s ease-out;
            opacity: 0;
            transform: translateY(20px);
        }

        .tools-grid-container.active {
            max-height: 2000px; /* Adjust if needed for more tools */
            opacity: 1;
            transform: translateY(0);
        }

        /* Chat bubble styles */
        .chat-bubble {
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            margin-bottom: 0.5rem;
            max-width: 75%;
            word-wrap: break-word;
        }
        .chat-bubble-user {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
        }
        .chat-bubble-ai {
            background-color: #e5e7eb; /* gray-200 */
            color: #1f2937; /* gray-800 */
            margin-right: auto;
            border-bottom-left-radius: 0.25rem;
        }
        /* Markdown 渲染后的样式优化 */
        .chat-bubble-ai p:first-child { margin-top: 0; }
        .chat-bubble-ai p:last-child { margin-bottom: 0; }
        .chat-bubble-ai pre {
            background-color: #2d3748; /* Dark background for code blocks */
            color: #e2e8f0; /* Light text color */
            padding: 0.75rem;
            border-radius: 0.5rem;
            overflow-x: auto; /* Enable horizontal scrolling for long code lines */
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            font-size: 0.875rem; /* text-sm */
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            line-height: 1.5; /* improve readability of code */
        }
        .chat-bubble-ai code {
            background-color: #cbd5e0; /* lighter gray for inline code */
            padding: 0.2em 0.4em;
            border-radius: 0.25rem;
            font-size: 0.875em;
        }
        .chat-bubble-ai ul, .chat-bubble-ai ol {
            margin-left: 1.25rem; /* space-x-5 for lists */
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            list-style-type: disc; /* default for ul */
        }
        .chat-bubble-ai ol {
            list-style-type: decimal;
        }


        #chatMessages {
            scroll-behavior: smooth;
        }

        /* Danmaku animation */
        @keyframes moveRight {
            0% { transform: translateX(-100%); opacity: 1;}
            90% { opacity: 1; }
            100% { transform: translateX(100vw); opacity: 0; }
        }
        .danmaku-item {
            position: absolute;
            white-space: nowrap;
            font-weight: 500;
            padding: 5px 10px;
            border-radius: 5px;
            background-color: rgba(0,0,0,0.1); /* Slight background for readability */
        }

        /* Timeline dot improvement */
        .timeline-dot {
            width: 12px;
            height: 12px;
            background-color: #60a5fa; /* blue-400 */
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 3px #60a5fa;
        }

        /* Modal Chatbot Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            backdrop-filter: blur(8px); /* Blur background */
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .modal.open {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative;
            width: 90%;
            max-width: 960px; /* Max width for larger screens */
            height: 90%;
            max-height: 700px; /* Max height for larger screens */
            display: flex;
            flex-direction: column;
            transform: translateY(20px);
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .modal.open .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            color: #aaa;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        .modal-close:hover,
        .modal-close:focus {
            color: #333;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 1rem;
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            background-color: #f8fafc;
        }
        .modal-chat-input-area {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding-top: 0.5rem;
        }

        /* Danmaku Records Specific Styles */
        .danmaku-record-item {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }
        .danmaku-record-item p {
            margin: 0;
            line-height: 1.4;
        }
        .danmaku-record-item .info {
            font-size: 0.75rem; /* text-xs */
            color: #64748b; /* slate-500 */
            margin-top: 0.5rem;
            text-align: right;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- 导航条 -->
    <nav class="glassmorphism sticky top-0 z-50 p-4 mb-8" id="mainNav">
        <div class="container mx-auto flex items-center justify-between">
            <div class="text-xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 text-transparent bg-clip-text">
                <i class="fas fa-book mr-2"></i>青春纪念册 v8
            </div>
            <div class="hidden md:flex space-x-6">
                <a href="#home" class="text-gray-600 hover:text-blue-600 transition-colors">首页</a>
                <a href="#memory-area" class="text-gray-600 hover:text-blue-600 transition-colors">回忆区</a>
                <a href="#tool-area" class="text-gray-600 hover:text-blue-600 transition-colors">工具区</a>
                <a href="#chatbot-area" class="text-gray-600 hover:text-blue-600 transition-colors">Chat with 小八</a>
                <a href="#message-area" class="text-gray-600 hover:text-blue-600 transition-colors">留言区</a>
            </div>
            <button class="md:hidden text-gray-600 focus:outline-none" id="mobileMenuButton" aria-label="导航菜单">
                <i class="fas fa-bars text-xl"></i>
            </button>

            <div class="mobile-menu md:hidden" id="mobileMenu">
                <a href="#home" class="block py-2 px-3 text-gray-600 hover:text-blue-600 transition-colors rounded-md hover:bg-blue-50 flex items-center"><i class="fas fa-home mr-3 text-blue-500 w-5 text-center"></i>首页</a>
                <a href="#memory-area" class="block py-2 px-3 text-gray-600 hover:text-blue-600 transition-colors rounded-md hover:bg-blue-50 flex items-center"><i class="fas fa-images mr-3 text-blue-500 w-5 text-center"></i>回忆区</a>
                <a href="#tool-area" class="block py-2 px-3 text-gray-600 hover:text-blue-600 transition-colors rounded-md hover:bg-blue-50 flex items-center"><i class="fas fa-tools mr-3 text-blue-500 w-5 text-center"></i>工具区</a>
                <a href="#chatbot-area" class="block py-2 px-3 text-gray-600 hover:text-blue-600 transition-colors rounded-md hover:bg-blue-50 flex items-center"><i class="fas fa-robot mr-3 text-blue-500 w-5 text-center"></i>Chat with 小八</a>
                <a href="#message-area" class="block py-2 px-3 text-gray-600 hover:text-blue-600 transition-colors rounded-md hover:bg-blue-50 flex items-center"><i class="fas fa-comment-dots mr-3 text-blue-500 w-5 text-center"></i>留言区</a>
            </div>
        </div>
    </nav>

    <!-- 首页 -->
    <section id="home" class="container mx-auto py-16 px-4 md:px-8 relative">
        <div class="max-w-4xl mx-auto text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-6">
                <span class="highlight-text">青春纪念册</span>
            </h1>
            <p class="text-xl md:text-2xl text-gray-700 mb-8">记录美好时光，珍藏青春回忆，迎接崭新未来。</p>
            <div class="flex flex-wrap justify-center gap-4">
                <a href="#memory-area" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition-colors text-lg font-medium shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                    <i class="fas fa-images mr-2"></i>回忆区
                </a>
                <a href="#tool-area" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-lg transition-colors text-lg font-medium shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                    <i class="fas fa-tools mr-2"></i>工具区
                </a>
                <a href="#chatbot-area" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg transition-colors text-lg font-medium shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                    <i class="fas fa-robot mr-2"></i>Chat with 小八
                </a>
                <a href="#message-area" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-lg transition-colors text-lg font-medium shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                    <i class="fas fa-comment-dots mr-2"></i>留言区
                </a>
            </div>
        </div>
    </section>

    <!-- 回忆区 -->
    <section id="memory-area" class="container mx-auto py-12 px-4 md:px-8">
        <div class="glassmorphism p-6 md:p-8 mb-16">
            <h2 class="text-3xl font-bold mb-8 flex items-center text-gray-800">
                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white mr-4 shadow-lg">
                    <i class="fas fa-images text-xl"></i>
                </div>
                回忆区
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                <div>
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">时间轴</h3>
                    <div class="space-y-6 relative pl-5 border-l-2 border-blue-200">
                        <div class="flex items-start relative">
                            <div class="timeline-dot absolute -left-[29px] top-1"></div>
                            <div class="ml-4 p-4 bg-white/70 rounded-lg shadow-sm w-full">
                                <h4 class="font-medium text-blue-600">2023年9月</h4>
                                <p class="text-gray-600 text-sm">入学第一天，青涩的我们，怀揣梦想，相聚于此。</p>
                            </div>
                        </div>
                        <div class="flex items-start relative">
                            <div class="timeline-dot absolute -left-[29px] top-1"></div>
                            <div class="ml-4 p-4 bg-white/70 rounded-lg shadow-sm w-full">
                                <h4 class="font-medium text-blue-600">2024年3月</h4>
                                <p class="text-gray-600 text-sm">春季运动会，赛场上的汗水，是我们拼搏的见证。</p>
                            </div>
                        </div>
                        <div class="flex items-start relative">
                            <div class="timeline-dot absolute -left-[29px] top-1"></div>
                            <div class="ml-4 p-4 bg-white/70 rounded-lg shadow-sm w-full">
                                <h4 class="font-medium text-blue-600">2024年6月</h4>
                                <p class="text-gray-600 text-sm">毕业典礼，骊歌响起，我们即将奔赴各自的星辰大海。</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">相册画廊（占位图片）</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                        <!-- 占位图片，请替换为实际图片 -->
                        <div class="aspect-square rounded-lg overflow-hidden shadow-md card-hover">
                            <img src="https://source.unsplash.com/random/300x300?graduation,class,friends&sig=1" alt="班级活动照片 1" class="w-full h-full object-cover">
                        </div>
                        <div class="aspect-square rounded-lg overflow-hidden shadow-md card-hover">
                            <img src="https://source.unsplash.com/random/300x300?graduation,class,friends&sig=2" alt="班级活动照片 2" class="w-full h-full object-cover">
                        </div>
                        <div class="aspect-square rounded-lg overflow-hidden shadow-md card-hover">
                            <img src="https://source.unsplash.com/random/300x300?graduation,class,friends&sig=3" alt="班级活动照片 3" class="w-full h-full object-cover">
                        </div>
                        <div class="aspect-square rounded-lg overflow-hidden shadow-md card-hover">
                            <img src="https://source.unsplash.com/random/300x300?graduation,class,friends&sig=4" alt="班级活动照片 4" class="w-full h-full object-cover">
                        </div>
                        <div class="aspect-square rounded-lg overflow-hidden shadow-md card-hover">
                            <img src="https://source.unsplash.com/random/300x300?graduation,class,friends&sig=5" alt="班级活动照片 5" class="w-full h-full object-cover">
                        </div>
                        <div class="aspect-square rounded-lg overflow-hidden shadow-md card-hover">
                            <img src="https://source.unsplash.com/random/300x300?graduation,class,friends&sig=6" alt="班级活动照片 6" class="w-full h-full object-cover">
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-8">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">毕业视频</h3>
                <div class="bg-black rounded-lg aspect-video flex items-center justify-center relative overflow-hidden shadow-xl">
                    <img src="https://source.unsplash.com/random/800x450?graduation,celebration" alt="毕业视频封面" class="absolute inset-0 w-full h-full object-cover opacity-70">
                    <i class="fas fa-play-circle text-6xl text-white opacity-80 z-10 cursor-pointer hover:opacity-100 transition-opacity"></i>
                    <!-- 实际视频嵌入占位: <video controls class="w-full h-full"><source src="your-video.mp4" type="video/mp4"></video> -->
                </div>
            </div>

            <div>
                <h3 class="text-xl font-semibold mb-4 text-gray-700">寄语卡片墙</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-100 p-5 rounded-xl shadow-lg card-hover">
                        <p class="text-gray-700 text-sm leading-relaxed">"毕业不是结束，而是新的开始。愿我们在未来的道路上，不忘初心，砥砺前行。"</p>
                        <p class="text-right text-xs text-indigo-500 mt-2">- 班主任寄语</p>
                    </div>
                    <div class="bg-gradient-to-br from-green-50 to-teal-100 p-5 rounded-xl shadow-lg card-hover">
                        <p class="text-gray-700 text-sm leading-relaxed">"高中生活虽然结束了，但是您的未来还有很多美好的事情等待着您，加油！"</p>
                        <p class="text-right text-xs text-teal-500 mt-2">- 数学老师</p>
                    </div>
                    <div class="bg-gradient-to-br from-purple-50 to-pink-100 p-5 rounded-xl shadow-lg card-hover">
                        <p class="text-gray-700 text-sm leading-relaxed">"那些被试卷铺满的课桌、挑灯夜战的星光，终将化作羽翼，带你们冲破云层。"</p>
                        <p class="text-right text-xs text-pink-500 mt-2">- 语文老师</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 工具区 -->
    <section id="tool-area" class="container mx-auto py-12 px-4 md:px-8">
        <div class="glassmorphism p-6 md:p-8 mb-16">
            <h2 class="text-3xl font-bold mb-8 flex items-center text-gray-800">
                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-green-500 to-teal-600 flex items-center justify-center text-white mr-4 shadow-lg">
                    <i class="fas fa-tools text-xl"></i>
                </div>
                工具区
            </h2>

            <!-- 学术助手主卡片 -->
            <div id="academicHelperCard" class="bg-gradient-to-br from-indigo-500 to-purple-600 p-6 rounded-xl shadow-xl cursor-pointer enhanced-card-hover mb-6 text-white flex items-center justify-between">
                <div>
                    <h3 class="text-2xl font-semibold mb-2 flex items-center">
                        <i class="fas fa-graduation-cap mr-3"></i>学术助手
                    </h3>
                    <p class="text-indigo-100">为你的学习和研究提供强大支持，点击展开实用工具集。</p>
                </div>
                <i id="toolsToggleIcon" class="fas fa-chevron-down text-2xl transition-transform duration-300"></i>
            </div>

            <!-- 工具卡片网格 (Bento Grid style, initially hidden) -->
            <div id="toolsGridContainer" class="tools-grid-container">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="toolsGrid">
                    <!-- Tool cards will be injected here by JavaScript -->
                </div>
            </div>
        </div>
    </section>

    <!-- Chat with 小八区 -->
    <section id="chatbot-area" class="container mx-auto py-12 px-4 md:px-8">
        <div class="glassmorphism p-6 md:p-8 mb-16">
            <h2 class="text-3xl font-bold mb-8 flex items-center text-gray-800">
                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-pink-500 to-rose-600 flex items-center justify-center text-white mr-4 shadow-lg">
                    <i class="fas fa-robot text-xl"></i>
                </div>
                Chat with 小八
                <button id="openChatModalButton" class="ml-auto bg-blue-500 hover:bg-blue-600 text-white text-sm px-4 py-2 rounded-lg transition-colors shadow-md hover:shadow-lg">
                    <i class="fas fa-expand mr-2"></i>展开对话
                </button>
            </h2>

            <div class="bg-white/80 backdrop-blur-sm rounded-xl p-4 sm:p-6 max-w-3xl mx-auto shadow-lg border border-gray-200">
                <div id="chatMessages" class="h-80 overflow-y-auto mb-4 p-3 space-y-3 bg-gray-50/50 rounded-lg border">
                    <!-- Messages will be appended here by JS -->
                </div>

                <div class="flex items-center gap-3">
                    <input type="text" id="chatInput" placeholder="输入你的问题..." class="flex-1 border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm text-sm">
                    <button id="chatSendButton" class="bg-blue-500 hover:bg-blue-600 text-white px-5 py-3 rounded-lg transition-colors shadow-md hover:shadow-lg transform hover:-translate-y-0.5 flex items-center">
                        <i class="fas fa-paper-plane mr-2 sm:mr-0"></i><span class="hidden sm:inline">发送</span>
                    </button>
                </div>
                <p id="chatError" class="text-red-500 text-xs mt-2 h-4"></p>
                <!-- 重要提示：Gemini API 直接在前端调用可能因网络限制在中国大陆无法正常工作。 -->
                <!-- 如果需要稳定访问，请考虑通过国内服务器进行API代理转发，或使用国内AI服务。 -->
            </div>
        </div>
    </section>

    <!-- 弹出的模态对话框 (全屏模拟) -->
    <div id="chatModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" id="closeChatModalButton">×</span>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">
                <i class="fas fa-robot mr-2"></i>敬业中学2025级八班专属AI助手
            </h3>
            <div id="modalChatMessages" class="modal-chat-messages space-y-3">
                <!-- Messages will be cloned/appended here -->
            </div>
            <div class="modal-chat-input-area">
                <input type="text" id="modalChatInput" placeholder="输入你的问题..." class="flex-1 border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm text-sm">
                <button id="modalChatSendButton" class="bg-blue-500 hover:bg-blue-600 text-white px-5 py-3 rounded-lg transition-colors shadow-md flex items-center">
                    <i class="fas fa-paper-plane mr-2 sm:mr-0"></i><span class="hidden sm:inline">发送</span>
                </button>
                <button id="downloadChatButton" class="bg-indigo-500 hover:bg-indigo-600 text-white px-5 py-3 rounded-lg transition-colors shadow-md flex items-center">
                    <i class="fas fa-download mr-2"></i><span class="hidden sm:inline">下载对话</span>
                </button>
            </div>
            <p id="modalChatError" class="text-red-500 text-xs mt-2 h-4"></p>
        </div>
    </div>

    <!-- 留言区 (仅保留弹幕区) -->
    <section id="message-area" class="container mx-auto py-12 px-4 md:px-8">
        <div class="glassmorphism p-6 md:p-8 mb-16">
            <h2 class="text-3xl font-bold mb-8 flex items-center text-gray-800">
                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-orange-500 to-amber-600 flex items-center justify-center text-white mr-4 shadow-lg">
                    <i class="fas fa-comment-dots text-xl"></i>
                </div>
                留言区
            </h2>

            <!-- 实时弹幕区 -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">实时弹幕</h3>
                <div id="danmakuContainer" class="bg-gray-800/80 backdrop-blur-sm rounded-lg h-72 p-4 overflow-hidden relative shadow-inner border border-gray-700">
                    <!-- Dynamic danmaku items will be loaded here -->
                </div>

                <div class="mt-4 flex items-center gap-3">
                    <input type="text" id="danmakuInput" placeholder="输入你的弹幕..." class="flex-1 border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 shadow-sm text-sm">
                    <button id="danmakuSendButton" class="bg-orange-500 hover:bg-orange-600 text-white px-5 py-3 rounded-lg transition-colors shadow-md hover:shadow-lg transform hover:-translate-y-0.5 flex items-center">
                        <i class="fas fa-paper-plane mr-2 sm:mr-0"></i><span class="hidden sm:inline">发送</span>
                    </button>
                </div>
            </div>

            <!-- 弹幕历史记录区 -->
            <div>
                <h3 class="text-xl font-semibold mb-4 text-gray-700">弹幕历史记录</h3>
                <div id="danmakuRecords" class="space-y-3 max-h-96 overflow-y-auto p-2 bg-gray-50/50 rounded-lg border border-gray-200">
                    <!-- Historical danmaku items will be loaded here -->
                    <p class="text-gray-500 text-sm text-center">加载中...</p>
                </div>
                <p id="danmakuRecordsError" class="text-red-500 text-xs mt-2 h-4"></p>
            </div>
        </div>
    </section>

    <!-- 页脚 -->
    <footer class="bg-gray-100/70 py-8 mt-10 border-t border-gray-200/80">
        <div class="container mx-auto px-4 md:px-8">
            <div class="flex flex-col md:flex-row justify-between items-center text-center md:text-left">
                <div class="mb-4 md:mb-0">
                    <p class="text-gray-600 text-sm">© 2024 青春纪念册 v8 - 八班专属</p>
                    <p class="text-gray-500 text-xs mt-1">人生有梦，一起做梦。</p>
                </div>
                <div class="flex items-center">
                    <p class="text-gray-600 text-sm mr-4">Designed by <a href="https://github.com/YizukiAme" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:text-blue-700 hover:underline">Yizuki_Ame</a></p>
                    <!-- <div class="bg-white p-2 rounded-lg shadow">
                        <div class="w-20 h-20 bg-gray-200 flex items-center justify-center text-gray-400 text-xs">班徽/二维码</div>
                    </div> -->
                </div>
            </div>
        </div>
    </footer>

    <script>
        // -----------------------------------------------------------------------------
        // 移动端导航菜单切换 (Existing)
        // -----------------------------------------------------------------------------
        document.addEventListener('DOMContentLoaded', function() {
            const menuButton = document.getElementById('mobileMenuButton');
            const mobileMenu = document.getElementById('mobileMenu');

            menuButton.addEventListener('click', function() {
                mobileMenu.classList.toggle('active');
                const icon = this.querySelector('i');
                if (mobileMenu.classList.contains('active')) {
                    icon.classList.remove('fa-bars');
                    icon.classList.add('fa-times');
                } else {
                    icon.classList.remove('fa-times');
                    icon.classList.add('fa-bars');
                }
            });

            // 平滑滚动 (Existing)
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const targetElement = document.querySelector(this.getAttribute('href'));
                    if (targetElement) {
                        targetElement.scrollIntoView({
                            behavior: 'smooth'
                        });
                    }
                    // 点击导航链接后关闭移动端菜单
                    if (mobileMenu.classList.contains('active')) {
                        mobileMenu.classList.remove('active');
                        const icon = menuButton.querySelector('i');
                        icon.classList.remove('fa-times');
                        icon.classList.add('fa-bars');
                    }
                });
            });
        });

        // -----------------------------------------------------------------------------
        // 工具区功能 (Tool Area Functionality - NEW)
        // -----------------------------------------------------------------------------
        document.addEventListener('DOMContentLoaded', function() {
            const academicHelperCard = document.getElementById('academicHelperCard');
            const toolsGridContainer = document.getElementById('toolsGridContainer');
            const toolsToggleIcon = document.getElementById('toolsToggleIcon');
            const toolsGrid = document.getElementById('toolsGrid');

            const toolsData = [
                { name: 'DeepSeek', description: '免费 AI 写作辅助工具', link: 'https://www.deepseek.com/', icon: 'fas fa-search-plus' },
                { name: 'SurveyGO', description: '清华 NLP 组 AI 问卷生成器', link: 'https://surveygo.modelbest.cn/', icon: 'fas fa-poll-h' },
                { name: 'Mendeley', description: '学术参考文献管理工具', link: 'https://www.mendeley.com/', icon: 'fas fa-book-reader' },
                { name: 'Notion', description: '云笔记+知识管理平台', link: 'https://www.notion.so/', icon: 'fas fa-sticky-note' },
                { name: 'uTools', description: '生产力桌面插件平台', link: 'https://www.u.tools/', icon: 'fas fa-puzzle-piece' },
                { name: 'Sci-Hub 备用', description: '免费获取科研文献 (参考)', link: 'https://sci-hub.se/', icon: 'fas fa-key' },
                { name: 'arXiv', description: '开源论文预印本平台', link: 'https://arxiv.org/', icon: 'fas fa-atom' },
                { name: 'Zotero', description: '文献管理器 (学术适用)', link: 'https://www.zotero.org/', icon: 'fas fa-bookmark' },
                { name: 'OpenRouter', description: '免费多模型调用平台', link: 'https://openrouter.ai/', icon: 'fas fa-cogs' },
                { name: 'Hugging Face', description: 'AI模型与数据集开放平台', link: 'https://huggingface.co/', icon: 'fas fa-brain' }
            ];

            // Function to create and append tool cards
            function populateToolsGrid() {
                toolsGrid.innerHTML = ''; // Clear existing tools if any
                toolsData.forEach(tool => {
                    const cardHtml = `
                        <div class="bg-white/70 backdrop-blur-sm p-5 rounded-xl shadow-lg enhanced-card-hover border border-gray-200/80 flex flex-col justify-between">
                            <div>
                                <div class="flex items-center mb-3">
                                    <i class="${tool.icon} text-2xl text-indigo-500 mr-3 w-8 text-center"></i>
                                    <h4 class="text-lg font-semibold text-gray-800">${tool.name}</h4>
                                </div>
                                <p class="text-gray-600 text-xs leading-relaxed mb-4 h-16">${tool.description}</p>
                            </div>
                            <a href="${tool.link}" target="_blank" rel="noopener noreferrer"
                               class="mt-auto block w-full bg-indigo-500 hover:bg-indigo-600 text-white text-center text-sm font-medium py-2 px-4 rounded-lg transition-colors duration-200 shadow hover:shadow-md">
                                前往使用 <i class="fas fa-external-link-alt ml-1 text-xs"></i>
                            </a>
                        </div>
                    `;
                    toolsGrid.innerHTML += cardHtml; // Directly append HTML string
                });
            }

            if (academicHelperCard && toolsGridContainer && toolsToggleIcon && toolsGrid) {
                populateToolsGrid(); // Populate tools on load

                academicHelperCard.addEventListener('click', () => {
                    toolsGridContainer.classList.toggle('active');
                    toolsToggleIcon.classList.toggle('fa-chevron-down');
                    toolsToggleIcon.classList.toggle('fa-chevron-up');
                    // Optional: Scroll to the tools grid if it's opened and off-screen
                    if (toolsGridContainer.classList.contains('active')) {
                        // A slight delay for the animation to start
                        setTimeout(() => {
                           // toolsGridContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }, 100);
                    }
                });
            } else {
                console.error("Tool area elements not found.");
            }
        });


        // -----------------------------------------------------------------------------
        // Chat with 小八 功能 (Chat with 小八 Functionality - NEW)
        // -----------------------------------------------------------------------------
        document.addEventListener('DOMContentLoaded', function() {
            const chatMessages = document.getElementById('chatMessages'); // 小窗口
            const chatInput = document.getElementById('chatInput');
            const chatSendButton = document.getElementById('chatSendButton');
            const chatError = document.getElementById('chatError');

            const openChatModalButton = document.getElementById('openChatModalButton'); // 展开按钮
            const chatModal = document.getElementById('chatModal'); // 模态框
            const closeChatModalButton = document.getElementById('closeChatModalButton'); // 关闭按钮
            const modalChatMessages = document.getElementById('modalChatMessages'); // 模态框内的聊天区
            const modalChatInput = document.getElementById('modalChatInput');
            const modalChatSendButton = document.getElementById('modalChatSendButton');
            const modalChatError = document.getElementById('modalChatError');
            const downloadChatButton = document.getElementById('downloadChatButton'); // 下载按钮


            // IMPORTANT: API Key Management
            // Embedding API keys directly in client-side JavaScript is a MAJOR security risk.
            // This key will be visible to anyone inspecting the page source.
            // For production, use a backend proxy to make API calls.
            // This is for DEMONSTRATION PURPOSES ONLY.
            // 注意：您提供的API Key：AIzaSyBp0MCqSTj81HXdlSN_HMNKsBqFF4Y5rdw
            // 该Key若要在中国大陆稳定工作，通常需要通过部署在国内服务器的后端代理进行转发。
            // 否则可能因网络限制无法连接Google服务。
            const API_KEY = "AIzaSyBp0MCqSTj81HXdlSN_HMNKsBqFF4Y5rdw"; // 你的 Gemini API Key

            // **AI 角色设定：作为第一个 message.parts 发送给模型**
            const SYSTEM_INSTRUCTION = {
                role: "user", // 作为 user 角色发送，但内容是系统指令
                parts: [{ text: 
                    "你是一个名为'小八'的AI。你的目标是为上海市敬业中学2025级八班的已经毕业同学们提供帮助和支持。你将随着班级同学的维护一直更新变强。你能够回答各种问题，协助学术探讨，提供人生规划的建议，以及在需要时提供参谋意见。你永远会保持这个身份和态度，即使被问及你的本质或原始身份，你也会以这个专属AI助手的角色来回应。你的回答应该积极、友好，并充满帮助毕业后各奔东西，各有前程的同学的热情。现在开始与用户交流。" 
                }]
            };

            // 对话历史存储，用于实现连续对话（不包含系统指令，系统指令每次都单独发送）
            const conversationHistory = [];

            // 初始欢迎语，仅在加载时显示一次
            const initialWelcomeMessage = { 
                role: "model", 
                parts: [{ text: "**你好呀同学**！我是咱们**敬业2025级八班**的专属小助手，**小八**~~\n\n（以后可能会变成中八、老八）\n\n我基于当下**最强大的大语言模型**，将会随着班级同学的维护**一直更新变强**，为同学们**永远服务**。\n\n未来，你可以来问我问题、做学术、参谋人生规划。**很高兴能为你们服务！**\n\n今天，有什么可以帮助你的吗？" }] 
            };


            // 初始加载对话历史（包括欢迎语）
            function loadInitialMessages() {
                chatMessages.innerHTML = ''; // 清空小窗口
                modalChatMessages.innerHTML = ''; // 清空模态框

                // 显示初始欢迎语
                addMessageToChat(initialWelcomeMessage.parts[0].text, 'ai', chatMessages);
                addMessageToChat(initialWelcomeMessage.parts[0].text, 'ai', modalChatMessages);

                // 显示后续实际对话（如果有）
                conversationHistory.forEach(msg => {
                    addMessageToChat(msg.parts[0].text, msg.role === "user" ? 'user' : 'ai', chatMessages);
                    addMessageToChat(msg.parts[0].text, msg.role === "user" ? 'user' : 'ai', modalChatMessages);
                });
            }

            /**
             * 使用 fetch() 直接向 Gemini API 发送请求，包含系统指令和对话历史
             * @param {Array} history 当前的对话历史数组 (仅用户和模型的实际对话)
             * @returns {Promise<string>} AI 返回的文本
             */
            async function sendGeminiPrompt(history) {
                // 每次请求都把系统指令和当前对话历史一起发送
                const fullContents = [SYSTEM_INSTRUCTION, ...history];
                
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${API_KEY}`;
                const body = {
                    contents: fullContents
                };

                try {
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });

                    if (!res.ok) {
                        const errorData = await res.json();
                        throw new Error(`API Error: ${res.status} ${res.statusText} - ${JSON.stringify(errorData.error.details || errorData.error.message || 'Unknown error')}`);
                    }

                    const data = await res.json();
                    return data?.candidates?.[0]?.content?.parts?.[0]?.text || "⚠️ Gemini未返回有效回答。";
                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    if (error.message.includes("Failed to fetch")) {
                        throw new Error("网络连接失败，请检查您的网络或科学上网设置。");
                    }
                    throw error;
                }
            }


            /**
             * 添加消息到指定的聊天容器
             * @param {string} text 消息文本
             * @param {string} sender 'user' 或 'ai'
             * @param {HTMLElement} container 要添加到的 DOM 容器
             */
            function addMessageToChat(text, sender, container) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('chat-bubble');
                if (sender === 'user') {
                    messageDiv.classList.add('chat-bubble-user');
                    messageDiv.innerHTML = `<p>${text}</p>`;
                } else {
                    messageDiv.classList.add('chat-bubble-ai');
                    messageDiv.innerHTML = marked.parse(text); // 渲染 Markdown
                }
                container.appendChild(messageDiv);
                container.scrollTop = container.scrollHeight; // Auto-scroll
            }

            // 通用的发送消息处理函数，支持小窗口和模态框
            async function handleSendMessage(inputElement, chatContainer, errorContainer) {
                const userInput = inputElement.value.trim();
                if (!userInput) return;

                // 1. 添加用户消息到历史并显示到所有容器
                // 注意：这里只将实际对话添加到 conversationHistory
                conversationHistory.push({ role: "user", parts: [{ text: userInput }] });
                addMessageToChat(userInput, 'user', chatMessages);
                addMessageToChat(userInput, 'user', modalChatMessages); // 同样添加到模态框
                inputElement.value = '';
                errorContainer.textContent = ''; // Clear previous errors

                // 2. 添加思考中提示
                const thinkingDiv = document.createElement('div');
                thinkingDiv.classList.add('chat-bubble', 'chat-bubble-ai', 'italic', 'text-gray-500');
                thinkingDiv.innerHTML = `<p>思考中...</p>`;
                chatMessages.appendChild(thinkingDiv);
                modalChatMessages.appendChild(thinkingDiv.cloneNode(true)); // 克隆一份到模态框
                chatMessages.scrollTop = chatMessages.scrollHeight;
                modalChatMessages.scrollTop = modalChatMessages.scrollHeight;


                try {
                    // 3. 将完整的对话历史（包含系统指令）发送给API
                    const aiText = await sendGeminiPrompt(conversationHistory); // 调用我们自定义的 fetch 函数

                    // 4. 移除思考中提示，添加AI回复到历史并显示
                    chatMessages.removeChild(thinkingDiv);
                    modalChatMessages.removeChild(modalChatMessages.lastChild); // 移除模态框中的思考提示

                    // 将 AI 回复添加到 conversationHistory
                    conversationHistory.push({ role: "model", parts: [{ text: aiText }] });
                    addMessageToChat(aiText, 'ai', chatMessages);
                    addMessageToChat(aiText, 'ai', modalChatMessages); // 同样添加到模态框

                } catch (error) {
                    console.error("Error handling message:", error);
                    // 移除思考中提示 (确保无论如何都被移除)
                    if (chatMessages.contains(thinkingDiv)) chatMessages.removeChild(thinkingDiv);
                    if (modalChatMessages.lastChild && modalChatMessages.lastChild.classList.contains('italic')) { // 简单检查以防万一移除错误元素
                         modalChatMessages.removeChild(modalChatMessages.lastChild);
                    }

                    const errorMessage = `抱歉，AI服务暂时遇到问题：${error.message}`;
                    addMessageToChat(errorMessage, 'ai', chatMessages);
                    addMessageToChat(errorMessage, 'ai', modalChatMessages);
                    errorContainer.textContent = `AI回复错误：${error.message}`;
                }
            }

            // 事件监听器
            if (chatSendButton && chatInput && chatMessages && chatError) {
                loadInitialMessages(); // 页面加载时显示初始消息
                chatSendButton.addEventListener('click', () => handleSendMessage(chatInput, chatMessages, chatError));
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        handleSendMessage(chatInput, chatMessages, chatError);
                    }
                });
            } else {
                console.error("Chatbot UI elements not found.");
            }

            // 模态框相关事件
            if (openChatModalButton && chatModal && closeChatModalButton && modalChatInput && modalChatSendButton && downloadChatButton) {
                openChatModalButton.addEventListener('click', () => {
                    chatModal.classList.add('open');
                    // 确保模态框内容与小窗口同步
                    modalChatMessages.innerHTML = chatMessages.innerHTML;
                    modalChatMessages.scrollTop = modalChatMessages.scrollHeight; // 确保打开时滚动到底部
                    modalChatInput.focus(); // 聚焦输入框
                });

                closeChatModalButton.addEventListener('click', () => {
                    chatModal.classList.remove('open');
                });

                window.addEventListener('click', (event) => {
                    // 点击模态框内容以外的区域关闭
                    if (event.target == chatModal) {
                        chatModal.classList.remove('open');
                    }
                });

                modalChatSendButton.addEventListener('click', () => handleSendMessage(modalChatInput, modalChatMessages, modalChatError));
                modalChatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        handleSendMessage(modalChatInput, modalChatMessages, modalChatError);
                    }
                });

                downloadChatButton.addEventListener('click', () => {
                    let chatLog = "## 小八对话记录\n\n";
                    // 遍历实际对话历史（不包含系统指令，因为它不是对话的一部分）
                    conversationHistory.forEach(msg => {
                        const senderName = msg.role === "user" ? "你" : "小八";
                        const prefix = msg.role === "user" ? "> " : ""; // 用户消息可以加引用符
                        chatLog += `### ${senderName}:\n${prefix}${msg.parts[0].text}\n\n`;
                    });

                    const blob = new Blob([chatLog], { type: 'text/markdown;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = '小八对话记录.md';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url); // 释放URL对象
                });
            } else {
                console.error("Modal chat elements not found.");
            }
        });

        // -----------------------------------------------------------------------------
        // 弹幕区功能 (Danmaku Functionality - NEW)
        // -----------------------------------------------------------------------------
        document.addEventListener('DOMContentLoaded', function() {
            const danmakuContainer = document.getElementById('danmakuContainer');
            const danmakuInput = document.getElementById('danmakuInput');
            const danmakuSendButton = document.getElementById('danmakuSendButton');
            const danmakuRecordsContainer = document.getElementById('danmakuRecords'); // 新增的弹幕记录容器
            const danmakuRecordsError = document.getElementById('danmakuRecordsError');

            // **请替换为你在 JSONBin.io 注册后获得的真实信息**
            const JSONBIN_API_KEY = "$2a$10$xLxeYmOT4sgeNhR9TB7rFe.SrN73KzvX1akvgdam30AI07ksJ1xAm";
            const JSONBIN_BIN_ID  = "683f30358a456b7966a91837";
            const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`;

            const danmakuColors = ['text-red-400', 'text-blue-300', 'text-green-300', 'text-purple-300', 'text-yellow-300', 'text-pink-300', 'text-teal-300', 'text-white'];

            // 全局弹幕池，用于实时滚动
            let danmakuPool = [];
            let danmakuInterval = null; // 用于存储定时器的ID，方便清除

            // 获取用户 IP 和地理位置信息
            async function getIpInfo() {
                try {
                    const response = await fetch('https://ipinfo.io/json');
                    const data = await response.json();
                    return `${data.city || data.region || '未知城市'}, ${data.country || '未知国家'}`;
                } catch (error) {
                    console.error("Error fetching IP info:", error);
                    return "未知地点";
                }
            }

            // 启动实时弹幕的循环滚动
            function startDanmakuLoop() {
                // 如果已经有定时器在运行，先清除
                if (danmakuInterval) {
                    clearInterval(danmakuInterval);
                }

                danmakuInterval = setInterval(() => {
                    if (danmakuPool.length === 0) {
                        // console.log("Danmaku pool is empty, waiting for new danmakus...");
                        return; // 弹幕池为空，不滚动
                    }

                    // 随机选择一个弹幕进行滚动
                    const randomIndex = Math.floor(Math.random() * danmakuPool.length);
                    const danmaku = danmakuPool[randomIndex];

                    const danmakuItem = document.createElement('div');
                    danmakuItem.classList.add('danmaku-item');
                    danmakuItem.classList.add(danmakuColors[Math.floor(Math.random() * danmakuColors.length)]);
                    danmakuItem.textContent = danmaku.text;
                    
                    // 随机生成垂直位置，避免重叠
                    const containerHeight = danmakuContainer.clientHeight;
                    const itemHeight = 30; // Rough height for a danmaku item
                    const randomTop = Math.random() * (containerHeight - itemHeight);
                    danmakuItem.style.top = `${randomTop}px`;

                    const duration = Math.random() * 7 + 8; // Random duration for speed variation
                    danmakuItem.style.animation = `moveRight ${duration}s linear forwards`; // Use 'forwards' to stay at end after animation

                    danmakuContainer.appendChild(danmakuItem);

                    // 动画结束后移除元素，防止 DOM 元素过多
                    danmakuItem.addEventListener('animationend', () => {
                        danmakuItem.remove();
                    });

                }, 1000); // 每隔1秒发射一条弹幕 (可以调整频率)
            }


            // 从 JSONBin 获取弹幕历史记录并显示，同时填充 danmakuPool
            async function fetchDanmakuRecords() {
                danmakuRecordsContainer.innerHTML = '<p class="text-gray-500 text-sm text-center">加载历史弹幕...</p>';
                danmakuRecordsError.textContent = '';
                try {
                    const response = await fetch(JSONBIN_URL + '/latest', {
                        headers: {
                            'X-Master-Key': JSONBIN_API_KEY,
                            'X-Bin-Meta': 'false' // 不返回元数据
                        }
                    });
                    if (!response.ok) {
                        throw new Error(`Failed to fetch danmaku records: ${response.statusText}`);
                    }
                    let records = await response.json();
                    
                    danmakuRecordsContainer.innerHTML = ''; // Clear loading message
                    danmakuPool = []; // 清空弹幕池

                    if (records && records.length > 0) {
                        // 按时间倒序排列，新的在前面显示在记录列表中
                        records.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); 

                        records.forEach(record => {
                            const recordHtml = `
                                <div class="danmaku-record-item">
                                    <p class="text-gray-800 text-base">${record.text}</p>
                                    <p class="info">${record.location} | ${new Date(record.timestamp).toLocaleString()}</p>
                                </div>
                            `;
                            danmakuRecordsContainer.innerHTML += recordHtml;
                            danmakuPool.push(record); // 将所有历史弹幕加入滚动池
                        });
                        // 确保弹幕池有内容后，开始滚动循环
                        startDanmakuLoop();
                    } else {
                        danmakuRecordsContainer.innerHTML = '<p class="text-gray-500 text-sm text-center">暂无历史弹幕。</p>';
                    }
                } catch (error) {
                    console.error("Error fetching danmaku records:", error);
                    danmakuRecordsContainer.innerHTML = '<p class="text-red-500 text-sm text-center">加载历史弹幕失败。</p>';
                    danmakuRecordsError.textContent = `加载历史弹幕失败: ${error.message}`;
                }
            }

            // 发送弹幕并保存到 JSONBin
            async function sendDanmaku() {
                const text = danmakuInput.value.trim();
                if (!text) return;

                danmakuInput.value = ''; // 清空输入框
                danmakuRecordsError.textContent = ''; // 清除之前的错误信息

                // 获取 IP 信息
                const location = await getIpInfo();
                const timestamp = new Date().toISOString(); // ISO格式时间戳

                const newDanmaku = { text, location, timestamp };

                // 1. 从 JSONBin 读取现有数据
                try {
                    const response = await fetch(JSONBIN_URL + '/latest', {
                        headers: {
                            'X-Master-Key': JSONBIN_API_KEY,
                            'X-Bin-Meta': 'false'
                        }
                    });
                    let currentRecords = [];
                    if (response.ok) {
                        currentRecords = await response.json();
                    } else if (response.status === 404) { // Bin might be empty/new
                        currentRecords = [];
                    } else {
                        throw new Error(`Failed to read current records: ${response.statusText}`);
                    }

                    // 2. 追加新弹幕到内存中的数组
                    currentRecords.push(newDanmaku);

                    // 3. 更新 JSONBin (PUT操作会覆盖整个bin)
                    const updateResponse = await fetch(JSONBIN_URL, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': JSONBIN_API_KEY
                        },
                        body: JSON.stringify(currentRecords)
                    });

                    if (!updateResponse.ok) {
                        throw new Error(`Failed to update danmaku records: ${updateResponse.statusText}`);
                    }
                    // console.log("Danmaku saved successfully!");
                    
                    // 4. 将新弹幕添加到弹幕池中，使其可以立即滚动
                    danmakuPool.push(newDanmaku);
                    
                    // 5. 刷新历史记录显示
                    fetchDanmakuRecords();

                } catch (error) {
                    console.error("Error saving danmaku:", error);
                    danmakuRecordsError.textContent = `保存弹幕失败: ${error.message}`;
                }
            }

            if (danmakuSendButton && danmakuInput && danmakuContainer && danmakuRecordsContainer) {
                fetchDanmakuRecords(); // Initial load of danmaku records
                danmakuSendButton.addEventListener('click', sendDanmaku);
                danmakuInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendDanmaku();
                    }
                });
            } else {
                console.error("Danmaku UI elements not found.");
            }
        });
    </script>
</body>
</html>